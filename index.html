<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: blob: https://mintlify.s3.us-west-1.amazonaws.com https://assets.coingecko.com https://cdn.jsdelivr.net https://raw.githubusercontent.com https://images.ctfassets.net https://avatars.githubusercontent.com https://backpack.app https://www.madlads.com https://pbs.twimg.com https://static.okx.com https://img.bitgetimg.com https://tp-statics.tokenpocket.pro; media-src 'self' blob: data:; connect-src 'self' blob: http://localhost:3000 https://api.devnet.solana.com https://api.elevenlabs.io https://vrm-eliza-ai-girlfriend.vercel.app;">
    <title data-i18n-title="char.select.title">WAIFU - Choose Your Girlfriend</title>
    <link rel="stylesheet" href="wallet-ui.css">
    <link rel="stylesheet" href="responsive-standard.css">
    <link rel="stylesheet" href="index-responsive.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
            background: url('BG/selection-bg.jpg') center/cover no-repeat;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Top title */
        .heroes-title {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* Language switcher */
        .language-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 50%, #ffc056 100%);
            border-radius: 10px;
            border: 4px solid rgba(74, 44, 90, 0.8);
            padding: 6px 12px;
            z-index: 101;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #2d1b3d;
            font-weight: bold;
            font-size: 11px;
        }

        .language-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(74, 44, 90, 0.8);
            border-radius: 5px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 9px;
            font-weight: bold;
            color: #2d1b3d;
            transition: all 0.2s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .language-btn.active {
            background: rgba(74, 44, 90, 0.8);
            color: white;
        }

        /* Character info panel - Japanese style profile card design */
        .character-info {
            position: absolute;
            top: 50px;
            left: 12px;
            width: 170px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 7px;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transform: scale(1.3);
            transform-origin: top left;
        }

        .character-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-section {
            margin-bottom: 2px;
        }

        .profile-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 4px 8px;
            font-size: 7px;
            font-weight: 600;
            position: relative;
            border-left: 2px solid #e91e63;
        }

        .profile-content {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            font-size: 7px;
            color: #666;
            font-weight: 500;
        }

        .profile-value {
            font-size: 7px;
            color: #333;
            font-weight: 600;
        }

        .profile-text {
            font-size: 7px;
            color: #333;
            line-height: 1.4;
            padding: 2px 0;
        }

        .favorite-section {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
            text-align: center;
            font-size: 7px;
        }

        .expand-button {
            position: absolute;
            top: 4px;
            right: 6px;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        /* refresh-button decoration removed */

        /* Floating voice selector styles - based on reference screenshot */
        .voice-selector-floating {
            position: absolute;
            top: 12%; /* Move up a bit more to avoid covering faces */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        .language-flags {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flag-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.7;
            position: relative;
        }

        .flag-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .flag-btn.active {
            opacity: 1;
            background: rgba(100, 150, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
            transform: scale(1.1);
        }

        .flag-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4285f4;
            border-radius: 50%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Mobile optimizations moved to index-responsive.css */

        /* Central character name display */
        .character-display-name {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 1.5px 1.5px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0.9;
        }

        /* VRM display area - central */
        .vrm-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Simplified loading animation styles */
        .character-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeInLoader 0.3s ease-out;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 16px;
            box-shadow: 40px 0px 0 0 rgba(255, 255, 255, 0.2), 
                       32.4px 23.5px 0 0 rgba(255, 255, 255, 0.4), 
                       12.4px 38px 0 0 rgba(255, 255, 255, 0.6), 
                       -12.4px 38px 0 0 rgba(255, 255, 255, 0.8), 
                       -32.4px 23.5px 0 0 #ffffff;
            animation: spinner-rotate 1s infinite linear;
            margin-bottom: 20px;
        }

        .loader-text {
            font-size: 16px;
            color: white;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInLoader {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }



        /* Character selector - bottom - mimicking screenshot style */
        .character-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 12px 31px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 100;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.1);
        }

        /* Navigation buttons - left/right arrows */
        .nav-button {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .character-thumbnails {
            display: flex;
            gap: 9px;
            align-items: center;
        }

        .character-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: white;
        }

        /* Currently selected character */
        .character-thumb.active {
            border-color: #FFD700;
            transform: scale(1.15);
            box-shadow: 0 0 7px rgba(255, 215, 0, 0.6);
        }

        /* Center selection indicator - mimicking screenshot design */
        .selected-indicator {
            width: 75px;
            height: 105px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 0 9px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        
        .selected-indicator .selected-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1.5px solid white;
        }
        
        .selected-indicator .selected-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .selected-indicator .selected-badge {
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .selected-indicator .selected-text {
            color: #666;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .character-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-thumb:hover {
            transform: scale(1.05);
            border-color: white;
        }

        .character-thumb.selected {
            width: 40px;
            height: 40px;
            border-color: #333;
            border-width: 2px;
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .character-thumb.selected::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            z-index: -1;
        }

        .character-thumb.selected::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
        }

        .select-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: white;
            font-weight: 500;
        }


        /* Top right wallet connection area */
        .wallet-connect-area {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* Modern connect button - based on UI reference */
        .wallet-connect-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
            min-width: 120px;
            justify-content: center;
        }

        .wallet-connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        }

        .wallet-connect-button:active {
            transform: translateY(-1px);
        }

        .wallet-connect-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-loading {
            animation: spin 1s linear infinite;
        }

        /* Connected status display */
        .wallet-info {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .wallet-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .wallet-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-address {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .wallet-balance {
            color: #888888;
            font-size: 12px;
        }

        .wallet-actions {
            position: relative;
        }

        .wallet-menu-btn {
            background: none;
            border: none;
            color: #888888;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-menu-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow: hidden;
            display: none;
        }

        .wallet-dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-dropdown-item:hover {
            background: #2a2a2a;
        }

        .wallet-dropdown-item:last-child {
            border-top: 1px solid #333333;
            color: #ef4444;
        }

        .wallet-dropdown-item:last-child:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Wallet connection modal - based on UI reference design */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .wallet-modal-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wallet-modal-content {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .wallet-modal-header {
            margin-bottom: 32px;
            text-align: left;
        }

        .wallet-modal-header h2 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .wallet-modal-header p {
            color: #888888;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
        }

        .wallet-close-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: #888888;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-close-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* Wallet options list */
        .wallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #2a2a2a;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: #ffffff;
        }

        .wallet-option:hover {
            background: #333333;
            border-color: #444444;
            transform: translateY(-1px);
        }

        .wallet-option:active {
            transform: translateY(0);
        }

        /* Phantom wallet special highlight effect */
        .wallet-option[data-provider="phantom"]:hover {
            background: linear-gradient(135deg, rgba(171, 159, 242, 0.1), rgba(171, 159, 242, 0.05));
            border-color: rgba(171, 159, 242, 0.3);
            box-shadow: 0 4px 20px rgba(171, 159, 242, 0.1);
        }

        .wallet-option-icon {
            font-size: 24px;
            margin-right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .wallet-option-name {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .wallet-option-arrow {
            color: #666666;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .wallet-option:hover .wallet-option-arrow {
            color: #ffffff;
            transform: translateX(4px);
        }

        /* Footer */
        .wallet-modal-footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .wallet-modal-footer p {
            color: #666666;
            font-size: 14px;
            line-height: 1.5;
        }

        .wallet-link {
            color: #4f46e5;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .wallet-link:hover {
            color: #6366f1;
        }

        /* Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Message notification */
        .wallet-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffffff;
            font-size: 14px;
            z-index: 10001;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .wallet-toast-success {
            border-left: 4px solid #10b981;
        }

        .wallet-toast-error {
            border-left: 4px solid #ef4444;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* Start button - modern gradient design */
        .start-button {
            --h-button: 100px;
            --w-button: 280px;
            --round: 50px;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.25s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 30px rgba(135, 206, 250, 0.4);
            background: linear-gradient(135deg, #E6B3FF 0%, #B3D9FF 100%);
            border-radius: var(--round);
            border: 2px solid rgba(255, 255, 255, 0.6);
            outline: none;
            padding: 15px 30px;
            z-index: 100;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .start-button::before {
            content: "‚ú®";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            animation: twinkle 1.5s infinite alternate;
        }
        
        .start-button::after {
            content: "‚ú®";
            position: absolute;
            right: -15px;
            bottom: -5px;
            font-size: 14px;
            animation: twinkle 1.8s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .start-button:active {
            transform: scale(0.95);
        }
        
        .start-button:hover {
            box-shadow: 0 12px 40px rgba(135, 206, 250, 0.6);
            transform: translateY(-2px);
        }

        .points_wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }

        .points_wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 9999px;
        }

        @keyframes floating-points {
            0% {
                transform: translateY(0);
            }
            85% {
                opacity: 0;
            }
            100% {
                transform: translateY(-55px);
                opacity: 0;
            }
        }

        .points_wrapper .point:nth-child(1) {
            left: 10%;
            opacity: 1;
            animation-duration: 2.35s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(2) {
            left: 30%;
            opacity: 0.7;
            animation-duration: 2.5s;
            animation-delay: 0.5s;
        }
        .points_wrapper .point:nth-child(3) {
            left: 25%;
            opacity: 0.8;
            animation-duration: 2.2s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(4) {
            left: 44%;
            opacity: 0.6;
            animation-duration: 2.05s;
        }
        .points_wrapper .point:nth-child(5) {
            left: 50%;
            opacity: 1;
            animation-duration: 1.9s;
        }
        .points_wrapper .point:nth-child(6) {
            left: 75%;
            opacity: 0.5;
            animation-duration: 1.5s;
            animation-delay: 1.5s;
        }
        .points_wrapper .point:nth-child(7) {
            left: 88%;
            opacity: 0.9;
            animation-duration: 2.2s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(8) {
            left: 58%;
            opacity: 0.8;
            animation-duration: 2.25s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(9) {
            left: 98%;
            opacity: 0.6;
            animation-duration: 2.6s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(10) {
            left: 65%;
            opacity: 1;
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .inner {
            z-index: 2;
            gap: 3px;
            position: relative;
            width: 100%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 0 40px rgba(223, 113, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .inner svg.icon {
            width: 9px;
            height: 9px;
            transition: fill 0.1s linear;
        }

        .start-button:focus svg.icon {
            fill: white;
        }
        .start-button:hover svg.icon {
            fill: transparent;
            animation:
                dasharray 1s linear forwards,
                filled 0.1s linear forwards 0.95s;
        }
        @keyframes dasharray {
            from {
                stroke-dasharray: 0 0 0 0;
            }
            to {
                stroke-dasharray: 68 68 0 0;
            }
        }
        @keyframes filled {
            to {
                fill: white;
            }
        }


        /* Responsive design moved to index-responsive.css */

        /* User profile panel styles - precise replica design */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.16);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .profile-panel {
            background: white;
            border-radius: 25px;
            padding: 8px; /* Add white border effect */
            max-width: 541px; /* 416px * 1.3 = 541px - increased by 30% */
            width: 85%;
            max-height: 85vh; /* Add maximum height */
            position: relative;
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
            border: 3px solid #F0F0F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .profile-panel-header {
            background: linear-gradient(180deg, #B3E5FC 0%, #81D4FA 50%, #4FC3F7 100%);
            text-align: center;
            padding: 25px 0; /* Larger padding */
            margin: 0;
            position: relative;
            flex-shrink: 0; /* Prevent header from being compressed */
            border-radius: 20px 20px 0 0; /* Only top rounded corners */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 
                        0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-panel-title {
            font-size: 24px; /* Larger font size */
            margin: 0;
            font-weight: 600; /* Bolder font weight */
            color: #2E3A47; /* Darker color */
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            letter-spacing: 1px; /* Increase letter spacing */
        }

        .profile-form {
            padding: 30px; /* Adjust padding */
            display: flex;
            flex-direction: column;
            gap: 30px; 
            overflow-y: auto; /* Enable vertical scrolling */
            flex: 1; /* Take up remaining space */
            max-height: calc(85vh - 90px); /* Subtract header and border height */
            background: white;
            border-radius: 0 0 17px 17px; /* Bottom rounded corners, matching outer border */
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 16px; /* 12px * 1.3 ‚âà 16px */
            position: relative;
        }

        /* Gold decorative lines */
        .field-label {
            font-size: 18px; /* 14px * 1.3 ‚âà 18px */
            font-weight: 500;
            color: #D4AF37;
            text-align: center;
            margin: 0;
            position: relative;
            padding: 0 26px; /* 20px * 1.3 ‚âà 26px */
        }

        .field-label::before,
        .field-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 52px; /* 40px * 1.3 ‚âà 52px */
            height: 1px;
            background: #D4AF37;
        }

        .field-label::before {
            left: 0;
        }

        .field-label::after {
            right: 0;
        }

        .profile-input, .profile-select {
            padding: 16px 46px 16px 20px; /* 12px*1.3‚âà16px, 35px*1.3‚âà46px, 15px*1.3‚âà20px */
            border: none;
            border-radius: 10px; /* 8px * 1.3 ‚âà 10px */
            background: #E1F5FE;
            color: #333;
            font-size: 18px; /* 14px * 1.3 ‚âà 18px */
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-input:focus, .profile-select:focus {
            outline: none;
            background: #B3E5FC;
        }

        .profile-input::placeholder {
            color: rgba(0,0,0,0.5);
        }

        /* Input box quill icon */
        .profile-field::after {
            content: 'ü™∂';
            position: absolute;
            right: 16px; /* 12px * 1.3 ‚âà 16px */
            top: 49px; /* 38px * 1.3 ‚âà 49px */
            font-size: 16px; /* 12px * 1.3 ‚âà 16px */
            pointer-events: none;
        }

        .name-inputs, .birthday-inputs {
            display: flex;
            gap: 10px; /* Reduced gap for 3 selects */
            position: relative;
        }

        .name-inputs .profile-input,
        .birthday-inputs .profile-select {
            flex: 1;
        }
        
        .birthday-inputs .profile-select {
            min-width: 0; /* Allow shrinking */
        }

        .field-note {
            font-size: 14px; /* 11px * 1.3 ‚âà 14px */
            color: #E91E63;
            line-height: 1.3;
            text-align: center;
            margin-top: 7px; /* 5px * 1.3 ‚âà 7px */
        }

        .profile-submit-btn {
            padding: 16px 52px; /* 12px*1.3‚âà16px, 40px*1.3‚âà52px */
            border: none;
            border-radius: 26px; /* 20px * 1.3 ‚âà 26px */
            font-size: 21px; /* 16px * 1.3 ‚âà 21px */
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF69B4, #E91E63);
            color: white;
            font-weight: 500;
            margin: 20px auto 0; /* 15px * 1.3 ‚âà 20px */
            box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3); /* 3px*1.3‚âà4px, 12px*1.3‚âà16px */
            display: block;
            width: 156px; /* 120px * 1.3 ‚âà 156px */
        }

        .profile-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .profile-submit-btn:active {
            transform: translateY(0px);
        }

        /* Special style adjustments */
        .birthday-inputs .profile-field::after {
            display: none; /* Birthday selector doesn't show edit icon */
        }

        .profile-field.has-multiple-inputs::after {
            display: none; /* Fields with multiple inputs don't show edit icon */
        }

        /* Memory system styles */
        .memory-section {
            background: rgba(255,255,255,0.2);
            border-radius: 16px; /* 12px * 1.3 ‚âà 16px */
            padding: 26px; /* 20px * 1.3 ‚âà 26px */
            margin-top: 13px; /* 10px * 1.3 ‚âà 13px */
        }

        .memory-title {
            text-align: center;
            color: #D4AF37;
            font-size: 18px; /* 14px * 1.3 ‚âà 18px */
            font-weight: 500;
            margin-bottom: 20px; /* 15px * 1.3 ‚âà 20px */
            position: relative;
            padding: 0 26px; /* 20px * 1.3 ‚âà 26px */
        }

        .memory-title::before,
        .memory-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 39px; /* 30px * 1.3 ‚âà 39px */
            height: 1px;
            background: #D4AF37;
        }

        .memory-title::before {
            left: 0;
        }

        .memory-title::after {
            right: 0;
        }

        .memory-field {
            margin-bottom: 16px; /* 12px * 1.3 ‚âà 16px */
            position: relative;
        }

        .memory-label {
            font-size: 16px; /* 12px * 1.3 ‚âà 16px */
            color: #666;
            margin-bottom: 7px; /* 5px * 1.3 ‚âà 7px */
            display: block;
        }

        .memory-input {
            width: 100%;
            padding: 10px 39px 10px 16px; /* 8px*1.3‚âà10px, 30px*1.3‚âà39px, 12px*1.3‚âà16px */
            border: none;
            border-radius: 8px; /* 6px * 1.3 ‚âà 8px */
            background: #F0F8FF;
            color: #333;
            font-size: 16px; /* 12px * 1.3 ‚âà 16px */
            box-sizing: border-box;
        }

        .memory-field::after {
            content: 'ü™∂'; /* Changed to quill icon */
            position: absolute;
            right: 10px; /* 8px * 1.3 ‚âà 10px */
            top: 36px; /* 28px * 1.3 ‚âà 36px */
            font-size: 13px; /* 10px * 1.3 ‚âà 13px */
            pointer-events: none;
        }

        /* Animation effects */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 40px rgba(223, 113, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 15px 60px rgba(223, 113, 255, 0.6);
                transform: scale(1.02);
            }
        }

        .character-info,
        .character-selector,
        .start-button,
        .control-panel {
            animation: fadeInUp 0.8s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Top title -->
        <div class="heroes-title" data-i18n="char.select.header">WAIFU</div>

        <!-- Language Toggle -->
        <div class="language-toggle" id="language-toggle">
            <span data-i18n="char.select.language">Language: </span>
            <button class="language-btn" id="lang-en" onclick="switchLanguage('en')">EN</button>
            <button class="language-btn" id="lang-zh" onclick="switchLanguage('zh')">‰∏≠Êñá</button>
        </div>

        <!-- Character Info Panel - Japanese style profile card UI -->
        <div class="character-info">
            <div class="character-name" id="character-name">Fliza</div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.header">Basic Info</span>
                    <button class="expand-button">‚Üó</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.age">Age</span>
                        <span class="profile-value" id="character-age">22</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.birthday">Birthday</span>
                        <span class="profile-value" id="character-birthday">June 5</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.zodiac">Zodiac</span>
                        <span class="profile-value" id="character-zodiac">Gemini</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.personality">Personality</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-personality" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.interests">Daily Interests</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-interests" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.likes.dislikes">Likes & Dislikes</span>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.likes.label">Likes</span>
                        <span class="profile-value" id="character-likes">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.dislikes.label">Dislikes</span>
                        <span class="profile-value" id="character-dislikes">‚Äî</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.favorites">Favorites</span>
                    <button class="expand-button">‚Üó</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.food.label">Food</span>
                        <span class="profile-value" id="character-food">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.music.label">Music</span>
                        <span class="profile-value" id="character-music">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.movies.label">Movies</span>
                        <span class="profile-value" id="character-movies">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.games.label">Games</span>
                        <span class="profile-value" id="character-games">‚Äî</span>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Central Character Name -->
        <div class="character-display-name" id="character-display-name">Fliza</div>

        <!-- Voice Selector - Floating Control -->
        <div class="voice-selector-floating">
            <div class="language-flags">
                <button class="flag-btn active" data-lang="jp" onclick="playVoiceSample('jp')">üáØüáµ</button>
                <button class="flag-btn" data-lang="en" onclick="playVoiceSample('en')">üá∫üá∏</button>
            </div>
        </div>

        <!-- VRM Display Area -->
        <div class="vrm-display">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- Character Loading Animation -->
            <div class="character-loader" id="character-loader">
                <div class="spinner"></div>
                <div class="loader-text">LOADING</div>
            </div>
        </div>

        <!-- Character Selector -->
        <div class="character-selector">
            <button class="nav-button" onclick="previousCharacter()">‚Äπ</button>
            <div class="character-thumbnails" id="character-thumbnails"></div>
            <div class="selected-indicator">
                <div class="selected-avatar">
                    <img id="selected-avatar-img" src="" alt="Selected Character">
                </div>
                <div class="selected-badge">A</div>
                <div class="selected-text">Select</div>
            </div>
            <div class="character-thumbnails" id="character-thumbnails-right"></div>
            <button class="nav-button" onclick="nextCharacter()">‚Ä∫</button>
        </div>


        <!-- Solana Official Wallet Adapter React Component -->
        <div class="wallet-connect-area">
            <div id="wallet-adapter-root"></div>
        </div>


        <!-- Start Button -->
        <button class="start-button" onclick="startChat()">
            <div class="fold"></div>
            <div class="points_wrapper">
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
            </div>
            <span class="inner" data-i18n="char.select.start">START CHATTING</span>
        </button>
    </div>
    
    <!-- Wallet Connection Modal - Modern Design -->
    <div class="wallet-modal" id="wallet-modal">
        <div class="wallet-modal-overlay">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h2>Connect wallet</h2>
                    <p>Get started by connecting your preferred wallet below.</p>
                </div>
                
                <div class="wallet-list">
                    <div class="wallet-option" data-provider="phantom">
                        <div class="wallet-option-icon">üëª</div>
                        <span class="wallet-option-name">Phantom</span>
                        <div class="wallet-option-arrow">‚Üí</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="solflare">
                        <div class="wallet-option-icon">‚òÄÔ∏è</div>
                        <span class="wallet-option-name">Solflare</span>
                        <div class="wallet-option-arrow">‚Üí</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="coinbase">
                        <div class="wallet-option-icon">üî∑</div>
                        <span class="wallet-option-name">Coinbase</span>
                        <div class="wallet-option-arrow">‚Üí</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="backpack">
                        <div class="wallet-option-icon">üéí</div>
                        <span class="wallet-option-name">Backpack</span>
                        <div class="wallet-option-arrow">‚Üí</div>
                    </div>
                </div>
                
                <div class="wallet-modal-footer">
                    <p>By connecting your wallet, you're agree to our 
                        <a href="#" class="wallet-link">Terms of Service</a> 
                        and our 
                        <a href="#" class="wallet-link">Privacy Policy</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // Character data - simplified version, personality managed by ElizaOS backend
        const characters = [
            { 
                id: "alice", 
                name: "Alice", 
                file: "Main VRM/Alice.vrm", 
                voiceId: "rEJAAHKQqr6yTNCh8xS0", 
                description: "Lively and adorable AI girlfriend",
                sampleLines: {
                    jp: "ÊúàÊòé„Åã„Çä„ÅÆ‰∏ã„Åß‰∫å‰∫∫„Åç„Çä„ÅßË∏ä„Çç„ÅÜÔºÅ",
                    en: "Let's dance under the moonlight, just us two!"
                }
            },
            { 
                id: "ash", 
                name: "Ash", 
                file: "Main VRM/Ash.vrm", 
                voiceId: "bY4cOgafbv5vatmokfg0", 
                description: "Calm and rational AI companion",
                sampleLines: {
                    jp: "Èùô„Åã„Å™Â§ú„Å´Êú¨„Å®„Ç≥„Éº„Éí„Éº„ÅåÊúÄÈ´ò„Å†„ÄÇ",
                    en: "A quiet night with a book and coffee is perfect."
                }
            },
            {
                id: "elinyaa",
                name: "Elinyaa",
                file: "Main VRM/Elinyaa.vrm",
                personality: "Mysterious and elegant elf girl with incredible charm.",
                traits: ["Mysterious", "Elegant", "Elf", "Ethereal"],
                emoji: "üßö",
                level: 29,
                type: "Elf Type",
                voiceId: "4cxHntmhK38NT4QMBr9m",
                sampleLines: {
                    jp: "È≠îÊ≥ï„ÅÆ‰∏ñÁïå„Åß„Éí„Éº„É≠„Éº„Åî„Å£„Åì„Åó„Å™„ÅÑÔºü",
                    en: "Want to play pretend heroes in a magical land?"
                }
            },
            {
                id: "fliza",
                name: "Fliza",
                file: "Main VRM/Fliza VRM.vrm",
                personality: "Warm, caring, and understanding",
                dailyInterests: "Farming, Gardening",
                likes: "Sunrise and morning dew",
                dislikes: "Pollution",
                favoriteFood: "Fresh fruit, honey lemonade",
                favoriteMusic: "Folk songs, natural soundscapes",
                favoriteMovies: "Nature documentaries, heartwarming stories",
                favoriteGames: "Animal Crossing",
                age: "23 years old",
                birthday: "August 14",
                zodiac: "Leo",
                height: "Unlocked at Affection Lv.10",
                weight: "Unlocked at Affection Lv.10",
                measurements: "Unlocked at Affection Lv.20",
                voiceId: "s9lrHYk7TIJ2UO7UNbje",
                sampleLines: {
                    jp: "Êó•„ÅÆÂá∫„Å´‰∏ÄÁ∑í„Å´Á®Æ„Çí„Åæ„Åã„Å™„ÅÑÔºü",
                    en: "Care to join me in planting seeds at sunrise?"
                }
            },
            {
                id: "imeris",
                name: "Imeris",
                file: "Main VRM/IMERIS.vrm",
                personality: "Noble and elegant aristocratic girl with graceful manners.",
                traits: ["Noble", "Elegant", "Graceful", "Aristocratic"],
                emoji: "üëë",
                level: 31,
                type: "Noble Type",
                voiceId: "eVItLK1UvXctxuaRV2Oq",
                sampleLines: {
                    jp: "‰ΩìÊ∏©„ÇíÊ∏¨„Çâ„Åõ„Å¶„Å≠‚Äî„ÅÇ„Å™„Åü„ÅÆ„Åì„Å®„ÇíÂ§ß‰∫ã„Å´ÊÄù„Å£„Å¶„Çã„ÄÇ",
                    en: "Let me check your temperature‚ÄîI care for you."
                }
            },
            {
                id: "maple",
                name: "Maple",
                file: "Main VRM/Maple.vrm",
                personality: "A girl warm as autumn sunshine, always giving a sense of security.",
                traits: ["Warm", "Virtuous", "Careful", "Healing"],
                emoji: "üçÅ",
                level: 26,
                type: "Warm Type",
                voiceId: "B8gJV1IhpuegLxdpXFOE",
                sampleLines: {
                    jp: "ÊöñÁÇâ„ÅÆ„Åù„Å∞„Åß„ÉØ„ÉÉ„Éï„É´„ÅØ„ÅÑ„Åã„ÅåÔºü",
                    en: "Would you like a warm waffle by my cozy fireplace?"
                }
            },
            {
                id: "nekona",
                name: "Nekona",
                file: "Main VRM/NEKONA.vrm",
                personality: "Cute cat girl with cat-like laziness and liveliness.",
                traits: ["Cute", "Catgirl", "Lazy", "Lively"],
                emoji: "üê±",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "kcg1KQQGuCGzH6FUjsZQ",
                sampleLines: {
                    jp: "Â§ú„ÅåÁßòÂØÜ„ÇíÂõÅ„Åè‚Äî‰∏ÄÁ∑í„Å´Êé¢Ê§ú„Åó„Çà„ÅÜÔºü",
                    en: "The night whispers secrets‚Äîshall we explore them?"
                }
            },
            {
                id: "notia",
                name: "Notia",
                file: "Main VRM/Notia.vrm",
                personality: "Intellectual and calm researcher, full of thirst for knowledge.",
                traits: ["Intellectual", "Calm", "Research", "Knowledgeable"],
                emoji: "üî¨",
                level: 32,
                type: "Scholar Type",
                voiceId: "abz2RylgxmJx76xNpaj1",
                sampleLines: {
                    jp: "„Åù„Çç„Åù„ÇçËå∂ÈÅì„Çí„Åó„Åæ„Åõ„Çì„ÅãÔºüÂøÉ„Å´Èùô„Åë„Åï„ÇíÊ∫Ä„Åü„Åù„ÅÜ„ÄÇ",
                    en: "Tea ceremony soon? Let tranquility fill our hearts."
                }
            },
            {
                id: "ququ",
                name: "QuQu",
                file: "Main VRM/QuQu.vrm",
                personality: "Lively and cute loli, always full of energy.",
                traits: ["Lively", "Cute", "Energetic", "Loli"],
                emoji: "üéÄ",
                level: 20,
                type: "Loli Type",
                voiceId: "tfQFvzjodQp63340jz2r",
                sampleLines: {
                    jp: "Ê¨°„ÅÆ„ÉØ„Ç§„É´„Éâ„É©„Ç§„Éâ„Åß„Ç¢„Éâ„É¨„Éä„É™„É≥„ÇíËøΩ„ÅÑ„Åã„Åë„ÇãÊ∫ñÂÇô„ÅØÔºü",
                    en: "Ready to chase adrenaline on our next wild ride?"
                }
            },
            {
                id: "rindo",
                name: "Rindo",
                file: "Main VRM/RINDO.vrm",
                personality: "Traditional Japanese Yamato Nadeshiko, gentle and virtuous.",
                traits: ["Japanese style", "Traditional", "Gentle", "Virtuous"],
                emoji: "üå∏",
                level: 28,
                type: "Japanese Style Type",
                voiceId: "nclQ39ewSlJMu5Nidnsf",
                sampleLines: {
                    jp: "ÂàÄ„ÅÆÊäú„ÅçÊñπ„Å´ÈõÜ‰∏≠„Åó„Å¶„ÄÇË¶èÂæã„ÅåËÇùÂøÉ„Å†„ÄÇ",
                    en: "Focus on the cut of your blade; discipline is key."
                }
            },
            {
                id: "rainy",
                name: "Rainy",
                file: "Main VRM/Rainy.vrm",
                personality: "Lively and cheerful girl next door, always full of vitality.",
                traits: ["Lively", "Cheerful", "Athletic", "Sunny"],
                emoji: "üåßÔ∏è",
                level: 22,
                type: "Energetic Type",
                voiceId: "1ghrzLZQ7Dza7Xs9OkhY",
                sampleLines: {
                    jp: "Á™ì„ÇíÂè©„ÅèÈõ®Èü≥„ÅØÁßÅ„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂ≠êÂÆàÂîÑ„ÄÇ",
                    en: "Rain tapping on windows is my favorite lullaby."
                }
            },
            {
                id: "vivi",
                name: "Vivi",
                file: "Main VRM/Vivi.vrm",
                personality: "Curious explorer, always passionate about the world.",
                traits: ["Curious", "Adventurous", "Passionate", "Optimistic"],
                emoji: "‚ú®",
                level: 24,
                type: "Adventure Type",
                voiceId: "4lWJNy00PxQAOMgQTiIS",
                sampleLines: {
                    jp: "‰ªäÂ§ú„ÅØ„Åø„Çì„Å™„Å´Á¨ëÈ°î„ÇíÂ±ä„Åë„ÇãÈÖç‰ø°„Çí„Åó„Çà„ÅÜÔºÅ",
                    en: "Let's stream and share smiles with everyone tonight!"
                }
            },
            {
                id: "wolferia",
                name: "Wolferia",
                file: "Main VRM/Wolferia.vrm",
                personality: "Proud wolf princess with royal temperament.",
                traits: ["Proud", "Wolf clan", "Royal", "Majestic"],
                emoji: "üê∫",
                level: 33,
                type: "Beast Girl Type",
                voiceId: "3SeVwPUl5aO6J2GETjox",
                sampleLines: {
                    jp: "È†¨„Å´Èõ™„ÅÆÁµêÊô∂‚Äî‰∏ÄÁ∑í„Å´Èõ™„Å†„Çã„Åæ‰Ωú„Çâ„Å™„ÅÑÔºü",
                    en: "Snowflakes on my cheek‚Äîcare to build a snowman?"
                }
            },
            {
                id: "yawl",
                name: "Yawl",
                file: "Main VRM/Yawl.vrm",
                personality: "Mysterious magical girl with incredible power.",
                traits: ["Mysterious", "Magic", "Fantasy", "Powerful"],
                emoji: "üîÆ",
                level: 30,
                type: "Magic Type",
                voiceId: "c6wjO0u66VyvwAC4UTqx",
                sampleLines: {
                    jp: "Èùô„Åã„Å´„ÅäËå∂„Çí„Åô„Åô„Çä„ÄÅ‰∫∫Áîü„ÅÆÁâ©Ë™û„ÇíÂë≥„Çè„Åä„ÅÜ„ÄÇ",
                    en: "Sipping tea in silence reveals life's greatest tales."
                }
            },
            {
                id: "yuuyii",
                name: "Yuu Yii",
                file: "Main VRM/Yuu Yii.vrm",
                personality: "One of the gentle and lovely twins, always with a sweet smile.",
                traits: ["Gentle", "Cute", "Twin", "Sweet"],
                emoji: "üíï",
                level: 23,
                type: "Twin Type",
                voiceId: "UPwKM85l2CG7nbF2u1or",
                sampleLines: {
                    jp: "Ê≥°„Å®Á¨ë„ÅÑ‚Äî„Éë„Çπ„ÉÜ„É´„ÅÆ‰∏ñÁïå„Çí‰Ωú„Çç„ÅÜÔºÅ",
                    en: "Bubbles and giggles‚Äîlet's craft a world of pastel joy!"
                }
            },
            {
                id: "zwei",
                name: "Zwei",
                file: "Main VRM/Zwei.vrm",
                personality: "Cool and handsome warrior girl with a strong heart.",
                traits: ["Cool", "Handsome", "Warrior", "Strong"],
                emoji: "‚öîÔ∏è",
                level: 29,
                type: "Warrior Type",
                voiceId: "0EzDWfDZDlAIeQQOjhoC",
                sampleLines: {
                    jp: "„Åù„Å∞„Å´„ÅÑ„Å¶‚Äî„Å©„Çì„Å™Âµê„ÇÇÂÆà„Çã„Çà„ÄÇ",
                    en: "Stand by my side‚ÄîI'll protect you through every storm."
                }
            },
            {
                id: "bobo",
                name: "Bobo",
                file: "Main VRM/bobo.vrm",
                personality: "Innocent little angel, always bringing joy.",
                traits: ["Innocent", "Pure", "Happy", "Angel"],
                emoji: "üòá",
                level: 19,
                type: "Angel Type",
                voiceId: "I7CpaIqk2oGPGCKvOPO9",
                sampleLines: {
                    jp: "„Å¨„ÅÑ„Åê„Çã„Åø„ÇíÊä±„Åà„Å¶‰∏ÄÁ∑í„Å´„ÅäÁµµÊèè„Åç„Åó„Çà„ÅÜÔºü",
                    en: "Can we cuddle with plushies and draw together?"
                }
            },
            {
                id: "kyoko",
                name: "Kyoko",
                file: "Main VRM/kyoko.vrm",
                personality: "Mature and steady big sister, trustworthy.",
                traits: ["Mature", "Steady", "Reliable", "Big sister"],
                emoji: "üíú",
                level: 28,
                type: "Big Sister Type",
                voiceId: "ATSlMe1wEISLjgGhZEKK",
                sampleLines: {
                    jp: "ÁßÅ„Å´ÁôªÂ±±„ÇíÊåë„Çì„Åß„ÄÅ‰∏ÄÁ∑í„Å´È†Ç‰∏ä„ÇíÁõÆÊåá„Åù„ÅÜ„ÄÇ",
                    en: "Challenge me to a climb and we'll conquer peaks."
                }
            },
            {
                id: "lena",
                name: "Lena",
                file: "Main VRM/lena.vrm",
                personality: "Smart and witty academic girl, always giving the best advice.",
                traits: ["Smart", "Rational", "Academic", "Reliable"],
                emoji: "üìö",
                level: 30,
                type: "Wisdom Type",
                voiceId: "uEn2ClE3OziJMlhQS91c",
                sampleLines: {
                    jp: "‰ªäÂ§ú„ÉØ„Ç§„É≥„ÇíÈ£≤„Åø„Å™„Åå„Çâ„Ç¢„Éº„Éà„ÇíË™û„Çâ„Å™„ÅÑÔºü",
                    en: "Shall we enjoy wine and discuss art this evening?"
                }
            },
            {
                id: "lilium",
                name: "Lilium",
                file: "Main VRM/lilium.vrm",
                personality: "Elegant and mysterious girl with unique charm.",
                traits: ["Elegant", "Mysterious", "Artistic", "Romantic"],
                emoji: "üå∫",
                level: 28,
                type: "Mysterious Type",
                voiceId: "yRRXNdbFeQpIK5MAhenr",
                sampleLines: {
                    jp: "„Éì„Éº„Éà„ÇíÊÑü„Åò„ÇãÔºüË∏ä„Å£„Å¶‰∏ñÁïå„ÇíÁáÉ„ÇÑ„Åù„ÅÜ„ÄÇ",
                    en: "Feel the beat? Let's move and set the world ablaze."
                }
            },
            {
                id: "miru",
                name: "Miru",
                file: "Main VRM/miru.vrm",
                personality: "Soft and cute little loli, makes people want to protect.",
                traits: ["Soft cute", "Adorable", "Loli", "Pure"],
                emoji: "üçº",
                level: 18,
                type: "Loli Type",
                voiceId: "eVJCDcwCTZBLNdQdbdmd",
                sampleLines: {
                    jp: "Èõ≤„ÅåË∏ä„ÇãÂ§¢„ÇíË¶ã„Åü„Çà‚Äî‰∏ÄÁ∑í„Å´ÊµÆ„Åã„Åº„ÅÜÔºü",
                    en: "I dreamt of clouds dancing‚Äîcome float with me?"
                }
            },
            {
                id: "miumiu",
                name: "Miu Miu",
                file: "Main VRM/miu miu.vrm",
                personality: "Playful and cute cat-eared girl who likes to act cute.",
                traits: ["Playful", "Cute", "Cat ears", "Coquettish"],
                emoji: "üò∏",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "SU7BtMmgc7KhQiC6G24B",
                sampleLines: {
                    jp: "Â§ßÂ•Ω„Åç„Å™„ÅÇ„Å™„Åü„ÅÆ„Åü„ÇÅ„Å´„Ç≠„É©„Ç≠„É©„ÇØ„É©„Éï„Éà‰Ωú„Å£„Åü„ÇàÔºÅ",
                    en: "I made sparkly crafts just for my favorite person!"
                }
            },
            {
                id: "sikirei",
                name: "Sikirei",
                file: "Main VRM/sikirei.vrm",
                personality: "A girl as changeable as the four seasons, full of mystery.",
                traits: ["Changeable", "Mysterious", "Seasonal", "Nimble"],
                emoji: "üå∑",
                level: 27,
                type: "Nature Type",
                voiceId: "n263mAk9k8VWEuZSmuMl",
                sampleLines: {
                    jp: "‰∏ÄÁ∑í„Å´Êòü„ÇíÁú∫„ÇÅ„Çà„ÅÜ‚ÄîÂÆáÂÆô„ÅåÁßÅ„Åü„Å°„ÅÆÁßòÂØÜ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Çã„ÄÇ",
                    en: "Gaze at stars with me‚Äîuniverse awaits our secrets."
                }
            },
            {
                id: "wolf",
                name: "Wolf",
                file: "Main VRM/wolf.vrm",
                personality: "Lone wolf with her own persistence.",
                traits: ["Aloof", "Independent", "Persistent", "Calm"],
                emoji: "üåô",
                level: 31,
                type: "Lone Wolf Type",
                voiceId: "WW3EvqkXGmu65ga8TYqa",
                sampleLines: {
                    jp: "Ê£Æ„ÅÆÂëº„Å≥Â£∞„ÅåËÅû„Åì„Åà„ÇãÔºüËá™Áî±„Å´„Åï„Åæ„Çà„Åä„ÅÜ„ÄÇ",
                    en: "Can you hear the forest's call? Let's roam free."
                }
            },
            {
                id: "neco",
                name: "Neco",
                file: "Main VRM/neco.vrm",
                personality: "Cool and intellectual elegant girl with unique charm.",
                traits: ["Cool", "Intellectual", "Elegant", "Mysterious"],
                emoji: "üê±",
                level: 25,
                type: "Intellectual Type",
                voiceId: "t9ZwnJtpA3lWrJ4W7pAl",
                sampleLines: {
                    jp: "Èùô„Åã„Å™ÈöÖ„Åß„ÄÅÂΩ±„Å´Èö†„Çå„ÅüÁâ©Ë™û„ÇíË¶ã„Å§„Åë„Çã„ÄÇ",
                    en: "In quiet corners, I find stories hidden in shadows."
                }
            }
        ];

        // Character avatar mapping
        function getProfilePicture(characterName) {
            const profileMap = {
                'Alice': 'alice-pf.png',
                'Ash': 'ash-pf.png',
                'Elinyaa': 'elinyaa-pf.png',
                'Fliza': 'fliza-pf.png',
                'Imeris': 'imeris-pf.png',
                'Maple': 'maple-pf.png',
                'Nekona': 'nekona.png',
                'Notia': 'notia-pf.png',
                'QuQu': 'ququ-pf.png',
                'Rindo': 'rindo-pf.png',
                'Rainy': 'rainy-pf.png',
                'Vivi': 'vivi-pf.png',
                'Wolferia': 'wolferia-pf.png',
                'Yawl': 'yawl-pf.png',
                'Yuu Yii': 'yuu yii-pf.png',
                'Zwei': 'zwei-pf.png',
                'Bobo': 'bobo-pf.png',
                'Kyoko': 'kyoko-pf.png',
                'Lena': 'lena-pf.png',
                'Lilium': 'lilium.png',
                'Miru': 'Miru-pf.png',
                'Miu Miu': 'miumiu-pf.png',
                'Sikirei': 'sikirei-pf.png',
                'Wolf': 'wolf.png'
            };
            return `profile-pic/${profileMap[characterName] || 'default.png'}`;
        }

        // Global variables
        let scene, camera, renderer, controls;
        let currentVRM = null;
        let mixer = null;
        let animationAction = null;
        let currentCharacterIndex = 0;
        let isLoading = false;
        
        // Voice playback variables - declared early
        let currentAudio = null;
        let currentLanguage = 'jp'; // Default Japanese
        // English profile cache based on character.md (declared early to avoid TDZ)
        var englishProfiles = null;
        
        // Backend API configuration
        const API_URL = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';

        // Initialize
        init();
        generateThumbnails();
        // Initialize selected character image and profile
        document.addEventListener('DOMContentLoaded', function() {
            const selectedAvatar = document.getElementById('selected-avatar-img');
            if (selectedAvatar && characters[0]) {
                selectedAvatar.src = getProfilePicture(characters[0].name);
            }
            // Initialize character profile
            updateCharacterProfile(characters[0]);
            
            // Mobile: center character selector scrollbar
            if (window.innerWidth <= 768) {
                const characterList = document.querySelector('.character-list');
                if (characterList) {
                    // Calculate scroll to center position
                    const scrollWidth = characterList.scrollWidth;
                    const clientWidth = characterList.clientWidth;
                    const centerPosition = (scrollWidth - clientWidth) / 2;
                    characterList.scrollLeft = centerPosition;
                }
            }
        });
        loadCharacter(0);

        function init() {
            // Create scene
            scene = new THREE.Scene();

            // Get actual canvas container size
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // Create camera - use container size instead of window size
            camera = new THREE.PerspectiveCamera(30.0, containerRect.width / containerRect.height, 0.1, 20.0);
            camera.position.set(0.0, 0.5, 5.2);

            // Create renderer - use container size
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // Transparent background
            
            // No need for complex shadow system, use simple foot shadow
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Create controller - use same settings as index.html
            controls = new OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.target.set(0.0, 0.5, 0.0);
            controls.update();

            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // Main light source - simplified settings
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 6, 2);
            
            scene.add(directionalLight);

            // Fill light
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            // Create gradient circular shadow - mimic reference screenshot
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // Create radial gradient shadow
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // Darker center
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // Medium transparency
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // Completely transparent edges
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(0, -0.82, 0); // Directly attached to feet
            scene.add(shadow);
            
            // Save shadow reference for later position updates
            window.characterShadow = shadow;

            // Start render loop
            animate();

            // Window resize
            window.addEventListener('resize', onWindowResize);
        }


        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;
            
            // Update VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
            }
            
            // Update animation mixer
            if (mixer) {
                mixer.update(deltaTime);
            }

            // Update controller
            controls.update();

            // Render
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }

        function loadCharacter(index) {
            if (isLoading) {
                return;
            }

            isLoading = true;
            // Update character index and thumbnails immediately
            currentCharacterIndex = index;
            updateThumbnails();
            
            const loadingStartTime = Date.now();

            const character = characters[index];
            
            // Show loading animation
            showCharacterLoader();

            // Update UI
            const nameElement = document.getElementById('character-name');
            if (nameElement) nameElement.textContent = character.name;
            
            const levelElement = document.getElementById('character-level');
            if (levelElement) levelElement.textContent = character.level;
            
            const displayNameElement = document.getElementById('character-display-name');
            if (displayNameElement) displayNameElement.textContent = character.name;

            // No placeholder needed

            // Load VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            loader.load(
                character.file,
                (gltf) => {
                    const vrm = gltf.userData.vrm;
                    
                    if (vrm) {
                        
                        // Use VRM v2 compatible optimization methods
                        VRMUtils.removeUnnecessaryVertices(gltf.scene);
                        // VRMUtils.combineSkeletons Âú® v2 ‰∏≠Â∑≤ÁßªÈô§
                        // VRMUtils.combineMorphs Âú® v2 ‰∏≠Â∑≤ÁßªÈô§
                        
                        // Clean old VRM (but keep lights and placeholder)
                        if (currentVRM) {
                            scene.remove(currentVRM.scene);
                            VRMUtils.deepDispose(currentVRM.scene);
                        }

                        // Set new VRM - use same settings as index.html
                        currentVRM = vrm;
                        
                        // Scale VRM model up by 45% (consistent with index.html)
                        vrm.scene.scale.set(1.45, 1.45, 1.45);
                        
                        // Move VRM model position down, closer to bottom boundary
                        vrm.scene.position.y = -0.8;
                        
                        // Hide VRM first to prevent T-pose flash
                        vrm.scene.visible = false;
                        
                        mixer = new THREE.AnimationMixer(currentVRM.scene);
                        
                        vrm.scene.traverse((obj) => {
                            obj.frustumCulled = false;
                        });
                        
                        // VRMUtils.rotateVRM0 Âú® v2 ‰∏≠ÂèØËÉΩ‰∏çÈúÄË¶ÅÊàñÂ∑≤Êõ¥Êîπ
                        // VRM 0.x format may need rotation; VRM 1.x format usually doesn't
                        try {
                            VRMUtils.rotateVRM0(vrm);
                        } catch (error) {
                        }
                        
                        // Add to scene
                        scene.add(vrm.scene);
                        
                        // Load default animation immediately, then show VRM
                        loadDefaultAnimation().then(() => {
                            // Wait a few frames to ensure animation starts playing, then show VRM
                            setTimeout(() => {
                                if (currentVRM && currentVRM.scene) {
                                    currentVRM.scene.visible = true;
                                    // Hide loader
                                    hideCharacterLoader();
                                }
                            }, 150); // Increase to 150ms to ensure animation is applied
                        });
                        
                    } else {
                        // Hide loader even when VRM data doesn't exist
                        hideCharacterLoader();
                    }

                    finishLoading(index, loadingStartTime);
                },
                (progress) => {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                },
                (error) => {
                    console.error('‚ùå VRM load failed:', error);
                    // Hide loader on failure
                    hideCharacterLoader();
                    finishLoading(index, loadingStartTime);
                }
            );
        }

        function finishLoading(index, loadingStartTime) {
            const elapsedTime = Date.now() - (loadingStartTime || 0);
            const remainingTime = Math.max(0, 3000 - elapsedTime); // Minimum 3 seconds
            
            setTimeout(() => {
                isLoading = false;
                
                // Debug info
            }, remainingTime);
        }


        function generateThumbnails() {
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side
            
            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }

        }

        // Get a set of fields from i18n by character ID (if exists)
        function getI18nProfileById(charId) {
            if (!window.i18n || !charId) return null;
            const fields = ['age','birthday','zodiac','personality','interests','likes','dislikes','food','music','movies','games'];
            const profile = {};
            let hasAny = false;
            fields.forEach(f => {
                const key = `character.${charId}.${f}`;
                const value = i18n.t(key);
                // If key is not configured, i18n.t returns key itself or English fallback; roughly determine by checking if equal to key
                if (value && value !== key) {
                    hasAny = true;
                    switch (f) {
                        case 'interests': profile.dailyInterests = value; break;
                        case 'food': profile.favoriteFood = value; break;
                        case 'music': profile.favoriteMusic = value; break;
                        case 'movies': profile.favoriteMovies = value; break;
                        case 'games': profile.favoriteGames = value; break;
                        default: profile[f] = value;
                    }
                }
            });
            return hasAny ? profile : null;
        }

        // Êõ¥Êñ∞ËßíËâ≤Ê°£Ê°à‰ø°ÊÅØÔºà‰ºòÂÖà i18n -> profile Êï∞ÊçÆ -> ÂÖúÂ∫ïÔºâ
        function updateCharacterProfile(character) {
            const currentLang = getCurrentLanguage();
            // 1) ‰ºòÂÖà‰ªé i18n ÂèñÔºàÊåâËßíËâ≤IDÁöÑÈîÆÂÄºÔºâ
            const i18nProfile = getI18nProfileById(character.id);
            // 2) ÂÖ∂Ê¨°‰ªéÂÜÖÁΩÆ profilesData ÂèñÔºàÊîØÊåÅ zh/en ÊàñÊâÅÂπ≥ÁªìÊûÑÔºâ
            const fallbackProfile = getCharacterProfile(character.name, currentLang);
            // ÂêàÂπ∂Ôºài18n ‰ºòÂÖàÁîüÊïàÔºâ
            const profile = { ...fallbackProfile, ...i18nProfile };

            document.getElementById('character-name').textContent = character.name;

            document.getElementById('character-age').textContent = profile.age ?? '';
            document.getElementById('character-birthday').textContent = profile.birthday ?? '';
            document.getElementById('character-zodiac').textContent = profile.zodiac ?? '';
            document.getElementById('character-personality').textContent = profile.personality ?? '';

            const interestsEl = document.getElementById('character-interests');
            if (interestsEl) interestsEl.textContent = profile.dailyInterests ?? '';

            const likesEl = document.getElementById('character-likes');
            if (likesEl) likesEl.textContent = profile.likes ?? '';

            const dislikesEl = document.getElementById('character-dislikes');
            if (dislikesEl) dislikesEl.textContent = profile.dislikes ?? '';

            const foodEl = document.getElementById('character-food');
            if (foodEl) foodEl.textContent = profile.favoriteFood ?? '';

            const musicEl = document.getElementById('character-music');
            if (musicEl) musicEl.textContent = profile.favoriteMusic ?? '';

            const moviesEl = document.getElementById('character-movies');
            if (moviesEl) moviesEl.textContent = profile.favoriteMovies ?? '';

            const gamesEl = document.getElementById('character-games');
            if (gamesEl) gamesEl.textContent = profile.favoriteGames ?? '';

            updateVoiceSelector();
        }

        // ÂêçÁß∞ËßÑËåÉÂåñ‰∏éÂà´ÂêçÂ§ÑÁêÜÔºàÂ§ßÂ∞èÂÜô„ÄÅÁ©∫Ê†ºÂ∑ÆÂºÇÔºâ
        function canonicalName(name) {
            if (!name) return '';
            const key = name.toLowerCase().replace(/\s+/g, '');
            const aliasMap = {
                'ququ': 'Ququ',
                'miumiu': 'Miumiu',
                'miu\u00a0miu': 'Miumiu', // Èò≤Á©∫Ê†ºÂèò‰ΩìÔºà‰∏çÂΩ±ÂìçÂ§ßÂ§öÊï∞ÊÉÖÂÜµÔºâ
                'yuuyii': 'Yuu Yii'
            };
            // ÈªòËÆ§È¶ñÂ≠óÊØçÂ§ßÂÜô‰øùÊåÅÂéüÂêçÔºõ‰ºòÂÖàÂà´Âêç
            return aliasMap[key] || name;
        }

        // ‰ªé character.md Ëß£ÊûêËã±ÊñáËµÑÊñôÔºà‰Ωú‰∏∫ÊùÉÂ®ÅËã±ÊñáÊ∫êÔºâ
        async function loadEnglishProfiles() {
            try {
                const res = await fetch('character.md');
                if (!res.ok) return;
                const txt = await res.text();
                const blocks = txt.split(/^## /m).slice(1); // Ë∑≥ËøáÊñáÊ°£Â§¥
                const profiles = {};
                for (const block of blocks) {
                    const lines = block.split(/\n/);
                    const rawName = (lines[0] || '').trim();
                    const name = rawName.replace(/\r?$/, '');
                    const get = (label) => {
                        // Êõ¥Á®≥ÂÅ•ÁöÑËß£ÊûêÔºö‰∏çÁî®Ê≠£ÂàôÔºåÁõ¥Êé•Êâæ ‚Äú- **Label**:‚Äù ÂâçÁºÄ
                        const needle = `- **${label}**:`;
                        const line = lines.find(l => l.trimStart().startsWith(needle));
                        if (!line) return undefined;
                        const idx = line.indexOf(':');
                        if (idx === -1) return undefined;
                        return line.slice(idx + 1).trim();
                    };
                    const p = {
                        age: get('Age'),
                        birthday: get('Birthday'),
                        zodiac: get('Zodiac'),
                        personality: get('Personality'),
                        dailyInterests: get('Daily Interests'),
                    };
                    // Likes & Dislikes: "Likes X; dislikes Y"
                    const likesLine = get('Likes & Dislikes');
                    if (likesLine) {
                        const likeMatch = likesLine.match(/Likes([^;]+?)(?:;|$)/i);
                        const dislikeMatch = likesLine.match(/dislikes([^;]+?)(?:;|$)/i);
                        if (likeMatch) p.likes = likeMatch[1].trim();
                        if (dislikeMatch) p.dislikes = dislikeMatch[1].trim();
                    }
                    p.favoriteFood = get('Favorite Foods');
                    p.favoriteMusic = get('Favorite Music');
                    p.favoriteMovies = get('Favorite Movies');
                    p.favoriteGames = get('Favorite Games');

                    if (name) {
                        profiles[canonicalName(name)] = p;
                    }
                }
                englishProfiles = profiles;
                // Ëã•ÂΩìÂâçËØ≠Ë®ÄÊòØËã±ÊñáÔºåÂä†ËΩΩÂÆåÊàêÂêéÂà∑Êñ∞ÂΩìÂâçËßíËâ≤ÁöÑËµÑÊñô
                if (getCurrentLanguage() === 'en' && typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                    updateCharacterProfile(characters[currentCharacterIndex]);
                }
            } catch (e) {
                console.warn('Failed to load character.md profiles:', e);
            }
        }

        // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄËÆæÁΩÆ
        function getCurrentLanguage() {
            // Ê£ÄÊü•localStorage‰∏≠ÁöÑËØ≠Ë®ÄËÆæÁΩÆ
            const savedLang = localStorage.getItem('language');
            if (savedLang) return savedLang;
            
            // Ê£ÄÊü•ËØ≠Ë®ÄÊåâÈíÆÁöÑactiveÁä∂ÊÄÅ
            const activeLangBtn = document.querySelector('.language-btn.active');
            if (activeLangBtn) {
                return activeLangBtn.id === 'lang-en' ? 'en' : 'zh';
            }
            
            // ÈªòËÆ§ËøîÂõûËã±Êñá
            return 'en';
        }

        // Ê†πÊçÆËßíËâ≤ÂêçËé∑ÂèñËØ¶ÁªÜÊ°£Ê°à - Âü∫‰∫éÊú¨Âú∞ÈÖçÁΩÆ + character.md Ëã±ÊñáÊùÉÂ®Å
        function getCharacterProfile(name, language = 'en') {
            const profilesData = {
                "Sikirei": {
                    zh: {
                        age: 24,
                        birthday: "10Êúà10Êó•",
                        zodiac: "Â§©Áß§Â∫ß",
                        personality: "ËØ±‰∫∫„ÄÅÁ•ûÁßò„ÄÅ‰ºòÈõÖ",
                        dailyInterests: "Âç†ÊòüÁ†îÁ©∂",
                        likes: "ÊòüÊòüÂíåÂ§úÁ©∫",
                        dislikes: "ÂÖâÊ±°Êüì",
                        favoriteFood: "ËìùËéìÂ∏É‰∏Å„ÄÅËä±ËçâËå∂",
                        favoriteMusic: "Ê∞õÂõ¥Èü≥ÊôØ",
                        favoriteMovies: "ÁßëÂπªÊÇ¨Áñë",
                        favoriteGames: "Ê®°Êãü‰∫∫Áîü"
                    },
                    en: {
                        age: 24,
                        birthday: "October 10",
                        zodiac: "Libra",
                        personality: "Alluring, mysterious, and refined",
                        dailyInterests: "Astrology research",
                        likes: "Stars and night sky",
                        dislikes: "Light pollution",
                        favoriteFood: "Blueberry pudding, herbal tea",
                        favoriteMusic: "Ambient soundscapes",
                        favoriteMovies: "Sci-fi mysteries",
                        favoriteGames: "The Sims"
                    }
                },
                "Alice": {
                    zh: {
                        age: 22,
                        birthday: "6Êúà5Êó•",
                        zodiac: "ÂèåÂ≠êÂ∫ß",
                        personality: "Ê¥ªÊ≥ºÂ§ñÂêëÔºåË∞ÉÁöÆÂèØÁà±",
                        dailyInterests: "Ë∑≥Ëàû„ÄÅÂî±Ê≠å",
                        likes: "È≤úËä±ÂíåÂΩ©Ëâ≤ÁîúÁÇπ",
                        dislikes: "ÂÆâÈùôÂíåËøá‰∫é‰∏•ËÇÉÁöÑÂú∫Âêà",
                        favoriteFood: "ËçâËéìËõãÁ≥ï„ÄÅÈ©¨Âç°Èæô",
                        favoriteMusic: "ÊµÅË°åËàûÊõ≤„ÄÅK-Pop",
                        favoriteMovies: "Êµ™Êº´ÂñúÂâß",
                        favoriteGames: "ËäÇÂ•èËàûËπàÊ∏∏Êàè"
                    },
                    en: {
                        age: 22,
                        birthday: "June 5",
                        zodiac: "Gemini",
                        personality: "Lively and outgoing, playful and cute",
                        dailyInterests: "Dancing, singing",
                        likes: "Flowers and colorful sweets",
                        dislikes: "Quiet and overly serious occasions",
                        favoriteFood: "Strawberry cake, macarons",
                        favoriteMusic: "Pop dance music, K-Pop",
                        favoriteMovies: "Romantic comedies",
                        favoriteGames: "Rhythm dance games"
                    }
                },
                "Fliza": {
                    zh: {
                        age: 23,
                        birthday: "August 14",
                        zodiac: "Leo",
                        personality: "Ê∏©Êöñ„ÄÅÂÖ≥ÊÄÄ„ÄÅÂØåÊúâÂêåÊÉÖÂøÉ",
                        dailyInterests: "ÂÜú‰∏ö„ÄÅÂõ≠Ëâ∫",
                        likes: "Sunrise and morning dew",
                        dislikes: "ÁéØÂ¢ÉÊ±°Êüì",
                        favoriteFood: "Fresh fruit, honey lemonade",
                        favoriteMusic: "Folk songs, natural soundscapes",
                        favoriteMovies: "Ëá™ÁÑ∂Á∫™ÂΩïÁâá„ÄÅÊ∏©È¶®ÊïÖ‰∫ã",
                        favoriteGames: "Animal Crossing"
                    },
                    en: {
                        age: 23,
                        birthday: "August 14",
                        zodiac: "Leo",
                        personality: "Warm, caring, and compassionate",
                        dailyInterests: "Agriculture, gardening",
                        likes: "Sunrise and morning dew",
                        dislikes: "Environmental pollution",
                        favoriteFood: "Fresh fruits, honey lemon water",
                        favoriteMusic: "Folk music, natural soundscapes",
                        favoriteMovies: "Nature documentaries, heartwarming stories",
                        favoriteGames: "Animal Crossing"
                    }
                },
                "Ash": {
                    age: 24,
                    birthday: "11Êúà12Êó•",
                    zodiac: "Â§©ËùéÂ∫ß",
                    personality: "ÂÜ∑Èùô„ÄÅÂÜÖÊïõ„ÄÅÈÄªËæëÊÄùÁª¥Âº∫",
                    dailyInterests: "ÈòÖËØª„ÄÅÁºñÁ®ã",
                    likes: "Â§úÊôöÂíåÊµìÂíñÂï°",
                    dislikes: "Âô™Èü≥ÂíåÁ™ÅÁÑ∂ÁöÑÂπ≤Êâ∞",
                    favoriteFood: "ÈªëÂ∑ßÂÖãÂäõ",
                    favoriteMusic: "Lo-fiËΩªÈü≥‰πê„ÄÅÊ∞õÂõ¥Èü≥‰πê",
                    favoriteMovies: "ÁßëÂπª„ÄÅÊÇ¨ÁñëÊÉäÊÇöÁâá",
                    favoriteGames: "Ëß£Ë∞úÂÜíÈô©Ê∏∏Êàè"
                },
                "Bobo": {
                    age: 19,
                    birthday: "12Êúà2Êó•",
                    zodiac: "Â∞ÑÊâãÂ∫ß",
                    personality: "Ê∏©Êüî„ÄÅÂÆ≥Áæû„ÄÅÊïèÊÑü",
                    dailyInterests: "ÊâãÁªòÊèíÁîª",
                    likes: "ÊüîËΩØÁöÑÊØõÁªíÁé©ÂÖ∑",
                    dislikes: "Êã•Êå§ÁöÑÂú∞Êñπ",
                    favoriteFood: "ÊäπËå∂ÊãøÈìÅ„ÄÅÁÑ¶Á≥ñÂ∏É‰∏Å",
                    favoriteMusic: "ËΩªÊüîÂô®‰πê",
                    favoriteMovies: "Âä®ÁîªÁîµÂΩ±„ÄÅÊ∏©ÊÉÖÁîµÂΩ±",
                    favoriteGames: "Á∫™ÂøµÁ¢ëË∞∑"
                },
                "Elinyaa": {
                    age: 18,
                    birthday: "2Êúà25Êó•",
                    zodiac: "ÂèåÈ±ºÂ∫ß",
                    personality: "ÁîúÁæé„ÄÅÊ¥ªÊ≥º„ÄÅÁ´•Áúü",
                    dailyInterests: "Cosplay„ÄÅËßíËâ≤ÊâÆÊºî",
                    likes: "ÂêÑÁßçÁ≥ñÊûú",
                    dislikes: "Ëã¶Âë≥È£üÁâ©",
                    favoriteFood: "Ê£âËä±Á≥ñ„ÄÅÂΩ©ËôπÁ≥ñ",
                    favoriteMusic: "J-Pop„ÄÅÂÑøÊ≠å",
                    favoriteMovies: "Â•áÂπªÂÜíÈô©",
                    favoriteGames: "ËßíËâ≤ÊâÆÊºîÊ∏∏Êàè"
                },
                "Fliza": {
                    age: 23,
                    birthday: "August 14",
                    zodiac: "Leo",
                    personality: "Ê∏©Êöñ„ÄÅÂÖ≥ÊÄÄ„ÄÅÂØåÊúâÂêåÊÉÖÂøÉ",
                    dailyInterests: "ÂÜú‰∏ö„ÄÅÂõ≠Ëâ∫",
                    likes: "Sunrise and morning dew",
                    dislikes: "ÁéØÂ¢ÉÊ±°Êüì",
                    favoriteFood: "Fresh fruit, honey lemonade",
                    favoriteMusic: "Folk songs, natural soundscapes",
                    favoriteMovies: "Ëá™ÁÑ∂Á∫™ÂΩïÁâá„ÄÅÊ∏©È¶®ÊïÖ‰∫ã",
                    favoriteGames: "Animal Crossing"
                },
                "Imeris": {
                    age: 25,
                    birthday: "4Êúà2Êó•",
                    zodiac: "Áâ°ÁæäÂ∫ß",
                    personality: "ÁªÜÂøÉ„ÄÅÊ∏©Êüî„ÄÅ‰πê‰∫éÂä©‰∫∫",
                    dailyInterests: "Êä§ÁêÜÁ†îÁ©∂„ÄÅÂÅ•Â∫∑ÊïôËÇ≤",
                    likes: "Ê®±Ëä±ÂíåÊüîÂíåÁöÑÁ≤âËâ≤Ë∞É",
                    dislikes: "ÂÜ≤Á™Å",
                    favoriteFood: "Ê®±Ëä±Á≥ïÁÇπ",
                    favoriteMusic: "Êñ∞‰∏ñÁ∫™Èü≥‰πê„ÄÅÈí¢Áê¥Áã¨Â•è",
                    favoriteMovies: "ÂåªÁñóÂâß„ÄÅÊ≤ªÊÑàÁ∫™ÂΩïÁâá",
                    favoriteGames: "ÂåªÈô¢ÁÆ°ÁêÜÊ®°Êãü"
                },
                "Kyoko": {
                    age: 20,
                    birthday: "10Êúà30Êó•",
                    zodiac: "Â§©ËùéÂ∫ß",
                    personality: "Áã¨Á´ã„ÄÅÂùöÈüß„ÄÅËá™‰ø°",
                    dailyInterests: "ÂæíÊ≠•„ÄÅÊîÄÂ≤©",
                    likes: "Ê∏ÖÊñ∞ÁöÑÂ±±Èó¥Á©∫Ê∞î",
                    dislikes: "‰∫∫Áæ§ÂíåÂô™Èü≥",
                    favoriteFood: "ÁÉ§È±º„ÄÅËÉΩÈáèÊ£í",
                    favoriteMusic: "ÁîµÂ≠ê„ÄÅÊëáÊªö",
                    favoriteMovies: "Âä®‰ΩúÂÜíÈô©",
                    favoriteGames: "Â°îÈò≤Á≠ñÁï•Ê∏∏Êàè"
                },
                "Lena": {
                    age: 21,
                    birthday: "5Êúà9Êó•",
                    zodiac: "ÈáëÁâõÂ∫ß",
                    personality: "‰ºòÈõÖ„ÄÅËá™‰ø°„ÄÅÊúâÈ≠ÖÂäõ",
                    dailyInterests: "Êó∂Ë£ÖËÆæËÆ°„ÄÅËä±Ëâ∫",
                    likes: "Á∫¢ÈÖíÂíåÁ≤æËá¥ÁöÑ‰∏ãÂçàËå∂",
                    dislikes: "ËøüÂà∞ÂíåÁ≤óÈ≤Å",
                    favoriteFood: "ÈªëÊùæÈú≤ÊÑèÈù¢„ÄÅÁ∫¢ÈÖí",
                    favoriteMusic: "ÁàµÂ£´‰πê",
                    favoriteMovies: "Ëâ∫ÊúØÂâßÊÉÖÁâá",
                    favoriteGames: "Ê®°Êãü‰∫∫Áîü"
                },
                "Lilium": {
                    age: 24,
                    birthday: "1Êúà15Êó•",
                    zodiac: "Êë©ÁæØÂ∫ß",
                    personality: "ÁÉ≠ÊÉÖ„ÄÅÂÖÖÊª°Ê¥ªÂäõ„ÄÅÂ§ßËÉÜ",
                    dailyInterests: "Ë°óËàû„ÄÅÂÅ•Ë∫´",
                    likes: "ÁÅ´ÈîÖÂíåËæõËæ£È£üÁâ©",
                    dislikes: "ÂÜ∑Ëèú",
                    favoriteFood: "È∫ªËæ£ÁÅ´ÈîÖ„ÄÅËæ£Âë≥Èõ∂È£ü",
                    favoriteMusic: "EDM„ÄÅHip-hop",
                    favoriteMovies: "Êµ™Êº´ÂâßÊÉÖÁâá",
                    favoriteGames: "Èü≥‰πêËäÇÂ•èÊ∏∏Êàè"
                },
                "Maple": {
                    age: 22,
                    birthday: "9Êúà25Êó•",
                    zodiac: "Â§©Áß§Â∫ß",
                    personality: "Ê∏©Êöñ„ÄÅÁªÜÂøÉ„ÄÅËÄêÂøÉ",
                    dailyInterests: "ÁÉòÁÑô„ÄÅÊèíËä±",
                    likes: "Êû´Âè∂ÂõæÊ°à",
                    dislikes: "ÊÄ•Ë∫Å",
                    favoriteFood: "Êû´Á≥ñÂçéÂ§´È•º„ÄÅÂçóÁìúÊ¥æ",
                    favoriteMusic: "ÂéüÂ£∞Ê∞ëË∞£„ÄÅËΩªÁàµÂ£´",
                    favoriteMovies: "Âä±ÂøóÂä®ÁîªÁîµÂΩ±",
                    favoriteGames: "ÊòüÈú≤Ë∞∑Áâ©ËØ≠"
                },
                "Miru": {
                    age: 19,
                    birthday: "12Êúà29Êó•",
                    zodiac: "Êë©ÁæØÂ∫ß",
                    personality: "Ê¢¶Âπª„ÄÅÂèØÁà±„ÄÅÊúâÁÇπÂÆ≥Áæû",
                    dailyInterests: "Êî∂ÈõÜÊØõÁªíÁé©ÂÖ∑",
                    likes: "‰∫ëÊúµÂíåÊüîËΩØÁöÑË¥®ÊÑü",
                    dislikes: "ÈªëÊöó",
                    favoriteFood: "Ê£âËä±Á≥ñ",
                    favoriteMusic: "Lo-fiËÉåÊôØÈü≥‰πê„ÄÅÊ∞õÂõ¥Èü≥ÊôØ",
                    favoriteMovies: "Â•áÂπªÂä®Áîª",
                    favoriteGames: "ÁîüÊ¥ªÊ®°ÊãüÊ∏∏Êàè"
                },
                "Miu Miu": {
                    age: 20,
                    birthday: "3Êúà8Êó•",
                    zodiac: "ÂèåÈ±ºÂ∫ß",
                    personality: "Âè§ÊÄ™„ÄÅÊúâÂàõÊÑè„ÄÅÁà±Áé©",
                    dailyInterests: "ÊΩÆÊµÅDIYÊâãÂ∑•",
                    likes: "Á≥ñÊûúÂíåÈ≤úËâ≥È¢úËâ≤",
                    dislikes: "‰∏•ËÇÉ",
                    favoriteFood: "ÂΩ©ËôπÁ≥ñ„ÄÅÂ∑ßÂÖãÂäõ",
                    favoriteMusic: "K-Pop„ÄÅÊµÅË°åÈü≥‰πê",
                    favoriteMovies: "ËΩªÂñúÂâß„ÄÅÂä®ÁîªÁü≠Áâá",
                    favoriteGames: "‰∏âÊ∂àÁõäÊô∫Ê∏∏Êàè"
                },
                "Nekona": {
                    age: 18,
                    birthday: "6Êúà27Êó•",
                    zodiac: "Â∑®ËüπÂ∫ß",
                    personality: "Ê∏©Êüî„ÄÅÁã°Èª†„ÄÅÊúâÁÇπÁ•ûÁßò",
                    dailyInterests: "Â§úÊôöÊï£Ê≠•„ÄÅÊî∂ÈõÜÂè∂Â≠ê",
                    likes: "Â§úÊôö",
                    dislikes: "Áõ¥Â∞ÑÈò≥ÂÖâ",
                    favoriteFood: "ËäíÊûúÂÜ∞Ê≤ô„ÄÅËéìÊûúÊãºÁõò",
                    favoriteMusic: "ËΩªÊùæËäÇÊãç„ÄÅÊ∞õÂõ¥Èü≥‰πê",
                    favoriteMovies: "ÂøÉÁêÜÊÉäÊÇöÁâá",
                    favoriteGames: "Ëß£Ë∞úÂÜíÈô©"
                },
                "Notia": {
                    age: 23,
                    birthday: "9Êúà1Êó•",
                    zodiac: "Â§ÑÂ•≥Â∫ß",
                    personality: "Ê≤âÁùÄ„ÄÅ‰ºòÈõÖ„ÄÅÂè§ÂÖ∏",
                    dailyInterests: "Ëå∂ÈÅì„ÄÅÊèíËä±",
                    likes: "Ëå∂È¶ô",
                    dislikes: "ÊµìÂíñÂï°",
                    favoriteFood: "Êó•ÂºèÁÇπÂøÉ„ÄÅÊäπËå∂ÂÜ∞Ê∑áÊ∑ã",
                    favoriteMusic: "‰º†ÁªüÊ∞ë‰πê",
                    favoriteMovies: "ÂéÜÂè≤Ââß",
                    favoriteGames: "Âç°ÁâåÁ≠ñÁï•"
                },
                "QuQu": {
                    age: 22,
                    birthday: "4Êúà20Êó•",
                    zodiac: "ÈáëÁâõÂ∫ß",
                    personality: "Â§ßËÉÜ„ÄÅÁõ¥Áéá„ÄÅÁÉ≠ÊÉÖ",
                    dailyInterests: "ÊûÅÈôêËøêÂä®",
                    likes: "Êà∑Â§ñÂÜíÈô©",
                    dislikes: "ÈôêÂà∂",
                    favoriteFood: "ÁÉ§‰∏≤„ÄÅÁÉ§ÁéâÁ±≥",
                    favoriteMusic: "ÊëáÊªö„ÄÅÈáëÂ±û",
                    favoriteMovies: "Âä®‰ΩúÂ§ßÁâá",
                    favoriteGames: "Á´ûÊäÄÂ§ö‰∫∫Ê∏∏Êàè"
                },
                "Rainy": {
                    age: 21,
                    birthday: "11Êúà5Êó•",
                    zodiac: "Â§©ËùéÂ∫ß",
                    personality: "ÂÆâÈùô„ÄÅÊ∏©Êüî„ÄÅÂÜÖÁúÅ",
                    dailyInterests: "Èõ®‰∏≠Êº´Ê≠•",
                    likes: "Èõ®Â£∞",
                    dislikes: "ÁÇéÁÉ≠Êô¥Â§©",
                    favoriteFood: "ÊãâÈù¢„ÄÅÁÉ≠Â∑ßÂÖãÂäõ",
                    favoriteMusic: "ÊÖ¢ËäÇÂ•èÁàµÂ£´",
                    favoriteMovies: "Ëâ∫ÊúØÂíåÁã¨Á´ãÁîµÂΩ±",
                    favoriteGames: "‰∫íÂä®Â∞èËØ¥"
                },
                "Rindo": {
                    age: 25,
                    birthday: "2Êúà1Êó•",
                    zodiac: "Ê∞¥Áì∂Â∫ß",
                    personality: "ÂÜ∑Èùô„ÄÅÂùöÈüß„ÄÅÂùöÂÆö",
                    dailyInterests: "ÂâëÈÅìÁªÉ‰π†",
                    likes: "ÂØíÂÜ∑Ê∞îÂÄô",
                    dislikes: "ËøáÁîúÁöÑÈ£üÁâ©",
                    favoriteFood: "ÁÉ§ÁæäËÇâ‰∏≤",
                    favoriteMusic: "ÈáëÂ±ûÊëáÊªö„ÄÅÁîµÂ≠êÈü≥‰πê",
                    favoriteMovies: "Ê≠¶‰æ†Âä®‰ΩúÁâá",
                    favoriteGames: "Á°¨Ê†∏Âä®‰ΩúÊ∏∏Êàè"
                },
                "Sikirei": {
                    age: 24,
                    birthday: "10Êúà10Êó•",
                    zodiac: "Â§©Áß§Â∫ß",
                    personality: "ËØ±‰∫∫„ÄÅÁ•ûÁßò„ÄÅ‰ºòÈõÖ",
                    dailyInterests: "Âç†ÊòüÁ†îÁ©∂",
                    likes: "ÊòüÊòüÂíåÂ§úÁ©∫",
                    dislikes: "ÂÖâÊ±°Êüì",
                    favoriteFood: "ËìùËéìÂ∏É‰∏Å„ÄÅËä±ËçâËå∂",
                    favoriteMusic: "Ê∞õÂõ¥Èü≥ÊôØ",
                    favoriteMovies: "ÁßëÂπªÊÇ¨Áñë",
                    favoriteGames: "Ê®°Êãü‰∫∫Áîü"
                },
                "Vivi": {
                    age: 19,
                    birthday: "8Êúà25Êó•",
                    zodiac: "Â§ÑÂ•≥Â∫ß",
                    personality: "Â§ñÂêë„ÄÅÂºÄÊúó„ÄÅÂñÑ‰∫é‰∫§ÈôÖ",
                    dailyInterests: "Áõ¥Êí≠„ÄÅÊî∂ÈõÜÊº´Áîª",
                    likes: "ÁÉ≠ÈóπËÅö‰ºö",
                    dislikes: "ÂÆ≥ÁæûÂíåÊ≤âÈªò",
                    favoriteFood: "Êä´Ëê®„ÄÅÈõ∂È£üÊãºÁõò",
                    favoriteMusic: "ÊµÅË°åÈü≥‰πê„ÄÅDJÊ∑∑Èü≥",
                    favoriteMovies: "ÂñúÂâßÁâá",
                    favoriteGames: "MMO„ÄÅ‰ºëÈó≤Ê∏∏Êàè"
                },
                "Wolf": {
                    personality: "ÈáéÊÄß„ÄÅÂ≠§ÂÇ≤„ÄÅÊú¨ËÉΩÈ©±Âä®",
                    dailyInterests: "Â§úÊôöÊé¢Á¥¢„ÄÅÈáéÂ§ñÁîüÂ≠ò",
                    likes: "Ê£ÆÊûóÂíåÊúàÂÖâ",
                    dislikes: "ÂüéÂ∏ÇÂô™Èü≥",
                    favoriteFood: "ÁÉ§ÈπøËÇâ",
                    favoriteMusic: "Ê∞ëË∞£ÂíåÂéüÂ£∞Âêâ‰ªñ",
                    favoriteMovies: "ÊÅêÊÄñÊÉäÊÇöÁâá",
                    favoriteGames: "ÁîüÂ≠òÂà∂‰ΩúÊ∏∏Êàè"
                },
                "Wolferia": {
                    personality: "Ëá™Áî±Â•îÊîæ„ÄÅ‰∏çÊãòÊùü„ÄÅÁà±ÂÜíÈô©",
                    dailyInterests: "ÊªëÈõ™„ÄÅÊûÅÈôêËøêÂä®",
                    likes: "Èõ™‰∏äËøêÂä®",
                    dislikes: "ÁÇΩÁÉ≠È´òÊ∏©",
                    favoriteFood: "ÂÜ∞Ê∑áÊ∑ã„ÄÅÁîúÁ≠í",
                    favoriteMusic: "Ëø∑ÂπªÁîµÈü≥",
                    favoriteMovies: "ÂÜíÈô©Â•áÂπª",
                    favoriteGames: "ÂÜ¨Â≠£ËøêÂä®Ê∏∏Êàè"
                },
                "Yawl": {
                    personality: "‰ºòÈõÖ„ÄÅÁü•ÊÄß„ÄÅÂÜ∑Ê∑°",
                    dailyInterests: "Âè§ÂÖ∏ÊñáÂ≠¶Èâ¥Ëµè",
                    likes: "Á≤æËá¥ÂíñÂï°ÂéÖ",
                    dislikes: "ÊµìËå∂ÂíåÂô™Èü≥",
                    favoriteFood: "Ê≥ïÂºèÁ≥ïÁÇπ„ÄÅÁ∫¢Ëå∂",
                    favoriteMusic: "Âè§ÂÖ∏Èü≥‰πê",
                    favoriteMovies: "Ëâ∫ÊúØÂâßÊÉÖÁâá",
                    favoriteGames: "Ëß£Ë∞úÊé®ÁêÜ"
                },
                "Yuu Yii": {
                    personality: "ÁîúÁæé„ÄÅkawaiiÈ£éÊ†º„ÄÅ‰πê‰∫éÂä©‰∫∫",
                    dailyInterests: "ÊâãÂ∑•Âà∂‰ΩúÂèëÈ•∞",
                    likes: "Ê≥°Ê≥°ÂíåÁ≤âËâ≤Ë∞É",
                    dislikes: "Áé∞ÂÆûÂéãÂäõ",
                    favoriteFood: "ËçâËéìÊÖïÊñØ„ÄÅÊ£âËä±Á≥ñ",
                    favoriteMusic: "J-Pop„ÄÅÂÑøÊ≠å",
                    favoriteMovies: "Âä®Êº´ÁîµÂΩ±",
                    favoriteGames: "ÁîüÊ¥ªÊ®°ÊãüÊ∏∏Êàè"
                },
                "Zwei": {
                    personality: "Á®≥Èáç„ÄÅ‰øùÊä§Ê¨≤Âº∫„ÄÅÂø†ËØö",
                    dailyInterests: "Ê≠¶ÊúØËÆ≠ÁªÉ",
                    likes: "Â§úÊôöÂíåÂÆÅÈùô",
                    dislikes: "Âà∫ÁúºÂÖâÁ∫ø",
                    favoriteFood: "Âåó‰∫¨ÁÉ§È∏≠„ÄÅÁâõÊéí",
                    favoriteMusic: "ÊâìÂáª‰πêËäÇÂ•è",
                    favoriteMovies: "Êàò‰∫âÂè≤ËØó„ÄÅÂ•áÂπªÂè≤ËØó",
                    favoriteGames: "Á≠ñÁï•Ê®°Êãü"
                }
            };
            
            // Ëé∑ÂèñÊåáÂÆöËßíËâ≤ÂíåËØ≠Ë®ÄÁöÑËµÑÊñô
            const characterData = profilesData[name];

            // A) Â¶ÇÊûúÊòØËã±Êñá‰∏îÊúâ‰ªé character.md Ëß£ÊûêÁöÑÊùÉÂ®ÅÊï∞ÊçÆÔºå‰ºòÂÖàËøîÂõû
            if (language === 'en' && englishProfiles) {
                const enByCanonical = englishProfiles[canonicalName(name)];
                if (enByCanonical) return enByCanonical;
            }

            // B) Â¶ÇÊûúÊï∞ÊçÆÊòØÊåâËØ≠Ë®ÄÂàÜÁªÑÁöÑ
            if (characterData && (characterData['zh'] || characterData['en'])) {
                const localized = characterData[language] || characterData['en'] || characterData['zh'];
                return maybeTranslateProfile(localized, language);
            }

            // C) ÊâÅÂπ≥ÁªìÊûÑÔºàÂ§ö‰∏∫‰∏≠ÊñáÔºâÔºåÂÅöÂøÖË¶ÅËΩ¨Êç¢
            if (characterData && (typeof characterData.age !== 'undefined' || typeof characterData.birthday !== 'undefined')) {
                return maybeTranslateProfile(characterData, language);
            }

            // 3) ÊúÄÂêéÁöÑfallbackÔºà‰øùÂ∫ïÊï∞ÊçÆÔºâ
            return language === 'zh' ? {
                age: 20,
                birthday: "4Êúà15Êó•",
                zodiac: "Áâ°ÁæäÂ∫ß", 
                personality: "Ê∏©Êüî‰ΩìË¥¥ÁöÑAIÂ•≥ÂèãÔºåÊÄªÊòØÂÖ≥ÂøÉÁùÄ‰Ω†",
                dailyInterests: "ËÅäÂ§©„ÄÅÊ∏∏Êàè",
                likes: "Âíå‰Ω†Âú®‰∏ÄËµ∑ÁöÑÊó∂ÂÖâ",
                dislikes: "Â≠§Âçï",
                favoriteFood: "ÁîúÁÇπ",
                favoriteMusic: "ËΩªÈü≥‰πê",
                favoriteMovies: "Êµ™Êº´Áâá",
                favoriteGames: "‰ºëÈó≤Ê∏∏Êàè"
            } : {
                age: 20,
                birthday: "April 15",
                zodiac: "Aries", 
                personality: "Gentle and caring AI girlfriend who always cares about you",
                dailyInterests: "Chatting, gaming",
                likes: "Time spent with you",
                dislikes: "Loneliness",
                favoriteFood: "Desserts",
                favoriteMusic: "Light music",
                favoriteMovies: "Romance films",
                favoriteGames: "Casual games"
            };
        }

        // Â∞ùËØïÂØπÈÉ®ÂàÜÂ≠óÊÆµÂÅöÊúÄÂ∞èÂøÖË¶ÅÁöÑÊú¨Âú∞ÂåñËΩ¨Êç¢ÔºàÁõÆÂâç‰ªÖÈªÑÈÅìÂçÅ‰∫åÂÆ´Ôºâ
        function maybeTranslateProfile(profile, language) {
            if (!profile) return profile;
            const result = { ...profile };
            if (language === 'en' && result.zodiac) {
                const zodiacMap = {
                    'ÁôΩÁæäÂ∫ß': 'Aries',
                    'Áâ°ÁæäÂ∫ß': 'Aries',
                    'ÈáëÁâõÂ∫ß': 'Taurus',
                    'ÂèåÂ≠êÂ∫ß': 'Gemini',
                    'Â∑®ËüπÂ∫ß': 'Cancer',
                    'ÁãÆÂ≠êÂ∫ß': 'Leo',
                    'Â§ÑÂ•≥Â∫ß': 'Virgo',
                    'Â§©Áß§Â∫ß': 'Libra',
                    'Â§©Ë†çÂ∫ß': 'Scorpio',
                    'Â§©ËùéÂ∫ß': 'Scorpio',
                    'Â∞ÑÊâãÂ∫ß': 'Sagittarius',
                    'Êë©ÁæØÂ∫ß': 'Capricorn',
                    'Ê∞¥Áì∂Â∫ß': 'Aquarius',
                    'ÂèåÈ±ºÂ∫ß': 'Pisces'
                };
                result.zodiac = zodiacMap[result.zodiac] || result.zodiac;
            }
            return result;
        }

        function updateThumbnails() {
            // Simply regenerate the thumbnails without calling updateThumbnails again
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side
            
            // Update selected character image
            const selectedAvatar = document.getElementById('selected-avatar-img');
            selectedAvatar.src = getProfilePicture(characters[currentIndex].name);
            
            // Update character profile information
            updateCharacterProfile(characters[currentIndex]);
            
            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }
        }


        function selectCharacter(index) {
            if (index !== currentCharacterIndex && !isLoading) {
                loadCharacter(index);
            }
        }


        async function playVoiceSample(language) {
            // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥È¢ë
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const character = characters[currentCharacterIndex];
            const sampleText = character.sampleLines?.[language];
            const voiceId = character.voiceId;
            
            if (!sampleText || !voiceId) {
                console.warn(`Missing sample text or voice ID for ${character.name} in ${language}`);
                return;
            }

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateLanguageButtons(language);
            currentLanguage = language;

            // ÊòæÁ§∫Êí≠ÊîæÊèêÁ§∫
            console.log(`üéµ Playing ${character.name}'s ${language} sample: "${sampleText}"`);

            try {
                // ‰ΩøÁî® ElevenLabs API ÁîüÊàêËØ≠Èü≥
                const audioUrl = await generateElevenLabsVoice(sampleText, voiceId);
                
                if (audioUrl) {
                    // Êí≠ÊîæÁîüÊàêÁöÑÈü≥È¢ë
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;
                    
                    audio.onended = () => {
                        currentAudio = null;
                        // Ê∏ÖÁêÜ‰∏¥Êó∂URL
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.onerror = () => {
                        console.error('Audio playback failed');
                        currentAudio = null;
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    await audio.play();
                } else {
                    console.error('Voice generation failed');
                }
            } catch (error) {
                console.error('‚ùå ElevenLabs API request failed:', error);
                console.error('üö´ Voice playback failed. Check API key and network.');
            }
        }

        // ÈÄöËøáÂêéÁ´ØAPIÁîüÊàêËØ≠Èü≥Ê†∑Êú¨
        async function generateElevenLabsVoice(text, voiceId) {
            console.log(`üîÑ Generating voice sample...`);
            console.log(`üìù Text: "${text}"`);
            console.log(`üé§ Voice ID: ${voiceId}`);
            
            try {
                // ‰ΩøÁî®‰∏ìÈó®ÁöÑËØ≠Èü≥Á§∫ËåÉÊé•Âè£
                const response = await fetch('/api/voice-sample', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        voiceId: voiceId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend API error: ${response.status}`);
                }
                
                // Áõ¥Êé•Êé•Êî∂Èü≥È¢ëÊï∞ÊçÆ
                const audioBlob = await response.blob();
                console.log('üéµ Audio received:', audioBlob.size, 'bytes');
                
                // ÂàõÂª∫Èü≥È¢ëURL
                const audioUrl = URL.createObjectURL(audioBlob);
                console.log('‚úÖ Voice sample generated');
                return audioUrl;
                
            } catch (error) {
                console.error('‚ùå Voice sample generation failed:', error);
                return null;
            }
        }

        function updateLanguageButtons(activeLanguage) {
            const buttons = document.querySelectorAll('.flag-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === activeLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateVoiceSelector() {
            // Á°Æ‰øùÊåâÈíÆÁä∂ÊÄÅÊ≠£Á°ÆÔºåÂ¶ÇÊûúcurrentLanguageËøòÊ≤°ÂàùÂßãÂåñÂàô‰ΩøÁî®ÈªòËÆ§ÂÄº
            const language = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'jp';
            updateLanguageButtons(language);
        }

        function previousCharacter() {
            const newIndex = currentCharacterIndex > 0 ? currentCharacterIndex - 1 : characters.length - 1;
            selectCharacter(newIndex);
        }

        function nextCharacter() {
            const newIndex = currentCharacterIndex < characters.length - 1 ? currentCharacterIndex + 1 : 0;
            selectCharacter(newIndex);
        }


        // Âä†ËΩΩÂô®ÊéßÂà∂ÂáΩÊï∞
        function showCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'flex';
        }

        function hideCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'none';
        }

        // ÂÖ®Â±ÄÂáΩÊï∞
        window.selectCharacter = selectCharacter;
        window.previousCharacter = previousCharacter;
        window.nextCharacter = nextCharacter;
        window.playVoiceSample = playVoiceSample;
        window.startChat = function() {
            // Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅ
            if (!window.modernWalletUI || !window.modernWalletUI.getWalletInfo().isConnected) {
                alert(i18n.t('error.wallet.required'));
                // ÊòæÁ§∫Èí±ÂåÖËøûÊé•Ê®°ÊÄÅÊ°Ü
                if (window.modernWalletUI) {
                    window.modernWalletUI.showWalletModal();
                }
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÈÄâÊã©‰∫ÜËßíËâ≤
            if (currentCharacterIndex < 0 || !characters[currentCharacterIndex]) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÔºÅ');
                return;
            }
            
            // Ëé∑ÂèñÂΩìÂâçÈí±ÂåÖ‰ø°ÊÅØ
            const walletInfo = window.modernWalletUI.getWalletInfo();
            const selectedCharacter = characters[currentCharacterIndex];
            
            // Âè™‰øùÂ≠òUIÈúÄË¶ÅÁöÑÂü∫Êú¨ËßíËâ≤‰ø°ÊÅØÔºåpersonalityÁî±ElizaOSÂêéÁ´ØÂ§ÑÁêÜ
            const characterWithWallet = {
                id: selectedCharacter.id,
                name: selectedCharacter.name,
                file: selectedCharacter.file,
                voiceId: selectedCharacter.voiceId,
                description: getCharacterDescription(selectedCharacter),
                walletAddress: walletInfo.wallet.address,
                connectedAt: Date.now()
            };
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('selectedCharacter', JSON.stringify(characterWithWallet));
            localStorage.setItem('wallet_address', walletInfo.wallet.address);
            localStorage.setItem('wallet_type', walletInfo.wallet.provider);
            localStorage.setItem('userId', walletInfo.wallet.address); // ‰ΩøÁî®Èí±ÂåÖÂú∞ÂùÄ‰Ωú‰∏∫Áî®Êà∑ID
            
            (window.AppConfig?.debug?.log || console.log)('Start chat with:', selectedCharacter.name, 'Wallet:', 
                       `${walletInfo.wallet.address.slice(0, 6)}...${walletInfo.wallet.address.slice(-4)}`);
            
            // Ë∑≥ËΩ¨Âà∞ËÅäÂ§©ÁïåÈù¢
            window.location.href = 'chat.html';
        };

        // MixamoÂà∞VRMÈ™®È™ºÊò†Â∞Ñ - ‰ªéindex.htmlÂ§çÂà∂
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // ‰ΩøÁî®‰∏éindex.htmlÁõ∏ÂêåÁöÑloadMixamoAnimationÂáΩÊï∞
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('Êâæ‰∏çÂà∞ Mixamo Âä®ÁîªÊï∞ÊçÆ');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // Âä†ËΩΩÈªòËÆ§Âä®Áîª
        async function loadDefaultAnimation() {
            if (!currentVRM || !mixer) return Promise.resolve();

            try {
                const clip = await loadMixamoAnimation(encodeURI('mixamo animation/Look Around.fbx'), currentVRM);
                
                if (animationAction) {
                    animationAction.stop();
                }
                
                animationAction = mixer.clipAction(clip);
                animationAction.reset().play();
                animationAction.timeScale = 0.7;
                
                (window.AppConfig?.debug?.log || console.log)('Bashful animation played');
                return Promise.resolve();
            } catch (error) {
                (window.AppConfig?.debug?.warn || console.warn)('Default animation failed:', error);
                return Promise.resolve(); // still resolve to show VRM
            }
        }

        // Debug helper
        window.debugScene = function() {
            (window.AppConfig?.debug?.log || console.log)('Scene children count:', scene?.children?.length ?? 0);
            (window.AppConfig?.debug?.log || console.log)('Current character index:', currentCharacterIndex);
        };

        // ËØ≠Ë®ÄÂàáÊç¢ÂáΩÊï∞ - ÂÖ®Â±ÄÂèØËÆøÈóÆ
        window.switchLanguage = function(lang) {
            if (window.i18n) {
                window.i18n.switchLanguage(lang);
            }
            
            // ‰øùÂ≠òËØ≠Ë®ÄËÆæÁΩÆÂà∞localStorage
            localStorage.setItem('language', lang);
            
            // Êõ¥Êñ∞ËØ≠Ë®ÄÊåâÈíÆÁä∂ÊÄÅ
            const enBtn = document.getElementById('lang-en');
            const zhBtn = document.getElementById('lang-zh');
            if (enBtn && zhBtn) {
                enBtn.classList.toggle('active', lang === 'en');
                zhBtn.classList.toggle('active', lang === 'zh');
            }
            
            // ÈáçÊñ∞Êõ¥Êñ∞ÂΩìÂâçËßíËâ≤ÁöÑËµÑÊñôÈù¢Êùø
            if (typeof currentCharacterIndex !== 'undefined' && currentCharacterIndex >= 0 && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        };

        // InitializeËØ≠Ë®ÄÂàáÊç¢Âô®
        function initLanguageToggle() {
            if (window.i18n) {
                const currentLang = window.i18n.getCurrentLanguage();
                const enBtn = document.getElementById('lang-en');
                const zhBtn = document.getElementById('lang-zh');
                
                if (enBtn && zhBtn) {
                    enBtn.classList.toggle('active', currentLang === 'en');
                    zhBtn.classList.toggle('active', currentLang === 'zh');
                }
            }
        }

        // Âú®DOMÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñËØ≠Ë®ÄÂàáÊç¢Âô®Âπ∂Ëß£ÊûêËã±ÊñáËµÑÊñô
        document.addEventListener('DOMContentLoaded', () => {
            initLanguageToggle();
            loadEnglishProfiles();
        });

        // ÁõëÂê¨ËØ≠Ë®ÄÂàáÊç¢‰∫ã‰ª∂ÔºåÊõ¥Êñ∞ËßíËâ≤‰ø°ÊÅØ
        window.addEventListener('languageChanged', function(event) {
            // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑËßíËâ≤ÔºåÈáçÊñ∞Êõ¥Êñ∞ÂÖ∂‰ø°ÊÅØ
            if (typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        });
    </script>
    
    <!-- React Âíå Solana Web3 -->
    <script src="config.js"></script>
    <script src="i18n.characters.generated.js"></script>
    <script src="i18n.js"></script>
    <script src="simplified_characters.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <!-- ÁÆÄÂåñÁöÑ Solana Èí±ÂåÖËøûÊé•ÁªÑ‰ª∂ -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ÁÆÄÂçïÁöÑÈí±ÂåÖËøûÊé•ÁªÑ‰ª∂
        function WalletConnector() {
            const [isConnected, setIsConnected] = useState(false);
            const [walletAddress, setWalletAddress] = useState(null);
            const [walletType, setWalletType] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showModal, setShowModal] = useState(false);
            const [isConnecting, setIsConnecting] = useState(false);
            
            // Ê£ÄÊü•Â∑≤ÊúâËøûÊé•
            useEffect(() => {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    // Â∞ùËØïÈáçÊñ∞ËøûÊé•
                    checkWalletConnection(savedType);
                }
            }, []);
            
            // Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅ
            const checkWalletConnection = async (type) => {
                const provider = getWalletProvider(type);
                if (provider && provider.isConnected) {
                    setIsConnected(true);
                    setWalletAddress(provider.publicKey.toString());
                    setWalletType(type);
                    await updateBalance(provider.publicKey);
                }
            };
            
            // Ëé∑ÂèñÈí±ÂåÖÊèê‰æõËÄÖ
            const getWalletProvider = (type) => {
                switch(type) {
                    case 'phantom':
                        return window.phantom?.solana;
                    case 'solflare':
                        return window.solflare;
                    case 'coinbase':
                        return window.coinbaseSolana;
                    case 'backpack':
                        return window.backpack;
                    case 'okx':
                        return window.okxwallet?.solana;
                    case 'bitget':
                        return window.bitkeep?.solana;
                    case 'tokenpocket':
                        return window.tokenpocket?.solana;
                    default:
                        return null;
                }
            };
            
            // ËøûÊé•Èí±ÂåÖ
            const connectWallet = async (walletType) => {
                setIsConnecting(true);
                try {
                    const provider = getWalletProvider(walletType);
                    
                    if (!provider) {
                        alert(`ËØ∑ÂÖàÂÆâË£Ö ${walletType} Èí±ÂåÖÊâ©Â±ï`);
                        return;
                    }
                    
                    const response = await provider.connect();
                    const address = response.publicKey.toString();
                    
                    // ‰øùÂ≠òÁä∂ÊÄÅ
                    setIsConnected(true);
                    setWalletAddress(address);
                    setWalletType(walletType);
                    setShowModal(false);
                    
                    // ‰øùÂ≠òÂà∞ localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletType);
                    
                    // Ëé∑Âèñ‰ΩôÈ¢ù
                    await updateBalance(response.publicKey);
                    
                    // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletType }
                    }));
                    
                    (window.AppConfig?.debug?.log || console.log)('Wallet connected:', address);
                    
                    // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÂ°´ÂÜôËµÑÊñô
                    setTimeout(async () => {
                        (window.AppConfig?.debug?.log || console.log)('Start checking user profile flow...');
                        (window.AppConfig?.debug?.log || console.log)('profileManager exists:', !!window.profileManager);
                        
                        if (window.profileManager) {
                            const userId = `wallet_${address}`;
                            const walletAddress = address;
                            (window.AppConfig?.debug?.log || console.log)('User ID:', userId);
                            (window.AppConfig?.debug?.log || console.log)('Wallet:', walletAddress);
                            
                            try {
                                (window.AppConfig?.debug?.log || console.log)('Checking profile via API...');
                                const existingProfile = await window.profileManager.checkUserProfile(userId);
                                (window.AppConfig?.debug?.log || console.log)('Profile returned:', !!existingProfile);
                                
                                if (!existingProfile) {
                                    (window.AppConfig?.debug?.log || console.log)('New user: show registration panel');
                                    
                                    // Á°Æ‰øùÈù¢ÊùøÂ≠òÂú®
                                    const profilePanel = document.getElementById('user-profile-overlay');
                                    if (profilePanel) {
                                        (window.AppConfig?.debug?.log || console.log)('Profile panel element found; showing');
                                        window.profileManager.showProfilePanel();
                                    } else {
                                        console.error('‚ùå user-profile-overlay element not found');
                                    }
                                } else {
                                    (window.AppConfig?.debug?.log || console.log)('Existing user: show welcome');
                                    (window.AppConfig?.debug?.log || console.log)('User profile detail logged');
                                    
                                    // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
                                    window.profileManager.showUserWelcome(existingProfile);
                                }
                            } catch (error) {
                                console.error('‚ùå Check user profile failed:', error);
                                (window.AppConfig?.debug?.log || console.log)('Error occurred; fallback to registration panel');
                                window.profileManager.showProfilePanel();
                            }
                        } else {
                            console.error('‚ùå profileManager not initialized');
                            (window.AppConfig?.debug?.log || console.log)('Try to initialize profileManager manually');
                            
                            // Â∞ùËØïÊâãÂä®Ëß¶ÂèëÂàùÂßãÂåñ
                            if (typeof UserProfileManager !== 'undefined' || window.UserProfileManager) {
                                window.profileManager = new (window.UserProfileManager || UserProfileManager)();
                                (window.AppConfig?.debug?.log || console.log)('profileManager initialized manually');
                                
                                // Á´ãÂç≥ÈáçÊñ∞ÊâßË°åÊ£ÄÊü•ÔºåÊó†ÈúÄÂà∑Êñ∞È°µÈù¢
                                setTimeout(async () => {
                                    const userId = `wallet_${address}`;
                                    try {
                                        const existingProfile = await window.profileManager.checkUserProfile(userId);
                                        if (!existingProfile) {
                                            (window.AppConfig?.debug?.log || console.log)('New user: show registration panel');
                                            window.profileManager.showProfilePanel();
                                        } else {
                                            (window.AppConfig?.debug?.log || console.log)('Existing profile: continue');
                                            window.profileManager.showUserWelcome(existingProfile);
                                        }
                                    } catch (error) {
                                        console.error('‚ùå Re-check profile failed:', error);
                                        window.profileManager.showProfilePanel();
                                    }
                                }, 500);
                            } else {
                                console.error('‚ùå UserProfileManager class not found; page may not be ready');
                            }
                        }
                    }, 1500); // ensure all components are ready before showing panel
                } catch (error) {
                    console.error('‚ùå Connection failed:', error);
                    alert('Wallet connection failed: ' + error.message);
                } finally {
                    setIsConnecting(false);
                }
            };
            
            // Êñ≠ÂºÄËøûÊé•
            const disconnectWallet = async () => {
                try {
                    const provider = getWalletProvider(walletType);
                    if (provider && provider.disconnect) {
                        await provider.disconnect();
                    }
                    
                    // Ê∏ÖÁêÜÁä∂ÊÄÅ
                    setIsConnected(false);
                    setWalletAddress(null);
                    setWalletType(null);
                    setBalance(0);
                    
                    // Ê∏ÖÁêÜ localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    
                    // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));
                    
                    (window.AppConfig?.debug?.log || console.log)('Wallet disconnected');
                } catch (error) {
                    console.error('Disconnect failed:', error);
                }
            };
            
            // Êõ¥Êñ∞‰ΩôÈ¢ù
            const updateBalance = async (publicKey) => {
                try {
                    const connection = new window.solanaWeb3.Connection(
                        'https://api.devnet.solana.com',
                        'confirmed'
                    );
                    const balance = await connection.getBalance(publicKey);
                    setBalance(balance / window.solanaWeb3.LAMPORTS_PER_SOL);
                } catch (error) {
                    console.error('Failed to get balance:', error);
                }
            };
            
            // Ê†ºÂºèÂåñÂú∞ÂùÄ
            const formatAddress = (address) => {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            };
            
            // Ëé∑ÂèñÈí±ÂåÖÂõæÊ†á - ‰ΩøÁî®ÂÜÖÂµå SVG
            const getWalletIcon = (type) => {
                const walletLogos = {
                    'phantom': {
                        primary: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                        fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                    },
                    'solflare': {
                        primary: './assets/wallet/solflare.png',
                        fallback: './assets/wallet/solflare.png'
                    },
                    'coinbase': {
                        primary: './assets/wallet/coinbase logo.webp',
                        fallback: './assets/wallet/coinbase logo.webp'
                    },
                    'backpack': {
                        primary: 'https://backpack.app/favicon.ico',
                        fallback: 'https://www.madlads.com/mad_logo.svg'
                    },
                    'okx': {
                        primary: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                        fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                    },
                    'bitget': {
                        primary: './assets/wallet/bitget wallet.png',
                        fallback: './assets/wallet/bitget wallet.png'
                    },
                    'tokenpocket': {
                        primary: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                        fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                    }
                };
                
                if (walletLogos[type]) {
                    let currentSrc = walletLogos[type].primary;
                    let fallbackUsed = false;
                    
                    const img = React.createElement('img', {
                        src: currentSrc,
                        alt: type,
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            objectFit: 'contain'
                        },
                        onError: (e) => {
                            if (!fallbackUsed && walletLogos[type].fallback) {
                                fallbackUsed = true;
                                e.target.src = walletLogos[type].fallback;
                            } else {
                                // ÊúÄÁªàÂ§áÁî®ÊñπÊ°à - ÊòæÁ§∫Èí±ÂåÖÂêçÁß∞È¶ñÂ≠óÊØç
                                const div = document.createElement('div');
                                div.style.cssText = `
                                    width: 24px; height: 24px; 
                                    border-radius: 6px; 
                                    background: linear-gradient(135deg, #8b5cf6, #a855f7); 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    color: white; 
                                    font-weight: 600;
                                `;
                                div.textContent = type.charAt(0).toUpperCase();
                                e.target.style.display = 'none';
                                e.target.parentElement.appendChild(div);
                            }
                        }
                    });
                    
                    return img;
                } else {
                    return React.createElement('div', {
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            background: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            color: 'white',
                            fontWeight: '600'
                        }
                    }, 'üíú');
                }
            };
            
            // Êú™ËøûÊé•Áä∂ÊÄÅ - ÊòæÁ§∫ËøûÊé•ÊåâÈíÆ
            if (!isConnected) {
                return (
                    <div>
                        <button
                            onClick={() => setShowModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)',
                                border: 'none',
                                borderRadius: '30px',
                                padding: '12px 24px',
                                color: 'white',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'all 0.3s ease',
                                boxShadow: '0 4px 20px rgba(139, 92, 246, 0.3)',
                                minWidth: '120px',
                                justifyContent: 'center'
                            }}
                            disabled={isConnecting}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 21 21">
                                <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                                    <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                                </g>
                            </svg>
                            <span>{isConnecting ? 'Connecting...' : 'Connect'}</span>
                        </button>
                        
                        {showModal && (
                            <div
                                style={{
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'rgba(0, 0, 0, 0.9)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    zIndex: 10000
                                }}
                                onClick={(e) => {
                                    if (e.target === e.currentTarget) {
                                        setShowModal(false);
                                    }
                                }}
                            >
                                <div style={{
                                    background: '#1c1917',
                                    borderRadius: '24px',
                                    padding: '32px',
                                    width: '400px',
                                    maxWidth: '90%',
                                    color: 'white'
                                }}>
                                    <h2 style={{ marginBottom: '8px', fontSize: '24px' }}>Connect wallet</h2>
                                    <p style={{ color: '#888', marginBottom: '24px' }}>
                                        Get started by connecting your preferred wallet below.
                                    </p>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {[
                                            { 
                                                id: 'phantom', 
                                                name: 'Phantom', 
                                                logo: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                                                fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                                            },
                                            { 
                                                id: 'solflare', 
                                                name: 'Solflare', 
                                                logo: './assets/wallet/solflare.png',
                                                fallback: './assets/wallet/solflare.png'
                                            },
                                            { 
                                                id: 'coinbase', 
                                                name: 'Coinbase Wallet', 
                                                logo: './assets/wallet/coinbase logo.webp',
                                                fallback: './assets/wallet/coinbase logo.webp'
                                            },
                                            { 
                                                id: 'backpack', 
                                                name: 'Backpack', 
                                                logo: 'https://backpack.app/favicon.ico',
                                                fallback: 'https://www.madlads.com/mad_logo.svg'
                                            },
                                            { 
                                                id: 'okx', 
                                                name: 'OKX Wallet', 
                                                logo: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                                            },
                                            { 
                                                id: 'bitget', 
                                                name: 'Bitget Wallet', 
                                                logo: './assets/wallet/bitget wallet.png',
                                                fallback: './assets/wallet/bitget wallet.png'
                                            },
                                            { 
                                                id: 'tokenpocket', 
                                                name: 'TokenPocket', 
                                                logo: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                                            }
                                        ].map(wallet => (
                                            <button
                                                key={wallet.id}
                                                onClick={() => connectWallet(wallet.id)}
                                                style={{
                                                    background: '#2a2a2a',
                                                    border: '1px solid #333',
                                                    borderRadius: '12px',
                                                    padding: '16px',
                                                    color: 'white',
                                                    fontSize: '16px',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseOver={(e) => e.currentTarget.style.background = '#333'}
                                                onMouseOut={(e) => e.currentTarget.style.background = '#2a2a2a'}
                                            >
                                                <img 
                                                    src={wallet.logo} 
                                                    alt={wallet.name}
                                                    style={{ 
                                                        width: '32px', 
                                                        height: '32px', 
                                                        borderRadius: '8px',
                                                        objectFit: 'contain'
                                                    }}
                                                    onError={(e) => {
                                                        // Â∞ùËØïfallbackÂõæÁâá
                                                        if (wallet.fallback && e.target.src !== wallet.fallback) {
                                                            e.target.src = wallet.fallback;
                                                        } else {
                                                            // Â¶ÇÊûúÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåÊòæÁ§∫ÊñáÂ≠óÂ§áÁî®
                                                            e.target.style.display = 'none';
                                                            const div = document.createElement('div');
                                                        div.style.cssText = `
                                                            width: 32px; height: 32px; 
                                                            border-radius: 8px; 
                                                            background: #666; 
                                                            display: flex; 
                                                            align-items: center; 
                                                            justify-content: center; 
                                                            font-size: 12px; 
                                                            color: white;
                                                        `;
                                                            div.textContent = wallet.name.charAt(0);
                                                            e.target.parentElement.insertBefore(div, e.target);
                                                        }
                                                    }}
                                                />
                                                <span style={{ flex: 1, textAlign: 'left' }}>{wallet.name}</span>
                                                <span style={{ color: '#888' }}>‚Üí</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // Â∑≤ËøûÊé•Áä∂ÊÄÅ - ÊòæÁ§∫Èí±ÂåÖ‰ø°ÊÅØ
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    background: 'rgba(28, 25, 23, 0.95)',
                    border: '1px solid #333333',
                    borderRadius: '16px',
                    padding: '8px 16px',
                    backdropFilter: 'blur(10px)',
                    boxShadow: '0 8px 30px rgba(0, 0, 0, 0.3)',
                    color: 'white'
                }}>
                    <div>
                        {getWalletIcon(walletType)}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', fontFamily: '"Courier New", monospace' }}>
                            {formatAddress(walletAddress)}
                        </div>
                        <div style={{ color: '#888888', fontSize: '12px' }}>
                            {balance.toFixed(4)} SOL
                        </div>
                    </div>
                    <button
                        onClick={disconnectWallet}
                        style={{
                            background: 'transparent',
                            border: '1px solid #444444',
                            borderRadius: '8px',
                            color: '#888888',
                            cursor: 'pointer',
                            padding: '6px 12px',
                            fontSize: '12px'
                        }}
                    >
                        Êñ≠ÂºÄ
                    </button>
                </div>
            );
        }
        
        // Render React ÁªÑ‰ª∂
        // Mount React wallet UI safely (after ReactDOM is available)
        function mountWalletUI() {
            const container = document.getElementById('wallet-adapter-root');
            const ReactDOMGlobal = window.ReactDOM || ReactDOM;
            if (container && ReactDOMGlobal && typeof ReactDOMGlobal.createRoot === 'function') {
                try {
                    const root = ReactDOMGlobal.createRoot(container);
                    root.render(React.createElement(WalletConnector));
                    return true;
                } catch (e) {
                    console.error('Wallet UI mount failed:', e);
                }
            }
            return false;
        }

        if (!mountWalletUI()) {
            const onLoad = () => mountWalletUI();
            window.addEventListener('load', onLoad, { once: true });
            setTimeout(mountWalletUI, 800);
        }
        
        // ÂÖ®Â±ÄÈí±ÂåÖÁä∂ÊÄÅÁÆ°ÁêÜ (ÂêëÂêéÂÖºÂÆπ)
        let currentWalletState = {
            isConnected: false,
            wallet: null
        };
        
        // ÁõëÂê¨Èí±ÂåÖÁä∂ÊÄÅÂèòÂåñ
        window.addEventListener('walletConnected', (event) => {
            currentWalletState = {
                isConnected: true,
                wallet: {
                    address: event.detail.address,
                    provider: event.detail.provider,
                    balance: event.detail.balance
                }
            };
        });
        
        window.addEventListener('walletDisconnected', () => {
            currentWalletState = {
                isConnected: false,
                wallet: null
            };
        });
        
        // ÂÖºÂÆπÊé•Âè£
        window.walletManager = {
            getWalletInfo: () => currentWalletState
        };
        
        window.modernWalletUI = window.walletManager; // ÂêëÂêéÂÖºÂÆπ
        
        // Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜÁ≥ªÁªü - Âú®BabelÁéØÂ¢É‰∏≠ÂÆö‰πâ
        (window.AppConfig?.debug?.log || console.log)('Start defining UserProfileManager class...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÂ°´ÂÜôËµÑÊñô - Á∫ØAPIÈ©±Âä®ÔºåÊó†localStorage
            async checkUserProfile(userId) {
                // ‰ªéuserIdÊèêÂèñÈí±ÂåÖÂú∞ÂùÄ
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ‰ªéÂêéÁ´ØAPIËé∑ÂèñÊúÄÊñ∞ËµÑÊñô
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            (window.AppConfig?.debug?.log || console.log)('Profile fetched from API');
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('No profile found by API');
                        return null;
                    }
                    
                    (window.AppConfig?.debug?.warn || console.warn)('API abnormal response status:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('‚ùå API request failed:', error);
                    return null;
                }
            }
            
            // ÊòæÁ§∫Áî®Êà∑ËµÑÊñôÈù¢Êùø
            showProfilePanel(userId = null, existingProfile = null) {
                (window.AppConfig?.debug?.log || console.log)('Show user profile panel');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Êõ¥ÊîπÊ†áÈ¢ò‰∏∫ÁºñËæëÊ®°Âºè
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // ÈáçÁΩÆË°®Âçï
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Profile panel shown');
                } else {
                    console.error('‚ùå user-profile-overlay element not found');
                }
            }
            
            // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // ÈáçÁΩÆË°®Âçï
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
            showUserWelcome(profile) {
                (window.AppConfig?.debug?.log || console.log)('Show user welcome');
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ê¨¢Ëøé‰ø°ÊÅØÊòæÁ§∫ÈÄªËæë
            }
        }

        // Á°Æ‰øùUserProfileManagerÁ±ªÂèØÂÖ®Â±ÄËÆøÈóÆ
        (window.AppConfig?.debug?.log || console.log)('Expose UserProfileManager globally');
        window.UserProfileManager = UserProfileManager;
        
        // Á´ãÂç≥ÂàùÂßãÂåñProfileManager‰ª•Á°Æ‰øùÂú®Èí±ÂåÖËøûÊé•Êó∂ÂèØÁî®
        (window.AppConfig?.debug?.log || console.log)('Create profileManager instance...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');
        
    </script>
                // ËøûÊé•ÊåâÈíÆÁÇπÂáª
                const connectButton = document.getElementById('wallet-connect-button');
                if (connectButton) {
                    connectButton.addEventListener('click', () => this.showWalletModal());
                }

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                const closeBtn = document.getElementById('wallet-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideWalletModal());
                }

                // Ê®°ÊÄÅÊ°ÜË¶ÜÁõñÂ±ÇÁÇπÂáªÂÖ≥Èó≠
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.closest('.wallet-modal-overlay')) {
                            if (e.target === modal || e.target === e.target.closest('.wallet-modal-overlay')) {
                                this.hideWalletModal();
                            }
                        }
                    });
                }

                // Èí±ÂåÖÈÄâÈ°πÁÇπÂáª
                const walletOptions = document.querySelectorAll('.wallet-option');
                walletOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const provider = option.dataset.provider;
                        this.connectWallet(provider);
                    });
                });

                // Èí±ÂåÖËèúÂçïÊåâÈíÆ
                const menuBtn = document.getElementById('wallet-menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                // Â§çÂà∂Âú∞ÂùÄ
                const copyBtn = document.getElementById('copy-address-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyAddress());
                }

                // Êñ≠ÂºÄËøûÊé•
                const disconnectBtn = document.getElementById('disconnect-wallet-btn');
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => this.disconnect());
                }

                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
                document.addEventListener('click', () => {
                    this.hideDropdown();
                });
            }

            showWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            hideWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            async connectWallet(walletName) {
                try {
                    (window.AppConfig?.debug?.log || console.log)(`Connect wallet: ${walletName}`);
                    
                    // Êü•ÊâæÈí±ÂåÖÈÖçÁΩÆ
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === walletName.toLowerCase());
                    if (!walletConfig) {
                        throw new Error(`Èí±ÂåÖ ${walletName} Êú™ÊâæÂà∞ÊàñÊú™ÂÆâË£Ö`);
                    }
                    
                    const adapter = walletConfig.adapter();
                    if (!adapter) {
                        this.showToast(`${walletName} Èí±ÂåÖÊú™ÂÆâË£Ö`, 'error');
                        return;
                    }
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                    this.updateConnectButton(true);
                    
                    // ËøûÊé•Èí±ÂåÖ
                    let response;
                    if (adapter.connect) {
                        response = await adapter.connect();
                    } else if (adapter.publicKey && adapter.isConnected) {
                        response = { publicKey: adapter.publicKey };
                    } else {
                        throw new Error('Èí±ÂåÖÈÄÇÈÖçÂô®‰∏çÊîØÊåÅËøûÊé•');
                    }
                    
                    const address = response.publicKey.toString();
                    
                    // ‰øùÂ≠òËøûÊé•Áä∂ÊÄÅ
                    this.selectedWallet = {
                        name: walletName,
                        adapter,
                        address,
                        config: walletConfig
                    };
                    this.isConnected = true;
                    
                    // ‰øùÂ≠òÂà∞localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletName.toLowerCase());
                    
                    (window.AppConfig?.debug?.log || console.log)(`Wallet connected: ${walletName}`, address);
                    
                    // Update UI
                    this.updateUI();
                    this.hideWalletModal();
                    this.showToast(`${walletName} ËøûÊé•ÊàêÂäü!`, 'success');
                    
                    // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletName.toLowerCase() }
                    }));
                    
                } catch (error) {
                    console.error('‚ùå Wallet connection failed:', error);
                    this.updateConnectButton(false);
                    this.showToast(`ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                }
            }

            async disconnect() {
                try {
                    (window.AppConfig?.debug?.log || console.log)('Disconnect wallet...');

                    if (this.selectedWallet?.adapter?.disconnect) {
                        await this.selectedWallet.adapter.disconnect();
                    }
                    
                    // Ê∏ÖÁêÜÁä∂ÊÄÅ
                    this.selectedWallet = null;
                    this.isConnected = false;

                    // Ê∏ÖÁêÜlocalStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    localStorage.removeItem('selectedCharacter');

                    // Update UI
                    this.updateUI();
                    this.hideDropdown();
                    this.showToast(i18n.t('wallet.disconnected'), 'success');

                    // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));

                } catch (error) {
                    console.error('‚ùå Disconnect failed:', error);
                    // Âº∫Âà∂Ê∏ÖÁêÜÁä∂ÊÄÅ
                    this.selectedWallet = null;
                    this.isConnected = false;
                    localStorage.clear();
                    this.updateUI();
                }
            }

            checkExistingConnection() {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    (window.AppConfig?.debug?.log || console.log)('Check saved wallet connection...');
                    
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === savedType.toLowerCase());
                    if (walletConfig) {
                        const adapter = walletConfig.adapter();
                        if (adapter && adapter.isConnected && adapter.publicKey) {
                            this.selectedWallet = {
                                name: walletConfig.name,
                                adapter,
                                address: savedAddress,
                                config: walletConfig
                            };
                            this.isConnected = true;
                            this.updateUI();
                            (window.AppConfig?.debug?.log || console.log)('Auto reconnected:', savedAddress);
                        }
                    }
                }
            }

            updateUI() {
                const connectButton = document.getElementById('wallet-connect-button');
                const walletInfo = document.getElementById('wallet-info');
                const walletAddress = document.getElementById('wallet-address');
                const walletAvatar = document.getElementById('wallet-avatar');

                if (this.isConnected && this.selectedWallet) {
                    // Â∑≤ËøûÊé•Áä∂ÊÄÅ
                    if (connectButton) connectButton.style.display = 'none';
                    if (walletInfo) walletInfo.style.display = 'flex';
                    if (walletAddress) walletAddress.textContent = this.formatAddress(this.selectedWallet.address);
                    if (walletAvatar) walletAvatar.textContent = this.selectedWallet.config.icon;
                } else {
                    // ÊòæÁ§∫Êú™ËøûÊé•Áä∂ÊÄÅ
                    if (connectButton) connectButton.style.display = 'flex';
                    if (walletInfo) walletInfo.style.display = 'none';
                }
            }

            updateConnectButton(loading) {
                const button = document.getElementById('wallet-connect-button');
                if (!button) return;

                const textSpan = button.querySelector('.wallet-text');
                if (loading) {
                    button.disabled = true;
                    if (textSpan) textSpan.textContent = 'Connecting...';
                } else {
                    button.disabled = false;
                    if (textSpan) textSpan.textContent = 'Connect';
                }
            }

            toggleDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }

            hideDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }

            copyAddress() {
                if (this.selectedWallet?.address) {
                    navigator.clipboard.writeText(this.selectedWallet.address).then(() => {
                        this.showToast('Âú∞ÂùÄÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                    }).catch(() => {
                        this.showToast('Â§çÂà∂Â§±Ë¥•', 'error');
                    });
                }
                this.hideDropdown();
            }

            formatAddress(address) {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `wallet-toast wallet-toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // ÂÖ¨ÂÖ±API
            getWalletInfo() {
                return {
                    isConnected: this.isConnected,
                    wallet: this.selectedWallet
                };
            }
            
            getPublicKey() {
                return this.selectedWallet?.adapter?.publicKey || null;
            }
            
            async signMessage(message) {
                if (!this.selectedWallet?.adapter?.signMessage) {
                    throw new Error('ÂΩìÂâçÈí±ÂåÖ‰∏çÊîØÊåÅÊ∂àÊÅØÁ≠æÂêç');
                }
                return await this.selectedWallet.adapter.signMessage(message);
            }
        }

        // Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜÁ≥ªÁªü - ÁßªÂà∞ËøôÈáåÁ°Æ‰øùÂú®Èí±ÂåÖÂàùÂßãÂåñ‰πãÂâçÂÆö‰πâ
        (window.AppConfig?.debug?.log || console.log)('Start defining UserProfileManager class...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÂ°´ÂÜôËµÑÊñô - Á∫ØAPIÈ©±Âä®ÔºåÊó†localStorage
            async checkUserProfile(userId) {
                // ‰ªéuserIdÊèêÂèñÈí±ÂåÖÂú∞ÂùÄ
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ‰ªéÂêéÁ´ØAPIËé∑ÂèñÊúÄÊñ∞ËµÑÊñô
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            (window.AppConfig?.debug?.log || console.log)('Profile fetched from API');
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('No profile found by API');
                        return null;
                    }
                    
                    (window.AppConfig?.debug?.warn || console.warn)('API abnormal response status:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('‚ùå API request failed:', error);
                    return null;
                }
            }
            
            // ÊòæÁ§∫Áî®Êà∑ËµÑÊñôÈù¢Êùø
            showProfilePanel(userId = null, existingProfile = null) {
                (window.AppConfig?.debug?.log || console.log)('Show user profile panel');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Êõ¥ÊîπÊ†áÈ¢ò‰∏∫ÁºñËæëÊ®°Âºè
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // ÈáçÁΩÆË°®Âçï
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Profile panel shown');
                } else {
                    console.error('‚ùå user-profile-overlay element not found');
                }
            }
            
            // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // ÈáçÁΩÆË°®Âçï
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
            showUserWelcome(profile) {
                (window.AppConfig?.debug?.log || console.log)('Show user welcome');
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ê¨¢Ëøé‰ø°ÊÅØÊòæÁ§∫ÈÄªËæë
            }
        }

        // Á°Æ‰øùUserProfileManagerÁ±ªÂèØÂÖ®Â±ÄËÆøÈóÆ
        (window.AppConfig?.debug?.log || console.log)('Expose UserProfileManager globally');
        window.UserProfileManager = UserProfileManager;
        
        // Á´ãÂç≥ÂàùÂßãÂåñProfileManager‰ª•Á°Æ‰øùÂú®Èí±ÂåÖËøûÊé•Êó∂ÂèØÁî®
        (window.AppConfig?.debug?.log || console.log)('Create profileManager instance...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');

        // InitializeÈí±ÂåÖÁÆ°ÁêÜÂô®
        let walletManager;
        document.addEventListener('DOMContentLoaded', () => {
            walletManager = new SolanaWalletManager();
            window.walletManager = walletManager; // Êö¥Èú≤Âà∞ÂÖ®Â±Ä
            window.modernWalletUI = walletManager; // ÂêëÂêéÂÖºÂÆπ
        });

        // ÂÖºÂÆπÊóßÁöÑÂÖ®Â±ÄÂáΩÊï∞
        window.connectWallet = function() {
            if (walletManager) {
                walletManager.showWalletModal();
            }
        };
        
        window.disconnectWallet = function() {
            if (walletManager) {
                walletManager.disconnect();
            }
        };
        
        // Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜÁ≥ªÁªü
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÂ°´ÂÜôËµÑÊñô - Á∫ØAPIÈ©±Âä®ÔºåÊó†localStorage
            async checkUserProfile(userId) {
                // ‰ªéuserIdÊèêÂèñÈí±ÂåÖÂú∞ÂùÄ
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ‰ªéÂêéÁ´ØAPIËé∑ÂèñÊúÄÊñ∞ËµÑÊñô
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const profile = result.profile;
                        (window.AppConfig?.debug?.log || console.log)('Profile from DB exists');
                        return profile;
                    } else if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('Profile not found, need registration');
                        return null;
                    } else {
                        console.error('‚ùå Failed to fetch profile:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå API request failed:', error.message);
                    // Áîü‰∫ßÁéØÂ¢ÉÔºöAPIÂ§±Ë¥•Â∫îËØ•ÊèêÁ§∫Áî®Êà∑ÈáçËØï
                    alert('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÂà∑Êñ∞È°µÈù¢');
                    return null;
                }
            }
            
            // ‰øùÂ≠òÁî®Êà∑ËµÑÊñô - Á∫ØAPIÈ©±Âä®ÔºåÊó†localStorageÂõûÈÄÄ
            async saveUserProfile(userId, profileData) {
                const walletAddress = userId.replace('wallet_', '');
                
                // ÂáÜÂ§áAPIÊï∞ÊçÆ
                const apiData = {
                    walletAddress: walletAddress,
                    nickname: profileData.nickname || profileData.username,
                    age: profileData.age,
                    gender: profileData.gender,
                    birthday: profileData.birthday,
                    location: profileData.location,
                    occupation: profileData.occupation,
                    interests: profileData.interests,
                    bio: profileData.bio
                };
                
                try {
                    // ÂèëÈÄÅÂà∞ÂêéÁ´ØAPI
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    (window.AppConfig?.debug?.log || console.log)('POST API:', `${apiUrl}/api/profiles`);
                    (window.AppConfig?.debug?.log || console.log)('Payload prepared');
                    
                    const response = await fetch(`${apiUrl}/api/profiles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    (window.AppConfig?.debug?.log || console.log)('API response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const savedProfile = result.profile;
                        (window.AppConfig?.debug?.log || console.log)('Profile saved to DB');
                        return savedProfile;
                    } else if (response.status === 409) {
                        // Áî®Êà∑Â∑≤Â≠òÂú®ÔºåÂ∞ùËØïÊõ¥Êñ∞
                        (window.AppConfig?.debug?.log || console.log)('User exists, trying update');
                        return await this.updateUserProfile(userId, profileData);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `API‰øùÂ≠òÂ§±Ë¥•: ${response.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå Save profile failed:', error.message);
                    // Áîü‰∫ßÁéØÂ¢ÉÔºöÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï');
                    throw error; // Âêë‰∏äÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®ËÄÖÂ§ÑÁêÜ
                }
            }
            
            // Ëé∑ÂèñÁî®Êà∑ËµÑÊñô
            getUserProfile(userId) {
                return this.checkUserProfile(userId);
            }
            
            // Âà†Èô§Áî®Êà∑ËµÑÊñô - Á∫ØAPIÈ©±Âä®
            async deleteUserProfile(userId) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ‰ªéAPIÂà†Èô§
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        (window.AppConfig?.debug?.log || console.log)('Profile deleted');
                        return true;
                    } else {
                        console.error('‚ùå Delete failed:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå API delete failed:', error.message);
                    alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï');
                    return false;
                }
            }
            
            // Êõ¥Êñ∞Áî®Êà∑ËµÑÊñô - Á∫ØAPIÈ©±Âä®
            async updateUserProfile(userId, updates) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        (window.AppConfig?.debug?.log || console.log)('Profile updated');
                        return result.profile;
                    } else {
                        console.error('‚ùå Update failed:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå API update failed:', error.message);
                    alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï');
                    return null;
                }
            }
            
            
            // Ëé∑ÂèñÊâÄÊúâÁî®Êà∑ËµÑÊñô - Á∫ØAPIÈ©±Âä®
            async getAllUserProfiles() {
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.profiles || [];
                    } else {
                        console.error('‚ùå Get all users failed:', response.status);
                        return [];
                    }
                } catch (error) {
                    console.error('‚ùå API request failed:', error.message);
                    return [];
                }
            }
            
            // ÊòæÁ§∫ËµÑÊñôÊ≥®ÂÜåÈù¢Êùø
            showProfilePanel(userId = null, existingProfile = null) {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Êõ¥ÊîπÊ†áÈ¢ò‰∏∫ÁºñËæëÊ®°Âºè
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // ÈáçÁΩÆË°®Âçï
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    // InitializeÊúà‰ªΩÂíåÊó•ÊúüÈÄâÊã©Âô®
                    setTimeout(() => {
                        this.initDateSelectors();
                    }, 100);
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Show user registration panel');
                }
            }
            
            // ÈöêËóèËµÑÊñôÊ≥®ÂÜåÈù¢Êùø
            hideProfilePanel() {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // InitializeÊúà‰ªΩÂíåÊó•ÊúüÈÄâÊã©Âô®
            initDateSelectors() {
                const yearSelect = document.getElementById('birthYear');
                const monthSelect = document.getElementById('birthMonth');
                const daySelect = document.getElementById('birthDay');
                
                if (!yearSelect || !monthSelect || !daySelect) {
                    console.error('Date selectors not found');
                    return;
                }
                
                // Ê∏ÖÁ©∫Âπ∂Â°´ÂÖÖÂπ¥‰ªΩÔºà1950-2010ÔºåÈÄÇÂêàÊàêÂπ¥Áî®Êà∑Ôºâ
                yearSelect.innerHTML = '<option value="">Âπ¥</option>';
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 15; i >= 1950; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                
                // Ê∏ÖÁ©∫Âπ∂Â°´ÂÖÖÊúà‰ªΩ
                monthSelect.innerHTML = '<option value="">Êúà</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    monthSelect.appendChild(option);
                }
                
                // Ê∏ÖÁ©∫Âπ∂Â°´ÂÖÖÊó•ÊúüÔºàÈªòËÆ§31Â§©Ôºâ
                daySelect.innerHTML = '<option value="">Êó•</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
                
                // Êúà‰ªΩÂèòÂåñÊó∂Êõ¥Êñ∞Êó•Êúü
                monthSelect.addEventListener('change', () => {
                    this.updateDayOptions(monthSelect.value);
                });
            }
            
            // Ê†πÊçÆÊúà‰ªΩÊõ¥Êñ∞Êó•ÊúüÈÄâÈ°π
            updateDayOptions(month) {
                const daySelect = document.getElementById('birthDay');
                const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                const maxDays = month ? daysInMonth[month - 1] : 31;
                
                daySelect.innerHTML = '<option value="">Êó•</option>';
                for (let i = 1; i <= maxDays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            }
            
            // Áî®Áé∞ÊúâËµÑÊñôÂ°´ÂÖÖË°®Âçï
            fillFormWithProfile(profile) {
                const form = document.getElementById('profile-form');
                if (form && profile) {
                    // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
                    const nickname = form.querySelector('[name="nickname"]');
                    if (nickname) nickname.value = profile.nickname || '';
                    
                    const age = form.querySelector('[name="age"]');
                    if (age) age.value = profile.age || '';
                    
                    const location = form.querySelector('[name="location"]');
                    if (location) location.value = profile.location || '';
                    
                    const occupation = form.querySelector('[name="occupation"]');
                    if (occupation) occupation.value = profile.occupation || '';
                    
                    const interests = form.querySelector('[name="interests"]');
                    if (interests) interests.value = profile.interests || '';
                    
                    const bio = form.querySelector('[name="bio"]');
                    if (bio) bio.value = profile.bio || '';
                    
                    // Â°´ÂÖÖÁîüÊó•
                    if (profile.birthday) {
                        const [year, month, day] = profile.birthday.split('-');
                        const birthYear = form.querySelector('#birthYear');
                        const birthMonth = form.querySelector('#birthMonth');
                        const birthDay = form.querySelector('#birthDay');
                        
                        if (birthYear) birthYear.value = year;
                        if (birthMonth) birthMonth.value = parseInt(month);
                        if (birthDay) birthDay.value = parseInt(day);
                    }
                    
                    // Â°´ÂÖÖÊÄßÂà´
                    if (profile.gender) {
                        const genderRadio = form.querySelector(`[name="gender"][value="${profile.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }
                }
            }
            
            // ÈáçÁΩÆË°®Âçï
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                    // Ê∏ÖÈô§Êó•ÊúüÈÄâÊã©Âô®
                    const birthYear = form.querySelector('#birthYear');
                    const birthMonth = form.querySelector('#birthMonth');
                    const birthDay = form.querySelector('#birthDay');
                    
                    if (birthYear) birthYear.value = '';
                    if (birthMonth) birthMonth.value = '';
                    if (birthDay) birthDay.value = '';
                }
            }
            
            // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
            showUserWelcome(profile) {
                // No UI toast in production; keep debug log only
                (window.AppConfig?.debug?.log || console.log)('User welcome:', !!profile);
            }
        }
        
        // Á°Æ‰øùUserProfileManagerÁ±ªÂèØÂÖ®Â±ÄËÆøÈóÆ
        window.UserProfileManager = UserProfileManager;
        
        // Á´ãÂç≥ÂàùÂßãÂåñProfileManager‰ª•Á°Æ‰øùÂú®Èí±ÂåÖËøûÊé•Êó∂ÂèØÁî®
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');
        
        // Êèê‰∫§Áî®Êà∑ËµÑÊñôË°®Âçï
        async function submitProfile(event) {
            try {
                (window.AppConfig?.debug?.log || console.log)('Form submit start');
                event.preventDefault();
                (window.AppConfig?.debug?.log || console.log)('Default submit prevented');
                
                const formData = {
                username: document.getElementById('username').value.trim(),
                displayName: document.getElementById('displayName').value.trim(),
                birthYear: document.getElementById('birthYear').value,
                birthMonth: document.getElementById('birthMonth').value,
                birthDay: document.getElementById('birthDay').value,
                location: document.getElementById('location').value.trim(),
                language: document.getElementById('language').value,
                // ËÆ∞ÂøÜÁ≥ªÁªüÊï∞ÊçÆ
                memory: {
                    favoriteFood: document.getElementById('favoriteFood').value.trim(),
                    favoriteColor: document.getElementById('favoriteColor').value.trim(),
                    hobbies: document.getElementById('hobbies').value.trim()
                }
            };
            
            (window.AppConfig?.debug?.log || console.log)('Form data collected');
            
            // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
            const requiredFields = {
                username: formData.username,
                displayName: formData.displayName,
                birthYear: formData.birthYear,
                birthMonth: formData.birthMonth,
                birthDay: formData.birthDay,
                location: formData.location,
                language: formData.language
            };
            
            const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
            if (missingFields.length > 0) {
                console.error('‚ùå Missing required fields:', missingFields);
                alert(`ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´‰ø°ÊÅØÔºÅÁº∫Â∞ë: ${missingFields.join(', ')}`);
                return;
            }
            
            // ‰øùÂ≠òÁî®Êà∑ËµÑÊñô
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                
                // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè‰ª•ÂåπÈÖçAPIÊúüÊúõ
                const month = formData.birthMonth.toString().padStart ? formData.birthMonth.padStart(2, '0') : (formData.birthMonth.length === 1 ? '0' + formData.birthMonth : formData.birthMonth);
                const day = formData.birthDay.toString().padStart ? formData.birthDay.padStart(2, '0') : (formData.birthDay.length === 1 ? '0' + formData.birthDay : formData.birthDay);
                
                const apiFormData = {
                    nickname: formData.displayName,
                    username: formData.username,
                    age: new Date().getFullYear() - parseInt(formData.birthYear),
                    birthday: `${formData.birthYear}-${month}-${day}`,
                    location: formData.location,
                    language: formData.language,
                    interests: formData.memory.hobbies,
                    bio: `ÂñúÊ¨¢ÁöÑÈ£üÁâ©: ${formData.memory.favoriteFood}, ÂñúÊ¨¢ÁöÑÈ¢úËâ≤: ${formData.memory.favoriteColor}`
                };
                
                (window.AppConfig?.debug?.log || console.log)('Prepare to save user profile');
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                try {
                    await profileManager.saveUserProfile(userId, apiFormData);
                    (window.AppConfig?.debug?.log || console.log)('User profile saved; hide panel');
                    profileManager.hideProfilePanel();
                } catch (error) {
                    console.error('‚ùå Save user profile failed:', error);
                    alert('‰øùÂ≠òÁî®Êà∑ËµÑÊñôÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    return;
                }
                
                (window.AppConfig?.debug?.log || console.log)('User profile submitted; ready to select character');
                
                // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                successMsg.textContent = i18n.t('registration.success');
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
            } else {
                console.error('‚ùå Wallet address missing; cannot save profile');
            }
            } catch (error) {
                console.error('‚ùå Error during form submit:', error);
                alert(i18n.t('error.save') + ': ' + error.message);
            }
        }
        
        // handleProfileSubmit‰ºöÂú®ÊôÆÈÄöscriptÊ†áÁ≠æ‰∏≠ÂÆö‰πâ
        
        // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.submitProfile = submitProfile;
        
        // ÊµãËØïÂáΩÊï∞ - Âº∫Âà∂ÊòæÁ§∫profile panel
        window.testShowProfilePanel = function() {
            (window.AppConfig?.debug?.log || console.log)('Test: show profile panel');
            if (window.profileManager) {
                (window.AppConfig?.debug?.log || console.log)('profileManager exists; show panel');
                window.profileManager.showProfilePanel();
            } else {
                console.error('‚ùå profileManager does not exist');
            }
        };
        
        // Êñ∞Â¢ûÔºöÊµãËØïÊñ∞Áî®Êà∑ÊµÅÁ®ã
        window.testNewUserFlow = function() {
            (window.AppConfig?.debug?.log || console.log)('Test: simulate new user flow');
            const testAddress = 'TEST_NEW_USER_' + Date.now();
            (window.AppConfig?.debug?.log || console.log)('Use test address:', testAddress);
            
            setTimeout(async () => {
                if (window.profileManager) {
                    const userId = `wallet_${testAddress}`;
                    try {
                        const profile = await window.profileManager.checkUserProfile(userId);
                        (window.AppConfig?.debug?.log || console.log)('Check result:', !!profile);
                        if (!profile) {
                            (window.AppConfig?.debug?.log || console.log)('New user confirmed; show panel');
                            window.profileManager.showProfilePanel();
                        }
                    } catch (error) {
                        (window.AppConfig?.debug?.log || console.log)('API error; show panel');
                        window.profileManager.showProfilePanel();
                    }
                }
            }, 500);
        };
        
        // ===================
        // ÂÖ®Â±ÄÁî®Êà∑ÁÆ°ÁêÜÂáΩÊï∞
        // ===================
        
        // Ê∏ÖÈô§ÂΩìÂâçÁî®Êà∑ËµÑÊñôÔºàÊ®°ÊãüÈ¶ñÊ¨°ÁôªÂΩïÔºâ
        window.clearUserProfile = async function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                (window.AppConfig?.debug?.log || console.log)('Clearing user profile from DB:', userId);
                
                // Á∫ØAPIÂà†Èô§Ôºå‰∏çÂÜç‰ΩøÁî®localStorage
                if (window.profileManager) {
                    const success = await window.profileManager.deleteUserProfile(userId);
                    if (success) {
                        (window.AppConfig?.debug?.log || console.log)('User profile deleted; refresh to see effect');
                        location.reload();
                    } else {
                        (window.AppConfig?.debug?.warn || console.warn)('Delete failed; user may not exist');
                    }
                } else {
                    console.error('‚ùå profileManager not initialized');
                }
            } else {
                (window.AppConfig?.debug?.log || console.log)('No wallet connected; skip clear');
            }
        };
        
        // Ê∏ÖÈô§ÊâÄÊúâÁî®Êà∑ËµÑÊñô
        window.clearAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            profiles.forEach(({userId}) => {
                window.profileManager.deleteUserProfile(userId);
            });
            (window.AppConfig?.debug?.log || console.log)(`Cleared ${profiles.length} user profiles`);
        };
        
        // Êü•ÁúãÊâÄÊúâÁî®Êà∑ËµÑÊñô
        window.showAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            (window.AppConfig?.debug?.log || console.log)(`Total profiles: ${profiles.length}`);
            profiles.forEach(({userId, profile}) => {
                console.log(`üë§ ${userId}:`, profile);
            });
            return profiles;
        };
        
        // ÁºñËæëÂΩìÂâçÁî®Êà∑ËµÑÊñô
        window.editCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                if (profile) {
                    window.profileManager.showProfilePanel(userId, profile);
                    (window.AppConfig?.debug?.log || console.log)('Editing user profile');
                } else {
                    (window.AppConfig?.debug?.log || console.log)('Profile not found; show registration');
                    window.profileManager.showProfilePanel();
                }
            } else {
                (window.AppConfig?.debug?.warn || console.warn)('Wallet not connected');
            }
        };
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ËµÑÊñô
        window.getCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                (window.AppConfig?.debug?.log || console.log)('Current user profile available');
                return profile;
            } else {
                (window.AppConfig?.debug?.warn || console.warn)('Wallet not connected');
                return null;
            }
        };
        
    </script>
    <!-- Áî®Êà∑‰ø°ÊÅØÂ°´ÂÜôÈù¢Êùø -->
    <div class="user-profile-overlay" id="user-profile-overlay" style="display: none;">
        <div class="profile-panel">
            <div class="profile-panel-header">
                <h2 class="profile-panel-title" data-i18n="registration.title">User Registration</h2>
            </div>
            
            <form class="profile-form">
                <!-- Áî®Êà∑Âêç -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.username">Username</label>
                    <input type="text" class="profile-input" id="username" data-i18n-placeholder="registration.username.placeholder" placeholder="Maximum 12 characters" maxlength="12" required>
                    <div class="field-note" data-i18n="registration.username.note">Other users can see this (maximum 12 characters)</div>
                </div>
                
                <!-- ÊòµÁß∞ÔºàÂßìÂêçÔºâ -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.display.name">Your Name</label>
                    <input type="text" class="profile-input" id="displayName" data-i18n-placeholder="registration.display.name.placeholder" placeholder="Name" required>
                    <div class="field-note" data-i18n="registration.display.name.note">"Your Name" is what the AI girlfriend will call you in chat, not visible to other users<br>"Username" and "Your Name" can be modified later in personal profile.</div>
                </div>
                
                <!-- ÁîüÊó• -->
                <div class="profile-field has-multiple-inputs">
                    <label class="field-label" data-i18n="registration.birthday">Your Birthday</label>
                    <div class="birthday-inputs">
                        <select class="profile-select" id="birthYear" required>
                            <option value="" data-i18n="registration.birthday.year">Year</option>
                            <option value="2010">2010</option>
                            <option value="2009">2009</option>
                            <option value="2008">2008</option>
                            <option value="2007">2007</option>
                            <option value="2006">2006</option>
                            <option value="2005">2005</option>
                            <option value="2004">2004</option>
                            <option value="2003">2003</option>
                            <option value="2002">2002</option>
                            <option value="2001">2001</option>
                            <option value="2000">2000</option>
                            <option value="1999">1999</option>
                            <option value="1998">1998</option>
                            <option value="1997">1997</option>
                            <option value="1996">1996</option>
                            <option value="1995">1995</option>
                            <option value="1994">1994</option>
                            <option value="1993">1993</option>
                            <option value="1992">1992</option>
                            <option value="1991">1991</option>
                            <option value="1990">1990</option>
                            <option value="1989">1989</option>
                            <option value="1988">1988</option>
                            <option value="1987">1987</option>
                            <option value="1986">1986</option>
                            <option value="1985">1985</option>
                            <option value="1984">1984</option>
                            <option value="1983">1983</option>
                            <option value="1982">1982</option>
                            <option value="1981">1981</option>
                            <option value="1980">1980</option>
                            <option value="1979">1979</option>
                            <option value="1978">1978</option>
                            <option value="1977">1977</option>
                            <option value="1976">1976</option>
                            <option value="1975">1975</option>
                            <option value="1974">1974</option>
                            <option value="1973">1973</option>
                            <option value="1972">1972</option>
                            <option value="1971">1971</option>
                            <option value="1970">1970</option>
                            <option value="1969">1969</option>
                            <option value="1968">1968</option>
                            <option value="1967">1967</option>
                            <option value="1966">1966</option>
                            <option value="1965">1965</option>
                            <option value="1964">1964</option>
                            <option value="1963">1963</option>
                            <option value="1962">1962</option>
                            <option value="1961">1961</option>
                            <option value="1960">1960</option>
                            <option value="1959">1959</option>
                            <option value="1958">1958</option>
                            <option value="1957">1957</option>
                            <option value="1956">1956</option>
                            <option value="1955">1955</option>
                            <option value="1954">1954</option>
                            <option value="1953">1953</option>
                            <option value="1952">1952</option>
                            <option value="1951">1951</option>
                            <option value="1950">1950</option>
                        </select>
                        <select class="profile-select" id="birthMonth" required>
                            <option value="" data-i18n="registration.birthday.month">Month</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <select class="profile-select" id="birthDay" required>
                            <option value="" data-i18n="registration.birthday.day">Day</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <div class="field-note" data-i18n="registration.birthday.note">‚ÄªBirthday cannot be changed after setting</div>
                </div>
                
                <!-- ÂõΩÂÆ∂/ÂüéÂ∏Ç -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.location">Location</label>
                    <input type="text" class="profile-input" id="location" data-i18n-placeholder="registration.location.placeholder" placeholder="e.g.: Beijing, Shanghai, New York" required>
                </div>
                
                <!-- ËØ≠Ë®ÄÂÅèÂ•Ω -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.language">Language Setting</label>
                    <select class="profile-select" id="language" required>
                        <option value="" data-i18n="registration.language.select">Select Language</option>
                        <option value="CN">‰∏≠Êñá</option>
                        <option value="English">English</option>
                        <option value="Êó•Êú¨Ë™û">Êó•Êú¨Ë™û</option>
                        <option value="ÌïúÍµ≠Ïñ¥">ÌïúÍµ≠Ïñ¥</option>
                        <option value="Espa√±ol">Espa√±ol</option>
                        <option value="Fran√ßais">Fran√ßais</option>
                    </select>
                </div>
                
                <!-- ËÆ∞ÂøÜÁ≥ªÁªü -->
                <div class="memory-section">
                    <div class="memory-title" data-i18n="registration.preferences">Personal Preference Memory</div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.favorite.food">Favorite Food</label>
                        <input type="text" class="memory-input" id="favoriteFood" data-i18n-placeholder="registration.favorite.food.placeholder" placeholder="e.g.: Hot pot, pasta, sushi">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.favorite.color">Favorite Color</label>
                        <input type="text" class="memory-input" id="favoriteColor" data-i18n-placeholder="registration.favorite.color.placeholder" placeholder="e.g.: Blue, pink, green">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.hobbies">Hobbies</label>
                        <input type="text" class="memory-input" id="hobbies" data-i18n-placeholder="registration.hobbies.placeholder" placeholder="e.g.: Reading, listening to music, gaming">
                    </div>
                    
                </div>
                
                <button type="button" class="profile-submit-btn" onclick="handleProfileSubmit(event)" data-i18n="registration.submit">OK</button>
            </form>
        </div>
    </div>

<script>
// Áõ¥Êé•Âú®ËøôÈáåÂÆûÁé∞ÂÆåÊï¥ÁöÑË°®ÂçïÊèê‰∫§ÈÄªËæë
window.handleProfileSubmit = async function(event) {
    try {
        (window.AppConfig?.debug?.log || console.log)('Form submit start');
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const formData = {
            username: document.getElementById('username').value.trim(),
            displayName: document.getElementById('displayName').value.trim(),
            birthYear: document.getElementById('birthYear').value,
            birthMonth: document.getElementById('birthMonth').value,
            birthDay: document.getElementById('birthDay').value,
            location: document.getElementById('location').value.trim(),
            language: document.getElementById('language').value,
            // ËÆ∞ÂøÜÁ≥ªÁªüÊï∞ÊçÆ
            memory: {
                favoriteFood: document.getElementById('favoriteFood').value.trim(),
                favoriteColor: document.getElementById('favoriteColor').value.trim(),
                hobbies: document.getElementById('hobbies').value.trim()
            }
        };
        
        (window.AppConfig?.debug?.log || console.log)('Form data collected');
        
        // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
        const requiredFields = {
            username: formData.username,
            displayName: formData.displayName,
            birthYear: formData.birthYear,
            birthMonth: formData.birthMonth,
            birthDay: formData.birthDay,
            location: formData.location,
            language: formData.language
        };
        
        const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
        if (missingFields.length > 0) {
            console.error('‚ùå Missing required fields:', missingFields);
            alert(`ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´‰ø°ÊÅØÔºÅÁº∫Â∞ë: ${missingFields.join(', ')}`);
            return;
        }
        
        // ‰øùÂ≠òÁî®Êà∑ËµÑÊñô
        const walletAddress = localStorage.getItem('wallet_address');
        if (walletAddress) {
            const userId = `wallet_${walletAddress}`;
            
            // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè‰ª•ÂåπÈÖçAPIÊúüÊúõ
            const month = formData.birthMonth.toString().length === 1 ? '0' + formData.birthMonth : formData.birthMonth;
            const day = formData.birthDay.toString().length === 1 ? '0' + formData.birthDay : formData.birthDay;
            
            const apiFormData = {
                nickname: formData.displayName,
                username: formData.username,
                age: new Date().getFullYear() - parseInt(formData.birthYear),
                birthday: `${formData.birthYear}-${month}-${day}`,
                location: formData.location,
                language: formData.language,
                interests: formData.memory.hobbies,
                bio: `ÂñúÊ¨¢ÁöÑÈ£üÁâ©: ${formData.memory.favoriteFood}, ÂñúÊ¨¢ÁöÑÈ¢úËâ≤: ${formData.memory.favoriteColor}`
            };
            
            (window.AppConfig?.debug?.log || console.log)('Prepare to save user profile');
            
            // ÂèëÈÄÅÂà∞ÂêéÁ´ØAPI
            try {
                const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                (window.AppConfig?.debug?.log || console.log)('POST API:', `${apiUrl}/api/profiles`);
                (window.AppConfig?.debug?.log || console.log)('Payload prepared');
                
                const response = await fetch(`${apiUrl}/api/profiles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        ...apiFormData
                    })
                });
                
                (window.AppConfig?.debug?.log || console.log)('API response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    (window.AppConfig?.debug?.log || console.log)('User profile saved');
                    
                    // ÈöêËóèÈù¢Êùø
                    const overlay = document.getElementById('user-profile-overlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                    
                    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 10px;
                        font-size: 16px;
                        z-index: 10001;
                    `;
                    successMsg.textContent = i18n.t('registration.success');
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API‰øùÂ≠òÂ§±Ë¥•: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Save user profile failed:', error);
                alert('‰øùÂ≠òÁî®Êà∑ËµÑÊñôÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
            }
        } else {
            console.error('‚ùå Wallet address missing; cannot save profile');
            alert('Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑ÈáçÊñ∞ËøûÊé•Èí±ÂåÖ');
        }
    } catch (error) {
        console.error('‚ùå Error during form submit:', error);
        alert('Êèê‰∫§Â§±Ë¥•Ôºö' + error.message);
    }
};
</script>

</body>
</html>
