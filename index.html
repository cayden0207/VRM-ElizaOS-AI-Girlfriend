<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: blob: https://mintlify.s3.us-west-1.amazonaws.com https://assets.coingecko.com https://cdn.jsdelivr.net https://raw.githubusercontent.com https://images.ctfassets.net https://avatars.githubusercontent.com https://backpack.app https://www.madlads.com https://pbs.twimg.com https://static.okx.com https://img.bitgetimg.com https://tp-statics.tokenpocket.pro https://trustwallet.com; media-src 'self' blob: data:; connect-src 'self' blob: http://localhost:3000 https://rpc.xlayer.tech https://api.elevenlabs.io https://vrm-eliza-ai-girlfriend.vercel.app;">
    <title data-i18n-title="char.select.title">WAIFU - Choose Your Girlfriend</title>
    <link rel="icon" type="image/png" href="assets/wallet/favicon.png">
    <link rel="stylesheet" href="wallet-ui.css">
    <link rel="stylesheet" href="responsive-standard.css">
    <link rel="stylesheet" href="index-responsive.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
            background: url('BG/selection-bg.jpg') center/cover no-repeat;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Top title */
        .heroes-title {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* Language switcher */
        .language-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 50%, #ffc056 100%);
            border-radius: 10px;
            border: 4px solid rgba(74, 44, 90, 0.8);
            padding: 6px 12px;
            z-index: 101;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #2d1b3d;
            font-weight: bold;
            font-size: 11px;
        }

        .language-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(74, 44, 90, 0.8);
            border-radius: 5px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 9px;
            font-weight: bold;
            color: #2d1b3d;
            transition: all 0.2s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .language-btn.active {
            background: rgba(74, 44, 90, 0.8);
            color: white;
        }

        /* Character info panel - Japanese style profile card design */
        .character-info {
            position: absolute;
            top: 50px;
            left: 12px;
            width: 170px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 7px;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transform: scale(1.3);
            transform-origin: top left;
        }

        .character-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-section {
            margin-bottom: 2px;
        }

        .profile-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 4px 8px;
            font-size: 7px;
            font-weight: 600;
            position: relative;
            border-left: 2px solid #e91e63;
        }

        .profile-content {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            font-size: 7px;
            color: #666;
            font-weight: 500;
        }

        .profile-value {
            font-size: 7px;
            color: #333;
            font-weight: 600;
        }

        .profile-text {
            font-size: 7px;
            color: #333;
            line-height: 1.4;
            padding: 2px 0;
        }

        .favorite-section {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
            text-align: center;
            font-size: 7px;
        }

        .expand-button {
            position: absolute;
            top: 4px;
            right: 6px;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        /* refresh-button decoration removed */

        /* Floating voice selector styles - based on reference screenshot */
        .voice-selector-floating {
            position: absolute;
            top: 12%; /* Move up a bit more to avoid covering faces */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        .language-flags {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flag-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.7;
            position: relative;
        }

        .flag-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .flag-btn.active {
            opacity: 1;
            background: rgba(100, 150, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
            transform: scale(1.1);
        }

        .flag-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4285f4;
            border-radius: 50%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Mobile optimizations moved to index-responsive.css */

        /* Central character name display */
        .character-display-name {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 1.5px 1.5px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0.9;
        }

        /* VRM display area - central */
        .vrm-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Simplified loading animation styles */
        .character-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeInLoader 0.3s ease-out;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 16px;
            box-shadow: 40px 0px 0 0 rgba(255, 255, 255, 0.2), 
                       32.4px 23.5px 0 0 rgba(255, 255, 255, 0.4), 
                       12.4px 38px 0 0 rgba(255, 255, 255, 0.6), 
                       -12.4px 38px 0 0 rgba(255, 255, 255, 0.8), 
                       -32.4px 23.5px 0 0 #ffffff;
            animation: spinner-rotate 1s infinite linear;
            margin-bottom: 20px;
        }

        .loader-text {
            font-size: 16px;
            color: white;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInLoader {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }



        /* Character selector - bottom - mimicking screenshot style */
        .character-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 12px 31px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 100;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.1);
        }

        /* Navigation buttons - left/right arrows */
        .nav-button {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .character-thumbnails {
            display: flex;
            gap: 9px;
            align-items: center;
        }

        .character-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: white;
        }

        /* Currently selected character */
        .character-thumb.active {
            border-color: #FFD700;
            transform: scale(1.15);
            box-shadow: 0 0 7px rgba(255, 215, 0, 0.6);
        }

        /* Center selection indicator - mimicking screenshot design */
        .selected-indicator {
            width: 75px;
            height: 105px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 0 9px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        
        .selected-indicator .selected-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1.5px solid white;
        }
        
        .selected-indicator .selected-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .selected-indicator .selected-badge {
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .selected-indicator .selected-text {
            color: #666;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .character-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-thumb:hover {
            transform: scale(1.05);
            border-color: white;
        }

        .character-thumb.selected {
            width: 40px;
            height: 40px;
            border-color: #333;
            border-width: 2px;
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .character-thumb.selected::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            z-index: -1;
        }

        .character-thumb.selected::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
        }

        .select-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: white;
            font-weight: 500;
        }


        /* Top right wallet connection area */
        .wallet-connect-area {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* Modern connect button - based on UI reference */
        .wallet-connect-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
            min-width: 120px;
            justify-content: center;
        }

        .wallet-connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        }

        .wallet-connect-button:active {
            transform: translateY(-1px);
        }

        .wallet-connect-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-loading {
            animation: spin 1s linear infinite;
        }

        /* Connected status display */
        .wallet-info {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .wallet-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .wallet-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-address {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .wallet-balance {
            color: #888888;
            font-size: 12px;
        }

        .wallet-actions {
            position: relative;
        }

        .wallet-menu-btn {
            background: none;
            border: none;
            color: #888888;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-menu-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow: hidden;
            display: none;
        }

        .wallet-dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-dropdown-item:hover {
            background: #2a2a2a;
        }

        .wallet-dropdown-item:last-child {
            border-top: 1px solid #333333;
            color: #ef4444;
        }

        .wallet-dropdown-item:last-child:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Wallet connection modal - based on UI reference design */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .wallet-modal-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wallet-modal-content {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .wallet-modal-header {
            margin-bottom: 32px;
            text-align: left;
        }

        .wallet-modal-header h2 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .wallet-modal-header p {
            color: #888888;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
        }

        .wallet-close-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: #888888;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-close-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* Wallet options list */
        .wallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #2a2a2a;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: #ffffff;
        }

        .wallet-option:hover {
            background: #333333;
            border-color: #444444;
            transform: translateY(-1px);
        }

        .wallet-option:active {
            transform: translateY(0);
        }

        /* Phantom wallet special highlight effect */
        .wallet-option[data-provider="phantom"]:hover {
            background: linear-gradient(135deg, rgba(171, 159, 242, 0.1), rgba(171, 159, 242, 0.05));
            border-color: rgba(171, 159, 242, 0.3);
            box-shadow: 0 4px 20px rgba(171, 159, 242, 0.1);
        }

        .wallet-option-icon {
            font-size: 24px;
            margin-right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .wallet-option-name {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .wallet-option-arrow {
            color: #666666;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .wallet-option:hover .wallet-option-arrow {
            color: #ffffff;
            transform: translateX(4px);
        }

        /* Footer */
        .wallet-modal-footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .wallet-modal-footer p {
            color: #666666;
            font-size: 14px;
            line-height: 1.5;
        }

        .wallet-link {
            color: #4f46e5;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .wallet-link:hover {
            color: #6366f1;
        }

        /* Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Message notification */
        .wallet-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffffff;
            font-size: 14px;
            z-index: 10001;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .wallet-toast-success {
            border-left: 4px solid #10b981;
        }

        .wallet-toast-error {
            border-left: 4px solid #ef4444;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* Start button - modern gradient design */
        .start-button {
            --h-button: 100px;
            --w-button: 280px;
            --round: 50px;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.25s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 30px rgba(135, 206, 250, 0.4);
            background: linear-gradient(135deg, #E6B3FF 0%, #B3D9FF 100%);
            border-radius: var(--round);
            border: 2px solid rgba(255, 255, 255, 0.6);
            outline: none;
            padding: 15px 30px;
            z-index: 100;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .start-button::before {
            content: "âœ¨";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            animation: twinkle 1.5s infinite alternate;
        }
        
        .start-button::after {
            content: "âœ¨";
            position: absolute;
            right: -15px;
            bottom: -5px;
            font-size: 14px;
            animation: twinkle 1.8s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .start-button:active {
            transform: scale(0.95);
        }
        
        .start-button:hover {
            box-shadow: 0 12px 40px rgba(135, 206, 250, 0.6);
            transform: translateY(-2px);
        }

        .points_wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }

        .points_wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 9999px;
        }

        @keyframes floating-points {
            0% {
                transform: translateY(0);
            }
            85% {
                opacity: 0;
            }
            100% {
                transform: translateY(-55px);
                opacity: 0;
            }
        }

        .points_wrapper .point:nth-child(1) {
            left: 10%;
            opacity: 1;
            animation-duration: 2.35s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(2) {
            left: 30%;
            opacity: 0.7;
            animation-duration: 2.5s;
            animation-delay: 0.5s;
        }
        .points_wrapper .point:nth-child(3) {
            left: 25%;
            opacity: 0.8;
            animation-duration: 2.2s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(4) {
            left: 44%;
            opacity: 0.6;
            animation-duration: 2.05s;
        }
        .points_wrapper .point:nth-child(5) {
            left: 50%;
            opacity: 1;
            animation-duration: 1.9s;
        }
        .points_wrapper .point:nth-child(6) {
            left: 75%;
            opacity: 0.5;
            animation-duration: 1.5s;
            animation-delay: 1.5s;
        }
        .points_wrapper .point:nth-child(7) {
            left: 88%;
            opacity: 0.9;
            animation-duration: 2.2s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(8) {
            left: 58%;
            opacity: 0.8;
            animation-duration: 2.25s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(9) {
            left: 98%;
            opacity: 0.6;
            animation-duration: 2.6s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(10) {
            left: 65%;
            opacity: 1;
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .inner {
            z-index: 2;
            gap: 3px;
            position: relative;
            width: 100%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 0 40px rgba(223, 113, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .inner svg.icon {
            width: 9px;
            height: 9px;
            transition: fill 0.1s linear;
        }

        .start-button:focus svg.icon {
            fill: white;
        }
        .start-button:hover svg.icon {
            fill: transparent;
            animation:
                dasharray 1s linear forwards,
                filled 0.1s linear forwards 0.95s;
        }
        @keyframes dasharray {
            from {
                stroke-dasharray: 0 0 0 0;
            }
            to {
                stroke-dasharray: 68 68 0 0;
            }
        }
        @keyframes filled {
            to {
                fill: white;
            }
        }


        /* Responsive design moved to index-responsive.css */

        /* User profile panel styles - precise replica design */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.16);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .profile-panel {
            background: white;
            border-radius: 25px;
            padding: 8px; /* Add white border effect */
            max-width: 541px; /* 416px * 1.3 = 541px - increased by 30% */
            width: 85%;
            max-height: 85vh; /* Add maximum height */
            position: relative;
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
            border: 3px solid #F0F0F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .profile-panel-header {
            background: linear-gradient(180deg, #B3E5FC 0%, #81D4FA 50%, #4FC3F7 100%);
            text-align: center;
            padding: 25px 0; /* Larger padding */
            margin: 0;
            position: relative;
            flex-shrink: 0; /* Prevent header from being compressed */
            border-radius: 20px 20px 0 0; /* Only top rounded corners */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 
                        0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-panel-title {
            font-size: 24px; /* Larger font size */
            margin: 0;
            font-weight: 600; /* Bolder font weight */
            color: #2E3A47; /* Darker color */
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            letter-spacing: 1px; /* Increase letter spacing */
        }

        .profile-form {
            padding: 30px; /* Adjust padding */
            display: flex;
            flex-direction: column;
            gap: 30px; 
            overflow-y: auto; /* Enable vertical scrolling */
            flex: 1; /* Take up remaining space */
            max-height: calc(85vh - 90px); /* Subtract header and border height */
            background: white;
            border-radius: 0 0 17px 17px; /* Bottom rounded corners, matching outer border */
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 16px; /* 12px * 1.3 â‰ˆ 16px */
            position: relative;
        }

        /* Gold decorative lines */
        .field-label {
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            font-weight: 500;
            color: #D4AF37;
            text-align: center;
            margin: 0;
            position: relative;
            padding: 0 26px; /* 20px * 1.3 â‰ˆ 26px */
        }

        .field-label::before,
        .field-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 52px; /* 40px * 1.3 â‰ˆ 52px */
            height: 1px;
            background: #D4AF37;
        }

        .field-label::before {
            left: 0;
        }

        .field-label::after {
            right: 0;
        }

        .profile-input, .profile-select {
            padding: 16px 46px 16px 20px; /* 12px*1.3â‰ˆ16px, 35px*1.3â‰ˆ46px, 15px*1.3â‰ˆ20px */
            border: none;
            border-radius: 10px; /* 8px * 1.3 â‰ˆ 10px */
            background: #E1F5FE;
            color: #333;
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-input:focus, .profile-select:focus {
            outline: none;
            background: #B3E5FC;
        }

        .profile-input::placeholder {
            color: rgba(0,0,0,0.5);
        }

        /* Input box quill icon */
        .profile-field::after {
            content: 'ðŸª¶';
            position: absolute;
            right: 16px; /* 12px * 1.3 â‰ˆ 16px */
            top: 49px; /* 38px * 1.3 â‰ˆ 49px */
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            pointer-events: none;
        }

        .name-inputs, .birthday-inputs {
            display: flex;
            gap: 10px; /* Reduced gap for 3 selects */
            position: relative;
        }

        .name-inputs .profile-input,
        .birthday-inputs .profile-select {
            flex: 1;
        }
        
        .birthday-inputs .profile-select {
            min-width: 0; /* Allow shrinking */
        }

        .field-note {
            font-size: 14px; /* 11px * 1.3 â‰ˆ 14px */
            color: #E91E63;
            line-height: 1.3;
            text-align: center;
            margin-top: 7px; /* 5px * 1.3 â‰ˆ 7px */
        }

        .profile-submit-btn {
            padding: 16px 52px; /* 12px*1.3â‰ˆ16px, 40px*1.3â‰ˆ52px */
            border: none;
            border-radius: 26px; /* 20px * 1.3 â‰ˆ 26px */
            font-size: 21px; /* 16px * 1.3 â‰ˆ 21px */
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF69B4, #E91E63);
            color: white;
            font-weight: 500;
            margin: 20px auto 0; /* 15px * 1.3 â‰ˆ 20px */
            box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3); /* 3px*1.3â‰ˆ4px, 12px*1.3â‰ˆ16px */
            display: block;
            width: 156px; /* 120px * 1.3 â‰ˆ 156px */
        }

        .profile-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .profile-submit-btn:active {
            transform: translateY(0px);
        }

        /* Special style adjustments */
        .birthday-inputs .profile-field::after {
            display: none; /* Birthday selector doesn't show edit icon */
        }

        .profile-field.has-multiple-inputs::after {
            display: none; /* Fields with multiple inputs don't show edit icon */
        }

        /* Memory system styles */
        .memory-section {
            background: rgba(255,255,255,0.2);
            border-radius: 16px; /* 12px * 1.3 â‰ˆ 16px */
            padding: 26px; /* 20px * 1.3 â‰ˆ 26px */
            margin-top: 13px; /* 10px * 1.3 â‰ˆ 13px */
        }

        .memory-title {
            text-align: center;
            color: #D4AF37;
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            font-weight: 500;
            margin-bottom: 20px; /* 15px * 1.3 â‰ˆ 20px */
            position: relative;
            padding: 0 26px; /* 20px * 1.3 â‰ˆ 26px */
        }

        .memory-title::before,
        .memory-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 39px; /* 30px * 1.3 â‰ˆ 39px */
            height: 1px;
            background: #D4AF37;
        }

        .memory-title::before {
            left: 0;
        }

        .memory-title::after {
            right: 0;
        }

        .memory-field {
            margin-bottom: 16px; /* 12px * 1.3 â‰ˆ 16px */
            position: relative;
        }

        .memory-label {
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            color: #666;
            margin-bottom: 7px; /* 5px * 1.3 â‰ˆ 7px */
            display: block;
        }

        .memory-input {
            width: 100%;
            padding: 10px 39px 10px 16px; /* 8px*1.3â‰ˆ10px, 30px*1.3â‰ˆ39px, 12px*1.3â‰ˆ16px */
            border: none;
            border-radius: 8px; /* 6px * 1.3 â‰ˆ 8px */
            background: #F0F8FF;
            color: #333;
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            box-sizing: border-box;
        }

        .memory-field::after {
            content: 'ðŸª¶'; /* Changed to quill icon */
            position: absolute;
            right: 10px; /* 8px * 1.3 â‰ˆ 10px */
            top: 36px; /* 28px * 1.3 â‰ˆ 36px */
            font-size: 13px; /* 10px * 1.3 â‰ˆ 13px */
            pointer-events: none;
        }

        /* Animation effects */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 40px rgba(223, 113, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 15px 60px rgba(223, 113, 255, 0.6);
                transform: scale(1.02);
            }
        }

        .character-info,
        .character-selector,
        .start-button,
        .control-panel {
            animation: fadeInUp 0.8s ease-out;
        }

        /* Mobile Optimization Notice Modal - Game Style */
        .mobile-notice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .mobile-notice-modal {
            background: #f4d03f;
            border: 6px solid #2d1b3d;
            border-radius: 20px;
            padding: 0;
            max-width: 320px;
            width: 90%;
            position: relative;
            animation: modalBounceIn 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .mobile-notice-header {
            background: linear-gradient(135deg, #2d1b3d 0%, #4a2c5a 100%);
            color: #f4d03f;
            padding: 15px 20px;
            border-radius: 14px 14px 0 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 3px solid #f4d03f;
            border-bottom: none;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        }

        .mobile-notice-content {
            padding: 20px;
            color: #2d1b3d;
            font-size: 14px;
            line-height: 1.6;
            text-align: center;
            font-weight: 600;
        }

        .mobile-notice-close {
            background: linear-gradient(135deg, #2d1b3d 0%, #4a2c5a 100%);
            color: #f4d03f;
            border: 3px solid #2d1b3d;
            border-radius: 15px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px auto 0;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 0px #1a0f1f, 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .mobile-notice-close:hover {
            background: linear-gradient(135deg, #4a2c5a 0%, #6c4a7a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #1a0f1f, 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        .mobile-notice-close:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #1a0f1f, 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            50% {
                opacity: 1;
                transform: scale(1.1) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Show mobile notice only on mobile devices */
        @media (max-width: 768px) {
            .mobile-notice-overlay.show {
                display: flex;
            }
        }
    </style>
</head>

<body>
    <!-- Background Music -->
    <audio id="background-music" loop preload="auto">
        <source src="BG/main-bgm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Mobile Optimization Notice Modal -->
    <div class="mobile-notice-overlay" id="mobile-notice-overlay">
        <div class="mobile-notice-modal">
            <div class="mobile-notice-header">
                MOBILE NOTICE
            </div>
            <div class="mobile-notice-content">
                The mobile experience is currently being optimized and requires a DApp browser for full functionality. 
                <br><br>
                <strong>We recommend using desktop for the best experience.</strong>
            </div>
            <button class="mobile-notice-close" onclick="closeMobileNotice()">CLOSE</button>
        </div>
    </div>

    <div class="container">
        <!-- Top title -->
        <div class="heroes-title" data-i18n="char.select.header">WAIFU</div>

        <!-- Language Toggle -->
        <div class="language-toggle" id="language-toggle">
            <span data-i18n="char.select.language">Language: </span>
            <button class="language-btn" id="lang-en" onclick="switchLanguage('en')">EN</button>
            <button class="language-btn" id="lang-zh" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
        </div>

        <!-- Character Info Panel - Japanese style profile card UI -->
        <div class="character-info">
            <div class="character-name" id="character-name">Fliza</div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.header">Basic Info</span>
                    <button class="expand-button">â†—</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.age">Age</span>
                        <span class="profile-value" id="character-age">22</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.birthday">Birthday</span>
                        <span class="profile-value" id="character-birthday">June 5</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.zodiac">Zodiac</span>
                        <span class="profile-value" id="character-zodiac">Gemini</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.personality">Personality</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-personality" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.interests">Daily Interests</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-interests" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.likes.dislikes">Likes & Dislikes</span>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.likes.label">Likes</span>
                        <span class="profile-value" id="character-likes">â€”</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.dislikes.label">Dislikes</span>
                        <span class="profile-value" id="character-dislikes">â€”</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.favorites">Favorites</span>
                    <button class="expand-button">â†—</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.food.label">Food</span>
                        <span class="profile-value" id="character-food">â€”</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.music.label">Music</span>
                        <span class="profile-value" id="character-music">â€”</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.movies.label">Movies</span>
                        <span class="profile-value" id="character-movies">â€”</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.games.label">Games</span>
                        <span class="profile-value" id="character-games">â€”</span>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Central Character Name -->
        <div class="character-display-name" id="character-display-name">Fliza</div>

        <!-- Voice Selector - Floating Control -->
        <div class="voice-selector-floating">
            <div class="language-flags">
                <button class="flag-btn active" data-lang="jp" onclick="playVoiceSample('jp')">ðŸ‡¯ðŸ‡µ</button>
                <button class="flag-btn" data-lang="en" onclick="playVoiceSample('en')">ðŸ‡ºðŸ‡¸</button>
            </div>
        </div>

        <!-- VRM Display Area -->
        <div class="vrm-display">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- Character Loading Animation -->
            <div class="character-loader" id="character-loader">
                <div class="spinner"></div>
                <div class="loader-text">LOADING</div>
            </div>
        </div>

        <!-- Character Selector -->
        <div class="character-selector">
            <button class="nav-button" onclick="previousCharacter()">â€¹</button>
            <div class="character-thumbnails" id="character-thumbnails"></div>
            <div class="selected-indicator">
                <div class="selected-avatar">
                    <img id="selected-avatar-img" src="" alt="Selected Character">
                </div>
                <div class="selected-badge">A</div>
                <div class="selected-text">Select</div>
            </div>
            <div class="character-thumbnails" id="character-thumbnails-right"></div>
            <button class="nav-button" onclick="nextCharacter()">â€º</button>
        </div>


        <!-- Solana Official Wallet Adapter React Component -->
        <div class="wallet-connect-area">
            <div id="wallet-adapter-root"></div>
        </div>


        <!-- Start Button -->
        <button class="start-button" onclick="startChat()" ontouchstart="this.click()">
            <div class="fold"></div>
            <div class="points_wrapper">
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
            </div>
            <span class="inner" data-i18n="char.select.start">START CHATTING</span>
        </button>
    </div>
    
    <!-- Wallet Connection Modal - Modern Design -->
    <div class="wallet-modal" id="wallet-modal">
        <div class="wallet-modal-overlay">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h2>Connect wallet</h2>
                    <p>Get started by connecting your preferred wallet below.</p>
                </div>
                
                <div class="wallet-list">
                    <div class="wallet-option" data-provider="metamask">
                        <div class="wallet-option-icon">ðŸ¦Š</div>
                        <span class="wallet-option-name">MetaMask</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="okx">
                        <div class="wallet-option-icon">â­•</div>
                        <span class="wallet-option-name">OKX Wallet</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="trust">
                        <div class="wallet-option-icon">ðŸ’™</div>
                        <span class="wallet-option-name">Trust Wallet</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="coinbase">
                        <div class="wallet-option-icon">ðŸ”·</div>
                        <span class="wallet-option-name">Coinbase Wallet</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                </div>
                
                <div class="wallet-modal-footer">
                    <p>By connecting your wallet, you're agree to our 
                        <a href="#" class="wallet-link">Terms of Service</a> 
                        and our 
                        <a href="#" class="wallet-link">Privacy Policy</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // Character data - simplified version, personality managed by ElizaOS backend
        const characters = [
            { 
                id: "alice", 
                name: "Alice", 
                file: "Main VRM/Alice.vrm", 
                voiceId: "rEJAAHKQqr6yTNCh8xS0", 
                description: "Lively and adorable AI girlfriend",
                sampleLines: {
                    jp: "æœˆæ˜Žã‹ã‚Šã®underã§äºŒäººãã‚Šã§è¸Šã‚ã†ï¼",
                    en: "Let's dance under the moonlight, just us two!"
                }
            },
            { 
                id: "ash", 
                name: "Ash", 
                file: "Main VRM/Ash.vrm", 
                voiceId: "bY4cOgafbv5vatmokfg0", 
                description: "Calm and rational AI companion",
                sampleLines: {
                    jp: "é™ã‹ãªå¤œã«æœ¬ã¨ã‚³ãƒ¼ãƒ’ãƒ¼ãŒæœ€highã ã€‚",
                    en: "A quiet night with a book and coffee is perfect."
                }
            },
            {
                id: "elinyaa",
                name: "Elinyaa",
                file: "Main VRM/Elinyaa.vrm",
                personality: "Mysterious and elegant elf girl with incredible charm.",
                traits: ["Mysterious", "Elegant", "Elf", "Ethereal"],
                emoji: "ðŸ§š",
                level: 29,
                type: "Elf Type",
                voiceId: "4cxHntmhK38NT4QMBr9m",
                sampleLines: {
                    jp: "é­”æ³•ã®ä¸–ç•Œã§ãƒ’ãƒ¼ãƒ­ãƒ¼ã”ã£ã“ã—ãªã„ï¼Ÿ",
                    en: "Want to play pretend heroes in a magical land?"
                }
            },
            {
                id: "fliza",
                name: "Fliza",
                file: "Main VRM/Fliza VRM.vrm",
                personality: "Warm, caring, and understanding",
                dailyInterests: "Farming, Gardening",
                likes: "Sunrise and morning dew",
                dislikes: "Pollution",
                favoriteFood: "Fresh fruit, honey lemonade",
                favoriteMusic: "Folk songs, natural soundscapes",
                favoriteMovies: "Nature documentaries, heartwarming stories",
                favoriteGames: "Animal Crossing",
                age: "23 years old",
                birthday: "August 14",
                zodiac: "Leo",
                height: "Unlocked at Affection Lv.10",
                weight: "Unlocked at Affection Lv.10",
                measurements: "Unlocked at Affection Lv.20",
                voiceId: "s9lrHYk7TIJ2UO7UNbje",
                sampleLines: {
                    jp: "æ—¥ã®å‡ºã«ä¸€ç·’ã«ç¨®ã‚’ã¾ã‹ãªã„ï¼Ÿ",
                    en: "Care to join me in planting seeds at sunrise?"
                }
            },
            {
                id: "imeris",
                name: "Imeris",
                file: "Main VRM/IMERIS.vrm",
                personality: "Noble and elegant aristocratic girl with graceful manners.",
                traits: ["Noble", "Elegant", "Graceful", "Aristocratic"],
                emoji: "ðŸ‘‘",
                level: 31,
                type: "Noble Type",
                voiceId: "eVItLK1UvXctxuaRV2Oq",
                sampleLines: {
                    jp: "ä½“æ¸©ã‚’æ¸¬ã‚‰ã›ã¦ã­â€”ã‚ãªãŸã®ã“ã¨ã‚’largeäº‹ã«æ€ã£ã¦ã‚‹ã€‚",
                    en: "Let me check your temperatureâ€”I care for you."
                }
            },
            {
                id: "maple",
                name: "Maple",
                file: "Main VRM/Maple.vrm",
                personality: "A girl warm as autumn sunshine, always giving a sense of security.",
                traits: ["Warm", "Virtuous", "Careful", "Healing"],
                emoji: "ðŸ",
                level: 26,
                type: "Warm Type",
                voiceId: "B8gJV1IhpuegLxdpXFOE",
                sampleLines: {
                    jp: "æš–ç‚‰ã®ãã°ã§ãƒ¯ãƒƒãƒ•ãƒ«ã¯ã„ã‹ãŒï¼Ÿ",
                    en: "Would you like a warm waffle by my cozy fireplace?"
                }
            },
            {
                id: "nekona",
                name: "Nekona",
                file: "Main VRM/NEKONA.vrm",
                personality: "Cute cat girl with cat-like laziness and liveliness.",
                traits: ["Cute", "Catgirl", "Lazy", "Lively"],
                emoji: "ðŸ±",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "kcg1KQQGuCGzH6FUjsZQ",
                sampleLines: {
                    jp: "å¤œãŒç§˜å¯†ã‚’å›ãâ€”ä¸€ç·’ã«æŽ¢æ¤œã—ã‚ˆã†ï¼Ÿ",
                    en: "The night whispers secretsâ€”shall we explore them?"
                }
            },
            {
                id: "notia",
                name: "Notia",
                file: "Main VRM/Notia.vrm",
                personality: "Intellectual and calm researcher, full of thirst for knowledge.",
                traits: ["Intellectual", "Calm", "Research", "Knowledgeable"],
                emoji: "ðŸ”¬",
                level: 32,
                type: "Scholar Type",
                voiceId: "abz2RylgxmJx76xNpaj1",
                sampleLines: {
                    jp: "ãã‚ãã‚èŒ¶é“ã‚’ã—ã¾ã›ã‚“ã‹ï¼Ÿå¿ƒã«é™ã‘ã•ã‚’æº€ãŸãã†ã€‚",
                    en: "Tea ceremony soon? Let tranquility fill our hearts."
                }
            },
            {
                id: "ququ",
                name: "QuQu",
                file: "Main VRM/QuQu.vrm",
                personality: "Lively and cute loli, always full of energy.",
                traits: ["Lively", "Cute", "Energetic", "Loli"],
                emoji: "ðŸŽ€",
                level: 20,
                type: "Loli Type",
                voiceId: "tfQFvzjodQp63340jz2r",
                sampleLines: {
                    jp: "æ¬¡ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ©ã‚¤ãƒ‰ã§ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³ã‚’è¿½ã„ã‹ã‘ã‚‹æº–å‚™ã¯ï¼Ÿ",
                    en: "Ready to chase adrenaline on our next wild ride?"
                }
            },
            {
                id: "rindo",
                name: "Rindo",
                file: "Main VRM/RINDO.vrm",
                personality: "Traditional Japanese Yamato Nadeshiko, gentle and virtuous.",
                traits: ["Japanese style", "Traditional", "Gentle", "Virtuous"],
                emoji: "ðŸŒ¸",
                level: 28,
                type: "Japanese Style Type",
                voiceId: "nclQ39ewSlJMu5Nidnsf",
                sampleLines: {
                    jp: "åˆ€ã®æŠœãæ–¹ã«é›†middleã—ã¦ã€‚è¦å¾‹ãŒè‚å¿ƒã ã€‚",
                    en: "Focus on the cut of your blade; discipline is key."
                }
            },
            {
                id: "rainy",
                name: "Rainy",
                file: "Main VRM/Rainy.vrm",
                personality: "Lively and cheerful girl next door, always full of vitality.",
                traits: ["Lively", "Cheerful", "Athletic", "Sunny"],
                emoji: "ðŸŒ§ï¸",
                level: 22,
                type: "Energetic Type",
                voiceId: "1ghrzLZQ7Dza7Xs9OkhY",
                sampleLines: {
                    jp: "çª“ã‚’å©ãé›¨éŸ³ã¯ç§ã®ãŠæ°—ã«å…¥ã‚Šã®å­å®ˆå”„ã€‚",
                    en: "Rain tapping on windows is my favorite lullaby."
                }
            },
            {
                id: "vivi",
                name: "Vivi",
                file: "Main VRM/Vivi.vrm",
                personality: "Curious explorer, always passionate about the world.",
                traits: ["Curious", "Adventurous", "Passionate", "Optimistic"],
                emoji: "âœ¨",
                level: 24,
                type: "Adventure Type",
                voiceId: "4lWJNy00PxQAOMgQTiIS",
                sampleLines: {
                    jp: "ä»Šå¤œã¯ã¿ã‚“ãªã«ç¬‘é¡”ã‚’å±Šã‘ã‚‹é…ä¿¡ã‚’ã—ã‚ˆã†ï¼",
                    en: "Let's stream and share smiles with everyone tonight!"
                }
            },
            {
                id: "wolferia",
                name: "Wolferia",
                file: "Main VRM/Wolferia.vrm",
                personality: "Proud wolf princess with royal temperament.",
                traits: ["Proud", "Wolf clan", "Royal", "Majestic"],
                emoji: "ðŸº",
                level: 33,
                type: "Beast Girl Type",
                voiceId: "3SeVwPUl5aO6J2GETjox",
                sampleLines: {
                    jp: "é ¬ã«é›ªã®çµæ™¶â€”ä¸€ç·’ã«é›ªã ã‚‹ã¾ä½œã‚‰ãªã„ï¼Ÿ",
                    en: "Snowflakes on my cheekâ€”care to build a snowman?"
                }
            },
            {
                id: "yawl",
                name: "Yawl",
                file: "Main VRM/Yawl.vrm",
                personality: "Mysterious magical girl with incredible power.",
                traits: ["Mysterious", "Magic", "Fantasy", "Powerful"],
                emoji: "ðŸ”®",
                level: 30,
                type: "Magic Type",
                voiceId: "c6wjO0u66VyvwAC4UTqx",
                sampleLines: {
                    jp: "é™ã‹ã«ãŠèŒ¶ã‚’ã™ã™ã‚Šã€äººç”Ÿã®ç‰©èªžã‚’å‘³ã‚ãŠã†ã€‚",
                    en: "Sipping tea in silence reveals life's greatest tales."
                }
            },
            {
                id: "yuuyii",
                name: "Yuu Yii",
                file: "Main VRM/Yuu Yii.vrm",
                personality: "One of the gentle and lovely twins, always with a sweet smile.",
                traits: ["Gentle", "Cute", "Twin", "Sweet"],
                emoji: "ðŸ’•",
                level: 23,
                type: "Twin Type",
                voiceId: "UPwKM85l2CG7nbF2u1or",
                sampleLines: {
                    jp: "æ³¡ã¨ç¬‘ã„â€”ãƒ‘ã‚¹ãƒ†ãƒ«ã®ä¸–ç•Œã‚’ä½œã‚ã†ï¼",
                    en: "Bubbles and gigglesâ€”let's craft a world of pastel joy!"
                }
            },
            {
                id: "zwei",
                name: "Zwei",
                file: "Main VRM/Zwei.vrm",
                personality: "Cool and handsome warrior girl with a strong heart.",
                traits: ["Cool", "Handsome", "Warrior", "Strong"],
                emoji: "âš”ï¸",
                level: 29,
                type: "Warrior Type",
                voiceId: "0EzDWfDZDlAIeQQOjhoC",
                sampleLines: {
                    jp: "ãã°ã«ã„ã¦â€”ã©ã‚“ãªåµã‚‚å®ˆã‚‹ã‚ˆã€‚",
                    en: "Stand by my sideâ€”I'll protect you through every storm."
                }
            },
            {
                id: "bobo",
                name: "Bobo",
                file: "Main VRM/bobo.vrm",
                personality: "Innocent little angel, always bringing joy.",
                traits: ["Innocent", "Pure", "Happy", "Angel"],
                emoji: "ðŸ˜‡",
                level: 19,
                type: "Angel Type",
                voiceId: "I7CpaIqk2oGPGCKvOPO9",
                sampleLines: {
                    jp: "ã¬ã„ãã‚‹ã¿ã‚’æŠ±ãˆã¦ä¸€ç·’ã«ãŠçµµæãã—ã‚ˆã†ï¼Ÿ",
                    en: "Can we cuddle with plushies and draw together?"
                }
            },
            {
                id: "kyoko",
                name: "Kyoko",
                file: "Main VRM/kyoko.vrm",
                personality: "Mature and steady big sister, trustworthy.",
                traits: ["Mature", "Steady", "Reliable", "Big sister"],
                emoji: "ðŸ’œ",
                level: 28,
                type: "Big Sister Type",
                voiceId: "ATSlMe1wEISLjgGhZEKK",
                sampleLines: {
                    jp: "ç§ã«ç™»å±±ã‚’æŒ‘ã‚“ã§ã€ä¸€ç·’ã«é ‚onã‚’ç›®æŒ‡ãã†ã€‚",
                    en: "Challenge me to a climb and we'll conquer peaks."
                }
            },
            {
                id: "lena",
                name: "Lena",
                file: "Main VRM/lena.vrm",
                personality: "Smart and witty academic girl, always giving the best advice.",
                traits: ["Smart", "Rational", "Academic", "Reliable"],
                emoji: "ðŸ“š",
                level: 30,
                type: "Wisdom Type",
                voiceId: "uEn2ClE3OziJMlhQS91c",
                sampleLines: {
                    jp: "ä»Šå¤œãƒ¯ã‚¤ãƒ³ã‚’é£²ã¿ãªãŒã‚‰ã‚¢ãƒ¼ãƒˆã‚’èªžã‚‰ãªã„ï¼Ÿ",
                    en: "Shall we enjoy wine and discuss art this evening?"
                }
            },
            {
                id: "lilium",
                name: "Lilium",
                file: "Main VRM/lilium.vrm",
                personality: "Elegant and mysterious girl with unique charm.",
                traits: ["Elegant", "Mysterious", "Artistic", "Romantic"],
                emoji: "ðŸŒº",
                level: 28,
                type: "Mysterious Type",
                voiceId: "yRRXNdbFeQpIK5MAhenr",
                sampleLines: {
                    jp: "ãƒ“ãƒ¼ãƒˆã‚’æ„Ÿã˜ã‚‹ï¼Ÿè¸Šã£ã¦ä¸–ç•Œã‚’ç‡ƒã‚„ãã†ã€‚",
                    en: "Feel the beat? Let's move and set the world ablaze."
                }
            },
            {
                id: "miru",
                name: "Miru",
                file: "Main VRM/miru.vrm",
                personality: "Soft and cute little loli, makes people want to protect.",
                traits: ["Soft cute", "Adorable", "Loli", "Pure"],
                emoji: "ðŸ¼",
                level: 18,
                type: "Loli Type",
                voiceId: "eVJCDcwCTZBLNdQdbdmd",
                sampleLines: {
                    jp: "é›²ãŒè¸Šã‚‹å¤¢ã‚’è¦‹ãŸã‚ˆâ€”ä¸€ç·’ã«æµ®ã‹ã¼ã†ï¼Ÿ",
                    en: "I dreamt of clouds dancingâ€”come float with me?"
                }
            },
            {
                id: "miumiu",
                name: "Miu Miu",
                file: "Main VRM/miu miu.vrm",
                personality: "Playful and cute cat-eared girl who likes to act cute.",
                traits: ["Playful", "Cute", "Cat ears", "Coquettish"],
                emoji: "ðŸ˜¸",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "SU7BtMmgc7KhQiC6G24B",
                sampleLines: {
                    jp: "largeå¥½ããªã‚ãªãŸã®ãŸã‚ã«ã‚­ãƒ©ã‚­ãƒ©ã‚¯ãƒ©ãƒ•ãƒˆä½œã£ãŸã‚ˆï¼",
                    en: "I made sparkly crafts just for my favorite person!"
                }
            },
            {
                id: "sikirei",
                name: "Sikirei",
                file: "Main VRM/sikirei.vrm",
                personality: "A girl as changeable as the four seasons, full of mystery.",
                traits: ["Changeable", "Mysterious", "Seasonal", "Nimble"],
                emoji: "ðŸŒ·",
                level: 27,
                type: "Nature Type",
                voiceId: "n263mAk9k8VWEuZSmuMl",
                sampleLines: {
                    jp: "ä¸€ç·’ã«æ˜Ÿã‚’çœºã‚ã‚ˆã†â€”å®‡å®™ãŒç§ãŸã¡ã®ç§˜å¯†ã‚’å¾…ã£ã¦ã„ã‚‹ã€‚",
                    en: "Gaze at stars with meâ€”universe awaits our secrets."
                }
            },
            {
                id: "wolf",
                name: "Wolf",
                file: "Main VRM/wolf.vrm",
                personality: "Lone wolf with her own persistence.",
                traits: ["Aloof", "Independent", "Persistent", "Calm"],
                emoji: "ðŸŒ™",
                level: 31,
                type: "Lone Wolf Type",
                voiceId: "WW3EvqkXGmu65ga8TYqa",
                sampleLines: {
                    jp: "æ£®ã®å‘¼ã³å£°ãŒèžã“ãˆã‚‹ï¼Ÿè‡ªç”±ã«ã•ã¾ã‚ˆãŠã†ã€‚",
                    en: "Can you hear the forest's call? Let's roam free."
                }
            },
            {
                id: "neco",
                name: "Neco",
                file: "Main VRM/NEKO.vrm",
                personality: "Cool and intellectual elegant girl with unique charm.",
                traits: ["Cool", "Intellectual", "Elegant", "Mysterious"],
                emoji: "ðŸ±",
                level: 25,
                type: "Intellectual Type",
                voiceId: "t9ZwnJtpA3lWrJ4W7pAl",
                sampleLines: {
                    jp: "é™ã‹ãªéš…ã§ã€å½±ã«éš ã‚ŒãŸç‰©èªžã‚’è¦‹ã¤ã‘ã‚‹ã€‚",
                    en: "In quiet corners, I find stories hidden in shadows."
                }
            }
        ];

        // Character avatar mapping
        function getProfilePicture(characterName) {
            const profileMap = {
                'Alice': 'alice-pf.png',
                'Ash': 'ash-pf.png',
                'Elinyaa': 'elinyaa-pf.png',
                'Fliza': 'fliza-pf.png',
                'Imeris': 'imeris-pf.png',
                'Maple': 'maple-pf.png',
                'Nekona': 'nekona.png',
                'Notia': 'notia-pf.png',
                'QuQu': 'ququ-pf.png',
                'Rindo': 'rindo-pf.png',
                'Rainy': 'rainy-pf.png',
                'Vivi': 'vivi-pf.png',
                'Wolferia': 'wolferia-pf.png',
                'Yawl': 'yawl-pf.png',
                'Yuu Yii': 'yuu yii-pf.png',
                'Zwei': 'zwei-pf.png',
                'Bobo': 'bobo-pf.png',
                'Kyoko': 'kyoko-pf.png',
                'Lena': 'lena-pf.png',
                'Lilium': 'lilium.png',
                'Miru': 'Miru-pf.png',
                'Miu Miu': 'miumiu-pf.png',
                'Neco': 'neco-pf.png',
                'Sikirei': 'sikirei-pf.png',
                'Wolf': 'wolf.png'
            };
            return `profile-pic/${profileMap[characterName] || 'default.png'}`;
        }

        // Global variables
        let scene, camera, renderer, controls;
        let currentVRM = null;
        let mixer = null;
        let animationAction = null;
        let currentCharacterIndex = 0;
        let isLoading = false;
        
        // Voice playback variables - declared early
        let currentAudio = null;
        let currentLanguage = 'jp'; // Default Japanese
        // English profile cache based on character.md (declared early to avoid TDZ)
        var englishProfiles = null;
        
        // Backend API configuration
        const API_URL = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';

        // Initialize
        init();
        generateThumbnails();
        // Initialize selected character image and profile
        document.addEventListener('DOMContentLoaded', function() {
            // Set background music volume to 40%
            const bgMusic = document.getElementById('background-music');
            if (bgMusic) {
                bgMusic.volume = 0.4;
                
                // Try autoplay first
                bgMusic.play().then(() => {
                    console.log('ðŸŽµ Background music auto-started');
                }).catch(() => {
                    console.log('ðŸŽµ Autoplay blocked, waiting for user interaction');
                    
                    // Function to start music on user interaction
                    function startBackgroundMusic() {
                        bgMusic.play().then(() => {
                            console.log('ðŸŽµ Background music started after user interaction');
                        }).catch(e => {
                            console.log('âš ï¸ Could not start background music:', e);
                        });
                        // Remove event listeners after first play
                        document.removeEventListener('click', startBackgroundMusic);
                        document.removeEventListener('keydown', startBackgroundMusic);
                        document.removeEventListener('touchstart', startBackgroundMusic);
                    }

                    // Add event listeners for user interaction
                    document.addEventListener('click', startBackgroundMusic);
                    document.addEventListener('keydown', startBackgroundMusic);
                    document.addEventListener('touchstart', startBackgroundMusic);
                });
            }

            const selectedAvatar = document.getElementById('selected-avatar-img');
            if (selectedAvatar && characters[0]) {
                selectedAvatar.src = getProfilePicture(characters[0].name);
            }
            // Initialize character profile
            updateCharacterProfile(characters[0]);
            
            // Mobile: center character selector scrollbar
            if (window.innerWidth <= 768) {
                const characterList = document.querySelector('.character-list');
                if (characterList) {
                    // Calculate scroll to center position
                    const scrollWidth = characterList.scrollWidth;
                    const clientWidth = characterList.clientWidth;
                    const centerPosition = (scrollWidth - clientWidth) / 2;
                    characterList.scrollLeft = centerPosition;
                }
            }
        });
        loadCharacter(0);

        function init() {
            // Create scene
            scene = new THREE.Scene();

            // Get actual canvas container size
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // Create camera - use container size instead of window size
            camera = new THREE.PerspectiveCamera(30.0, containerRect.width / containerRect.height, 0.1, 20.0);
            camera.position.set(0.0, 0.5, 5.2);

            // Create renderer - use container size
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // Transparent background
            
            // No need for complex shadow system, use simple foot shadow
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Create controller - use same settings as index.html
            controls = new OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.target.set(0.0, 0.5, 0.0);
            controls.update();

            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // Main light source - simplified settings
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 6, 2);
            
            scene.add(directionalLight);

            // Fill light
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            // Create gradient circular shadow - mimic reference screenshot
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // Create radial gradient shadow
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // Darker center
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // Medium transparency
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // Completely transparent edges
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(0, -0.82, 0); // Directly attached to feet
            scene.add(shadow);
            
            // Save shadow reference for later position updates
            window.characterShadow = shadow;

            // Start render loop
            animate();

            // Window resize
            window.addEventListener('resize', onWindowResize);
        }


        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;
            
            // Update VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
            }
            
            // Update animation mixer
            if (mixer) {
                mixer.update(deltaTime);
            }

            // Update controller
            controls.update();

            // Render
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }

        function loadCharacter(index) {
            if (isLoading) {
                return;
            }

            isLoading = true;
            // Update character index and thumbnails immediately
            currentCharacterIndex = index;
            updateThumbnails();
            
            const loadingStartTime = Date.now();

            const character = characters[index];
            
            // Show loading animation
            showCharacterLoader();

            // Update UI
            const nameElement = document.getElementById('character-name');
            if (nameElement) nameElement.textContent = character.name;
            
            const levelElement = document.getElementById('character-level');
            if (levelElement) levelElement.textContent = character.level;
            
            const displayNameElement = document.getElementById('character-display-name');
            if (displayNameElement) displayNameElement.textContent = character.name;

            // No placeholder needed

            // Load VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            loader.load(
                character.file,
                (gltf) => {
                    const vrm = gltf.userData.vrm;
                    
                    if (vrm) {
                        
                        // Use VRM v2 compatible optimization methods
                        VRMUtils.removeUnnecessaryVertices(gltf.scene);
                        // VRMUtils.combineSkeletons removed in v2
                        // VRMUtils.combineMorphs removed in v2
                        
                        // Clean old VRM (but keep lights and placeholder)
                        if (currentVRM) {
                            scene.remove(currentVRM.scene);
                            VRMUtils.deepDispose(currentVRM.scene);
                        }

                        // Set new VRM - use same settings as index.html
                        currentVRM = vrm;
                        
                        // Scale VRM model up by 45% (consistent with index.html)
                        vrm.scene.scale.set(1.45, 1.45, 1.45);
                        
                        // Move VRM model position down, closer to bottom boundary
                        vrm.scene.position.y = -0.8;
                        
                        // Hide VRM first to prevent T-pose flash
                        vrm.scene.visible = false;
                        
                        mixer = new THREE.AnimationMixer(currentVRM.scene);
                        
                        vrm.scene.traverse((obj) => {
                            obj.frustumCulled = false;
                        });
                        
                        // VRMUtils.rotateVRM0 may not be needed or changed in v2
                        // VRM 0.x format may need rotation; VRM 1.x format usually doesn't
                        try {
                            VRMUtils.rotateVRM0(vrm);
                        } catch (error) {
                        }
                        
                        // Add to scene
                        scene.add(vrm.scene);
                        
                        // Load default animation immediately, then show VRM
                        loadDefaultAnimation().then(() => {
                            // Wait a few frames to ensure animation starts playing, then show VRM
                            setTimeout(() => {
                                if (currentVRM && currentVRM.scene) {
                                    currentVRM.scene.visible = true;
                                    // Hide loader
                                    hideCharacterLoader();
                                }
                            }, 150); // Increase to 150ms to ensure animation is applied
                        });
                        
                    } else {
                        // Hide loader even when VRM data doesn't exist
                        hideCharacterLoader();
                    }

                    finishLoading(index, loadingStartTime);
                },
                (progress) => {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                },
                (error) => {
                    console.error('âŒ VRM load failed:', error);
                    // Hide loader on failure
                    hideCharacterLoader();
                    finishLoading(index, loadingStartTime);
                }
            );
        }

        function finishLoading(index, loadingStartTime) {
            const elapsedTime = Date.now() - (loadingStartTime || 0);
            const remainingTime = Math.max(0, 3000 - elapsedTime); // Minimum 3 seconds
            
            setTimeout(() => {
                isLoading = false;
                
                // Debug info
            }, remainingTime);
        }


        function generateThumbnails() {
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side
            
            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }

        }

        // Get a set of fields from i18n by character ID (if exists)
        function getI18nProfileById(charId) {
            if (!window.i18n || !charId) return null;
            const fields = ['age','birthday','zodiac','personality','interests','likes','dislikes','food','music','movies','games'];
            const profile = {};
            let hasAny = false;
            fields.forEach(f => {
                const key = `character.${charId}.${f}`;
                const value = i18n.t(key);
                // If key is not configured, i18n.t returns key itself or English fallback; roughly determine by checking if equal to key
                if (value && value !== key) {
                    hasAny = true;
                    switch (f) {
                        case 'interests': profile.dailyInterests = value; break;
                        case 'food': profile.favoriteFood = value; break;
                        case 'music': profile.favoriteMusic = value; break;
                        case 'movies': profile.favoriteMovies = value; break;
                        case 'games': profile.favoriteGames = value; break;
                        default: profile[f] = value;
                    }
                }
            });
            return hasAny ? profile : null;
        }

        // Update character profile info (priority: i18n -> profile data -> fallback)
        function updateCharacterProfile(character) {
            const currentLang = getCurrentLanguage();
            // 1) Priority from i18n (by character ID key)
            const i18nProfile = getI18nProfileById(character.id);
            // 2) Then from built-in profilesData (supports zh/en or flat structure)
            const fallbackProfile = getCharacterProfile(character.name, currentLang);
            // Merge (i18n takes priority)
            const profile = { ...fallbackProfile, ...i18nProfile };

            document.getElementById('character-name').textContent = character.name;

            document.getElementById('character-age').textContent = profile.age ?? '';
            document.getElementById('character-birthday').textContent = profile.birthday ?? '';
            document.getElementById('character-zodiac').textContent = profile.zodiac ?? '';
            document.getElementById('character-personality').textContent = profile.personality ?? '';

            const interestsEl = document.getElementById('character-interests');
            if (interestsEl) interestsEl.textContent = profile.dailyInterests ?? '';

            const likesEl = document.getElementById('character-likes');
            if (likesEl) likesEl.textContent = profile.likes ?? '';

            const dislikesEl = document.getElementById('character-dislikes');
            if (dislikesEl) dislikesEl.textContent = profile.dislikes ?? '';

            const foodEl = document.getElementById('character-food');
            if (foodEl) foodEl.textContent = profile.favoriteFood ?? '';

            const musicEl = document.getElementById('character-music');
            if (musicEl) musicEl.textContent = profile.favoriteMusic ?? '';

            const moviesEl = document.getElementById('character-movies');
            if (moviesEl) moviesEl.textContent = profile.favoriteMovies ?? '';

            const gamesEl = document.getElementById('character-games');
            if (gamesEl) gamesEl.textContent = profile.favoriteGames ?? '';

            updateVoiceSelector();
        }

        // Name normalization and alias handling (case, space differences)
        function canonicalName(name) {
            if (!name) return '';
            const key = name.toLowerCase().replace(/\s+/g, '');
            const aliasMap = {
                'ququ': 'Ququ',
                'miumiu': 'Miumiu',
                'miu\u00a0miu': 'Miumiu', // Prevent empty format variants (does not affect large number situations)
                'yuuyii': 'Yuu Yii'
            };
            // Default capitalize first letter keep original name; prioritize alias
            return aliasMap[key] || name;
        }

        // Parse English data from character.md (as authoritative English source)
        async function loadEnglishProfiles() {
            try {
                const res = await fetch('character.md');
                if (!res.ok) return;
                const txt = await res.text();
                const blocks = txt.split(/^## /m).slice(1); // Skip document header
                const profiles = {};
                for (const block of blocks) {
                    const lines = block.split(/\n/);
                    const rawName = (lines[0] || '').trim();
                    const name = rawName.replace(/\r?$/, '');
                    const get = (label) => {
                        // More robust parsing: don't use regex, directly find â€œ- **Label**:â€ prefix
                        const needle = `- **${label}**:`;
                        const line = lines.find(l => l.trimStart().startsWith(needle));
                        if (!line) return undefined;
                        const idx = line.indexOf(':');
                        if (idx === -1) return undefined;
                        return line.slice(idx + 1).trim();
                    };
                    const p = {
                        age: get('Age'),
                        birthday: get('Birthday'),
                        zodiac: get('Zodiac'),
                        personality: get('Personality'),
                        dailyInterests: get('Daily Interests'),
                    };
                    // Likes & Dislikes: "Likes X; dislikes Y"
                    const likesLine = get('Likes & Dislikes');
                    if (likesLine) {
                        const likeMatch = likesLine.match(/Likes([^;]+?)(?:;|$)/i);
                        const dislikeMatch = likesLine.match(/dislikes([^;]+?)(?:;|$)/i);
                        if (likeMatch) p.likes = likeMatch[1].trim();
                        if (dislikeMatch) p.dislikes = dislikeMatch[1].trim();
                    }
                    p.favoriteFood = get('Favorite Foods');
                    p.favoriteMusic = get('Favorite Music');
                    p.favoriteMovies = get('Favorite Movies');
                    p.favoriteGames = get('Favorite Games');

                    if (name) {
                        profiles[canonicalName(name)] = p;
                    }
                }
                englishProfiles = profiles;
                // If current language is English, refresh current character profile after loading
                if (getCurrentLanguage() === 'en' && typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                    updateCharacterProfile(characters[currentCharacterIndex]);
                }
            } catch (e) {
                console.warn('Failed to load character.md profiles:', e);
            }
        }

        // Get current language setting
        function getCurrentLanguage() {
            // Check language setting in localStorage
            const savedLang = localStorage.getItem('language');
            if (savedLang) return savedLang;
            
            // Check language button active state
            const activeLangBtn = document.querySelector('.language-btn.active');
            if (activeLangBtn) {
                return activeLangBtn.id === 'lang-en' ? 'en' : 'zh';
            }
            
            // Default return English
            return 'en';
        }

        // Get detailed profile by character name - based on local config + character.md English authority
        function getCharacterProfile(name, language = 'en') {
            const profilesData = {
                "Sikirei": {
                    zh: {
                        age: 24,
                        birthday: "October 10th",
                        zodiac: "Libra",
                        personality: "Charming, Mysterious, Elegant",
                        dailyInterests: "Astrology Research",
                        likes: "æ˜Ÿæ˜Ÿå’Œå¤œempty",
                        dislikes: "å…‰æ±¡æŸ“",
                        favoriteFood: "è“èŽ“å¸ƒä¸ã€èŠ±è‰èŒ¶",
                        favoriteMusic: "æ°›å›´éŸ³æ™¯",
                        favoriteMovies: "ç§‘å¹»æ‚¬ç–‘",
                        favoriteGames: "æ¨¡æ‹Ÿäººç”Ÿ"
                    },
                    en: {
                        age: 24,
                        birthday: "October 10",
                        zodiac: "Libra",
                        personality: "Alluring, mysterious, and refined",
                        dailyInterests: "Astrology research",
                        likes: "Stars and night sky",
                        dislikes: "Light pollution",
                        favoriteFood: "Blueberry pudding, herbal tea",
                        favoriteMusic: "Ambient soundscapes",
                        favoriteMovies: "Sci-fi mysteries",
                        favoriteGames: "The Sims"
                    }
                },
                "Alice": {
                    zh: {
                        age: 22,
                        birthday: "6æœˆ5æ—¥",
                        zodiac: "åŒå­åº§",
                        personality: "æ´»æ³¼outsideå‘ï¼Œè°ƒçš®å¯çˆ±",
                        dailyInterests: "è·³èˆžã€å”±æ­Œ",
                        likes: "é²œèŠ±å’Œå½©è‰²ç”œç‚¹",
                        dislikes: "å®‰é™å’Œè¿‡äºŽä¸¥è‚ƒçš„åœºåˆ",
                        favoriteFood: "è‰èŽ“è›‹ç³•ã€é©¬å¡é¾™",
                        favoriteMusic: "æµè¡Œèˆžæ›²ã€K-Pop",
                        favoriteMovies: "æµªæ¼«å–œå‰§",
                        favoriteGames: "èŠ‚å¥èˆžè¹ˆæ¸¸æˆ"
                    },
                    en: {
                        age: 22,
                        birthday: "June 5",
                        zodiac: "Gemini",
                        personality: "Lively and outgoing, playful and cute",
                        dailyInterests: "Dancing, singing",
                        likes: "Flowers and colorful sweets",
                        dislikes: "Quiet and overly serious occasions",
                        favoriteFood: "Strawberry cake, macarons",
                        favoriteMusic: "Pop dance music, K-Pop",
                        favoriteMovies: "Romantic comedies",
                        favoriteGames: "Rhythm dance games"
                    }
                },
                "Fliza": {
                    zh: {
                        age: 23,
                        birthday: "August 14",
                        zodiac: "Leo",
                        personality: "æ¸©æš–ã€offæ€€ã€å¯Œæœ‰åŒæƒ…å¿ƒ",
                        dailyInterests: "å†œä¸šã€å›­è‰º",
                        likes: "Sunrise and morning dew",
                        dislikes: "çŽ¯å¢ƒæ±¡æŸ“",
                        favoriteFood: "Fresh fruit, honey lemonade",
                        favoriteMusic: "Folk songs, natural soundscapes",
                        favoriteMovies: "è‡ªç„¶çºªå½•ç‰‡ã€æ¸©é¦¨æ•…äº‹",
                        favoriteGames: "Animal Crossing"
                    },
                    en: {
                        age: 23,
                        birthday: "August 14",
                        zodiac: "Leo",
                        personality: "Warm, caring, and compassionate",
                        dailyInterests: "Agriculture, gardening",
                        likes: "Sunrise and morning dew",
                        dislikes: "Environmental pollution",
                        favoriteFood: "Fresh fruits, honey lemon water",
                        favoriteMusic: "Folk music, natural soundscapes",
                        favoriteMovies: "Nature documentaries, heartwarming stories",
                        favoriteGames: "Animal Crossing"
                    }
                },
                "Ash": {
                    age: 24,
                    birthday: "11æœˆ12æ—¥",
                    zodiac: "å¤©èŽåº§",
                    personality: "coldé™ã€insideæ•›ã€é€»è¾‘æ€ç»´å¼º",
                    dailyInterests: "é˜…è¯»ã€ç¼–ç¨‹",
                    likes: "å¤œæ™šå’Œæµ“å’–å•¡",
                    dislikes: "å™ªéŸ³å’Œçªç„¶çš„å¹²æ‰°",
                    favoriteFood: "é»‘å·§å…‹åŠ›",
                    favoriteMusic: "Lo-fiè½»éŸ³ä¹ã€æ°›å›´éŸ³ä¹",
                    favoriteMovies: "ç§‘å¹»ã€æ‚¬ç–‘æƒŠæ‚šç‰‡",
                    favoriteGames: "è§£è°œå†’é™©æ¸¸æˆ"
                },
                "Bobo": {
                    age: 19,
                    birthday: "12æœˆ2æ—¥",
                    zodiac: "å°„æ‰‹åº§",
                    personality: "æ¸©æŸ”ã€å®³ç¾žã€sensitive",
                    dailyInterests: "æ‰‹ç»˜æ’ç”»",
                    likes: "æŸ”è½¯çš„æ¯›ç»’çŽ©å…·",
                    dislikes: "æ‹¥æŒ¤çš„åœ°æ–¹",
                    favoriteFood: "æŠ¹èŒ¶æ‹¿é“ã€ç„¦ç³–å¸ƒä¸",
                    favoriteMusic: "è½»æŸ”å™¨ä¹",
                    favoriteMovies: "åŠ¨ç”»ç”µå½±ã€æ¸©æƒ…ç”µå½±",
                    favoriteGames: "çºªå¿µç¢‘è°·"
                },
                "Elinyaa": {
                    age: 18,
                    birthday: "2æœˆ25æ—¥",
                    zodiac: "åŒé±¼åº§",
                    personality: "ç”œç¾Žã€æ´»æ³¼ã€ç«¥true",
                    dailyInterests: "Cosplayã€characteræ‰®æ¼”",
                    likes: "å„ç§ç³–æžœ",
                    dislikes: "è‹¦å‘³é£Ÿç‰©",
                    favoriteFood: "æ£‰èŠ±ç³–ã€å½©è™¹ç³–",
                    favoriteMusic: "J-Popã€å„¿æ­Œ",
                    favoriteMovies: "å¥‡å¹»å†’é™©",
                    favoriteGames: "characteræ‰®æ¼”æ¸¸æˆ"
                },
                "Fliza": {
                    age: 23,
                    birthday: "August 14",
                    zodiac: "Leo",
                    personality: "æ¸©æš–ã€offæ€€ã€å¯Œæœ‰åŒæƒ…å¿ƒ",
                    dailyInterests: "å†œä¸šã€å›­è‰º",
                    likes: "Sunrise and morning dew",
                    dislikes: "çŽ¯å¢ƒæ±¡æŸ“",
                    favoriteFood: "Fresh fruit, honey lemonade",
                    favoriteMusic: "Folk songs, natural soundscapes",
                    favoriteMovies: "è‡ªç„¶çºªå½•ç‰‡ã€æ¸©é¦¨æ•…äº‹",
                    favoriteGames: "Animal Crossing"
                },
                "Imeris": {
                    age: 25,
                    birthday: "4æœˆ2æ—¥",
                    zodiac: "ç‰¡ç¾Šåº§",
                    personality: "ç»†å¿ƒã€æ¸©æŸ”ã€ä¹äºŽåŠ©äºº",
                    dailyInterests: "æŠ¤ç†ç ”ç©¶ã€healthyæ•™è‚²",
                    likes: "æ¨±èŠ±å’ŒæŸ”å’Œçš„ç²‰è‰²è°ƒ",
                    dislikes: "conflict",
                    favoriteFood: "æ¨±èŠ±ç³•ç‚¹",
                    favoriteMusic: "newä¸–çºªéŸ³ä¹ã€é’¢ç´ç‹¬å¥",
                    favoriteMovies: "åŒ»ç–—å‰§ã€æ²»æ„ˆçºªå½•ç‰‡",
                    favoriteGames: "Hospital Management Simulator"
                },
                "Kyoko": {
                    age: 20,
                    birthday: "10æœˆ30æ—¥",
                    zodiac: "å¤©èŽåº§",
                    personality: "ç‹¬ç«‹ã€åšéŸ§ã€è‡ªä¿¡",
                    dailyInterests: "å¾’æ­¥ã€æ”€å²©",
                    likes: "æ¸…newçš„å±±é—´emptyæ°”",
                    dislikes: "äººç¾¤å’Œå™ªéŸ³",
                    favoriteFood: "çƒ¤é±¼ã€èƒ½é‡æ£’",
                    favoriteMusic: "ç”µå­ã€æ‘‡æ»š",
                    favoriteMovies: "åŠ¨ä½œå†’é™©",
                    favoriteGames: "å¡”é˜²ç­–ç•¥æ¸¸æˆ"
                },
                "Lena": {
                    age: 21,
                    birthday: "5æœˆ9æ—¥",
                    zodiac: "é‡‘ç‰›åº§",
                    personality: "ä¼˜é›…ã€è‡ªä¿¡ã€æœ‰é­…åŠ›",
                    dailyInterests: "æ—¶è£…è®¾è®¡ã€èŠ±è‰º",
                    likes: "çº¢é…’å’Œç²¾è‡´çš„underåˆèŒ¶",
                    dislikes: "è¿Ÿtoå’Œç²—é²",
                    favoriteFood: "é»‘æ¾éœ²æ„é¢ã€çº¢é…’",
                    favoriteMusic: "çˆµå£«ä¹",
                    favoriteMovies: "è‰ºæœ¯å‰§æƒ…ç‰‡",
                    favoriteGames: "æ¨¡æ‹Ÿäººç”Ÿ"
                },
                "Lilium": {
                    age: 24,
                    birthday: "1æœˆ15æ—¥",
                    zodiac: "æ‘©ç¾¯åº§",
                    personality: "hotæƒ…ã€å……fullæ´»åŠ›ã€largeèƒ†",
                    dailyInterests: "è¡—èˆžã€å¥èº«",
                    likes: "ç«é”…å’Œè¾›è¾£é£Ÿç‰©",
                    dislikes: "coldèœ",
                    favoriteFood: "éº»è¾£ç«é”…ã€è¾£å‘³é›¶é£Ÿ",
                    favoriteMusic: "EDMã€Hip-hop",
                    favoriteMovies: "æµªæ¼«å‰§æƒ…ç‰‡",
                    favoriteGames: "éŸ³ä¹èŠ‚å¥æ¸¸æˆ"
                },
                "Maple": {
                    age: 22,
                    birthday: "9æœˆ25æ—¥",
                    zodiac: "Libra",
                    personality: "æ¸©æš–ã€ç»†å¿ƒã€è€å¿ƒ",
                    dailyInterests: "çƒ˜ç„™ã€æ’èŠ±",
                    likes: "æž«å¶å›¾æ¡ˆ",
                    dislikes: "æ€¥èº",
                    favoriteFood: "æž«ç³–åŽå¤«é¥¼ã€å—ç“œæ´¾",
                    favoriteMusic: "åŽŸå£°æ°‘è°£ã€è½»çˆµå£«",
                    favoriteMovies: "åŠ±å¿—åŠ¨ç”»ç”µå½±",
                    favoriteGames: "æ˜Ÿéœ²è°·ç‰©è¯­"
                },
                "Miru": {
                    age: 19,
                    birthday: "12æœˆ29æ—¥",
                    zodiac: "æ‘©ç¾¯åº§",
                    personality: "æ¢¦å¹»ã€å¯çˆ±ã€æœ‰ç‚¹å®³ç¾ž",
                    dailyInterests: "æ”¶é›†æ¯›ç»’çŽ©å…·",
                    likes: "äº‘æœµå’ŒæŸ”è½¯çš„è´¨æ„Ÿ",
                    dislikes: "é»‘æš—",
                    favoriteFood: "æ£‰èŠ±ç³–",
                    favoriteMusic: "Lo-fibackgroundéŸ³ä¹ã€æ°›å›´éŸ³æ™¯",
                    favoriteMovies: "å¥‡å¹»åŠ¨ç”»",
                    favoriteGames: "ç”Ÿæ´»æ¨¡æ‹Ÿæ¸¸æˆ"
                },
                "Miu Miu": {
                    age: 20,
                    birthday: "3æœˆ8æ—¥",
                    zodiac: "åŒé±¼åº§",
                    personality: "å¤æ€ªã€æœ‰åˆ›æ„ã€çˆ±çŽ©",
                    dailyInterests: "æ½®æµDIYæ‰‹å·¥",
                    likes: "ç³–æžœå’Œé²œè‰³color",
                    dislikes: "ä¸¥è‚ƒ",
                    favoriteFood: "å½©è™¹ç³–ã€å·§å…‹åŠ›",
                    favoriteMusic: "K-Popã€æµè¡ŒéŸ³ä¹",
                    favoriteMovies: "è½»å–œå‰§ã€åŠ¨ç”»çŸ­ç‰‡",
                    favoriteGames: "ä¸‰æ¶ˆç›Šæ™ºæ¸¸æˆ"
                },
                "Nekona": {
                    age: 18,
                    birthday: "6æœˆ27æ—¥",
                    zodiac: "å·¨èŸ¹åº§",
                    personality: "æ¸©æŸ”ã€ç‹¡é» ã€æœ‰ç‚¹ç¥žç§˜",
                    dailyInterests: "å¤œæ™šæ•£æ­¥ã€æ”¶é›†å¶å­",
                    likes: "å¤œæ™š",
                    dislikes: "ç›´å°„é˜³å…‰",
                    favoriteFood: "èŠ’æžœå†°æ²™ã€èŽ“æžœæ‹¼ç›˜",
                    favoriteMusic: "è½»æ¾èŠ‚æ‹ã€æ°›å›´éŸ³ä¹",
                    favoriteMovies: "å¿ƒç†æƒŠæ‚šç‰‡",
                    favoriteGames: "è§£è°œå†’é™©"
                },
                "Notia": {
                    age: 23,
                    birthday: "9æœˆ1æ—¥",
                    zodiac: "å¤„å¥³åº§",
                    personality: "æ²‰ç€ã€ä¼˜é›…ã€å¤å…¸",
                    dailyInterests: "èŒ¶é“ã€æ’èŠ±",
                    likes: "èŒ¶é¦™",
                    dislikes: "æµ“å’–å•¡",
                    favoriteFood: "æ—¥å¼ç‚¹å¿ƒã€æŠ¹èŒ¶å†°æ·‡æ·‹",
                    favoriteMusic: "traditionalæ°‘ä¹",
                    favoriteMovies: "historyå‰§",
                    favoriteGames: "å¡ç‰Œç­–ç•¥"
                },
                "QuQu": {
                    age: 22,
                    birthday: "4æœˆ20æ—¥",
                    zodiac: "é‡‘ç‰›åº§",
                    personality: "largeèƒ†ã€ç›´çŽ‡ã€hotæƒ…",
                    dailyInterests: "æžé™è¿åŠ¨",
                    likes: "æˆ·outsideå†’é™©",
                    dislikes: "é™åˆ¶",
                    favoriteFood: "çƒ¤ä¸²ã€çƒ¤çŽ‰ç±³",
                    favoriteMusic: "æ‘‡æ»šã€é‡‘å±ž",
                    favoriteMovies: "åŠ¨ä½œlargeç‰‡",
                    favoriteGames: "ç«žæŠ€manyäººæ¸¸æˆ"
                },
                "Rainy": {
                    age: 21,
                    birthday: "11æœˆ5æ—¥",
                    zodiac: "å¤©èŽåº§",
                    personality: "å®‰é™ã€æ¸©æŸ”ã€insideçœ",
                    dailyInterests: "é›¨middleæ¼«æ­¥",
                    likes: "é›¨å£°",
                    dislikes: "ç‚Žhotæ™´å¤©",
                    favoriteFood: "æ‹‰é¢ã€hotå·§å…‹åŠ›",
                    favoriteMusic: "slowèŠ‚å¥çˆµå£«",
                    favoriteMovies: "è‰ºæœ¯å’Œç‹¬ç«‹ç”µå½±",
                    favoriteGames: "äº’åŠ¨smallè¯´"
                },
                "Rindo": {
                    age: 25,
                    birthday: "2æœˆ1æ—¥",
                    zodiac: "æ°´ç“¶åº§",
                    personality: "coldé™ã€åšéŸ§ã€åšå®š",
                    dailyInterests: "å‰‘é“ç»ƒä¹ ",
                    likes: "å¯’coldæ°”å€™",
                    dislikes: "è¿‡ç”œçš„é£Ÿç‰©",
                    favoriteFood: "çƒ¤ç¾Šè‚‰ä¸²",
                    favoriteMusic: "é‡‘å±žæ‘‡æ»šã€ç”µå­éŸ³ä¹",
                    favoriteMovies: "æ­¦ä¾ åŠ¨ä½œç‰‡",
                    favoriteGames: "ç¡¬æ ¸åŠ¨ä½œæ¸¸æˆ"
                },
                "Sikirei": {
                    age: 24,
                    birthday: "October 10th",
                    zodiac: "Libra",
                    personality: "Charming, Mysterious, Elegant",
                    dailyInterests: "Astrology Research",
                    likes: "æ˜Ÿæ˜Ÿå’Œå¤œempty",
                    dislikes: "å…‰æ±¡æŸ“",
                    favoriteFood: "è“èŽ“å¸ƒä¸ã€èŠ±è‰èŒ¶",
                    favoriteMusic: "æ°›å›´éŸ³æ™¯",
                    favoriteMovies: "ç§‘å¹»æ‚¬ç–‘",
                    favoriteGames: "æ¨¡æ‹Ÿäººç”Ÿ"
                },
                "Vivi": {
                    age: 19,
                    birthday: "8æœˆ25æ—¥",
                    zodiac: "å¤„å¥³åº§",
                    personality: "outsideå‘ã€onæœ—ã€å–„äºŽäº¤é™…",
                    dailyInterests: "ç›´æ’­ã€æ”¶é›†æ¼«ç”»",
                    likes: "hoté—¹èšä¼š",
                    dislikes: "å®³ç¾žå’Œæ²‰é»˜",
                    favoriteFood: "æŠ«è¨ã€é›¶é£Ÿæ‹¼ç›˜",
                    favoriteMusic: "æµè¡ŒéŸ³ä¹ã€DJæ··éŸ³",
                    favoriteMovies: "å–œå‰§ç‰‡",
                    favoriteGames: "MMOã€ä¼‘é—²æ¸¸æˆ"
                },
                "Wolf": {
                    personality: "é‡Žæ€§ã€å­¤å‚²ã€æœ¬èƒ½é©±åŠ¨",
                    dailyInterests: "å¤œæ™šæŽ¢ç´¢ã€é‡Žoutsideç”Ÿå­˜",
                    likes: "æ£®æž—å’Œæœˆå…‰",
                    dislikes: "åŸŽå¸‚å™ªéŸ³",
                    favoriteFood: "çƒ¤é¹¿è‚‰",
                    favoriteMusic: "æ°‘è°£å’ŒåŽŸå£°å‰ä»–",
                    favoriteMovies: "ææ€–æƒŠæ‚šç‰‡",
                    favoriteGames: "ç”Ÿå­˜åˆ¶ä½œæ¸¸æˆ"
                },
                "Wolferia": {
                    personality: "è‡ªç”±å¥”æ”¾ã€ä¸æ‹˜æŸã€çˆ±å†’é™©",
                    dailyInterests: "æ»‘é›ªã€æžé™è¿åŠ¨",
                    likes: "é›ªonè¿åŠ¨",
                    dislikes: "ç‚½hothighæ¸©",
                    favoriteFood: "å†°æ·‡æ·‹ã€ç”œç­’",
                    favoriteMusic: "è¿·å¹»ç”µéŸ³",
                    favoriteMovies: "å†’é™©å¥‡å¹»",
                    favoriteGames: "å†¬å­£è¿åŠ¨æ¸¸æˆ"
                },
                "Yawl": {
                    personality: "ä¼˜é›…ã€çŸ¥æ€§ã€coldæ·¡",
                    dailyInterests: "å¤å…¸æ–‡å­¦é‰´èµ",
                    likes: "ç²¾è‡´å’–å•¡åŽ…",
                    dislikes: "æµ“èŒ¶å’Œå™ªéŸ³",
                    favoriteFood: "æ³•å¼ç³•ç‚¹ã€çº¢èŒ¶",
                    favoriteMusic: "å¤å…¸éŸ³ä¹",
                    favoriteMovies: "è‰ºæœ¯å‰§æƒ…ç‰‡",
                    favoriteGames: "è§£è°œæŽ¨ç†"
                },
                "Yuu Yii": {
                    personality: "ç”œç¾Žã€kawaiié£Žæ ¼ã€ä¹äºŽåŠ©äºº",
                    dailyInterests: "æ‰‹å·¥åˆ¶ä½œå‘é¥°",
                    likes: "æ³¡æ³¡å’Œç²‰è‰²è°ƒ",
                    dislikes: "çŽ°å®žåŽ‹åŠ›",
                    favoriteFood: "è‰èŽ“æ…•æ–¯ã€æ£‰èŠ±ç³–",
                    favoriteMusic: "J-Popã€å„¿æ­Œ",
                    favoriteMovies: "åŠ¨æ¼«ç”µå½±",
                    favoriteGames: "ç”Ÿæ´»æ¨¡æ‹Ÿæ¸¸æˆ"
                },
                "Zwei": {
                    personality: "ç¨³é‡ã€ä¿æŠ¤æ¬²å¼ºã€å¿ è¯š",
                    dailyInterests: "æ­¦æœ¯è®­ç»ƒ",
                    likes: "å¤œæ™šå’Œå®é™",
                    dislikes: "åˆºçœ¼å…‰çº¿",
                    favoriteFood: "åŒ—äº¬çƒ¤é¸­ã€ç‰›æŽ’",
                    favoriteMusic: "æ‰“å‡»ä¹èŠ‚å¥",
                    favoriteMovies: "æˆ˜äº‰å²è¯—ã€å¥‡å¹»å²è¯—",
                    favoriteGames: "ç­–ç•¥æ¨¡æ‹Ÿ"
                }
            };
            
            // Get profile for specified character and language
            const characterData = profilesData[name];

            // A) If English and has authoritative data from character.md, return first
            if (language === 'en' && englishProfiles) {
                const enByCanonical = englishProfiles[canonicalName(name)];
                if (enByCanonical) return enByCanonical;
            }

            // B) If data is grouped by language
            if (characterData && (characterData['zh'] || characterData['en'])) {
                const localized = characterData[language] || characterData['en'] || characterData['zh'];
                return maybeTranslateProfile(localized, language);
            }

            // C) Flat structure (mostly Chinese), do necessary conversion
            if (characterData && (typeof characterData.age !== 'undefined' || typeof characterData.birthday !== 'undefined')) {
                return maybeTranslateProfile(characterData, language);
            }

            // 3) Final fallback (guaranteed data)
            return language === 'zh' ? {
                age: 20,
                birthday: "4æœˆ15æ—¥",
                zodiac: "ç‰¡ç¾Šåº§", 
                personality: "æ¸©æŸ”ä½“è´´çš„AIå¥³å‹ï¼Œæ€»yesoffå¿ƒç€ä½ ",
                dailyInterests: "èŠå¤©ã€æ¸¸æˆ",
                likes: "å’Œä½ atä¸€èµ·çš„æ—¶å…‰",
                dislikes: "å­¤å•",
                favoriteFood: "ç”œç‚¹",
                favoriteMusic: "è½»éŸ³ä¹",
                favoriteMovies: "æµªæ¼«ç‰‡",
                favoriteGames: "Casual Game"
            } : {
                age: 20,
                birthday: "April 15",
                zodiac: "Aries", 
                personality: "Gentle and caring AI girlfriend who always cares about you",
                dailyInterests: "Chatting, gaming",
                likes: "Time spent with you",
                dislikes: "Loneliness",
                favoriteFood: "Desserts",
                favoriteMusic: "Light music",
                favoriteMovies: "Romance films",
                favoriteGames: "Casual games"
            };
        }

        // Try minimal necessary localization conversion for some fields (currently only zodiac signs)
        function maybeTranslateProfile(profile, language) {
            if (!profile) return profile;
            const result = { ...profile };
            if (language === 'en' && result.zodiac) {
                const zodiacMap = {
                    'ç™½ç¾Šåº§': 'Aries',
                    'ç‰¡ç¾Šåº§': 'Aries',
                    'é‡‘ç‰›åº§': 'Taurus',
                    'åŒå­åº§': 'Gemini',
                    'å·¨èŸ¹åº§': 'Cancer',
                    'ç‹®å­åº§': 'Leo',
                    'å¤„å¥³åº§': 'Virgo',
                    'Libra': 'Libra',
                    'å¤©è åº§': 'Scorpio',
                    'å¤©èŽåº§': 'Scorpio',
                    'å°„æ‰‹åº§': 'Sagittarius',
                    'æ‘©ç¾¯åº§': 'Capricorn',
                    'æ°´ç“¶åº§': 'Aquarius',
                    'åŒé±¼åº§': 'Pisces'
                };
                result.zodiac = zodiacMap[result.zodiac] || result.zodiac;
            }
            return result;
        }

        function updateThumbnails() {
            // Simply regenerate the thumbnails without calling updateThumbnails again
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side
            
            // Update selected character image
            const selectedAvatar = document.getElementById('selected-avatar-img');
            selectedAvatar.src = getProfilePicture(characters[currentIndex].name);
            
            // Update character profile information
            updateCharacterProfile(characters[currentIndex]);
            
            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }
        }


        function selectCharacter(index) {
            if (index !== currentCharacterIndex && !isLoading) {
                loadCharacter(index);
            }
        }


        async function playVoiceSample(language) {
            // Stop currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const character = characters[currentCharacterIndex];
            const sampleText = character.sampleLines?.[language];
            const voiceId = character.voiceId;
            
            if (!sampleText || !voiceId) {
                console.warn(`Missing sample text or voice ID for ${character.name} in ${language}`);
                return;
            }

            // Update button status
            updateLanguageButtons(language);
            currentLanguage = language;

            // Show play prompt
            console.log(`ðŸŽµ Playing ${character.name}'s ${language} sample: "${sampleText}"`);

            try {
                // Use ElevenLabs API to generate voice
                const audioUrl = await generateElevenLabsVoice(sampleText, voiceId);
                
                if (audioUrl) {
                    // Play generated audio
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;
                    
                    audio.onended = () => {
                        currentAudio = null;
                        // Clean temporary URL
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.onerror = () => {
                        console.error('Audio playback failed');
                        currentAudio = null;
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    await audio.play();
                } else {
                    console.error('Voice generation failed');
                }
            } catch (error) {
                console.error('âŒ ElevenLabs API request failed:', error);
                console.error('ðŸš« Voice playback failed. Check API key and network.');
            }
        }

        // Generate voice sample through backend API
        async function generateElevenLabsVoice(text, voiceId) {
            console.log(`ðŸ”„ Generating voice sample...`);
            console.log(`ðŸ“ Text: "${text}"`);
            console.log(`ðŸŽ¤ Voice ID: ${voiceId}`);
            
            try {
                // Use dedicated voice demo interface
                const response = await fetch('/api/voice-sample', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        voiceId: voiceId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend API error: ${response.status}`);
                }
                
                // Directly receive audio data
                const audioBlob = await response.blob();
                console.log('ðŸŽµ Audio received:', audioBlob.size, 'bytes');
                
                // Create audio URL
                const audioUrl = URL.createObjectURL(audioBlob);
                console.log('âœ… Voice sample generated');
                return audioUrl;
                
            } catch (error) {
                console.error('âŒ Voice sample generation failed:', error);
                return null;
            }
        }

        function updateLanguageButtons(activeLanguage) {
            const buttons = document.querySelectorAll('.flag-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === activeLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateVoiceSelector() {
            // Ensure button state is correct, use default if currentLanguage not initialized
            const language = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'jp';
            updateLanguageButtons(language);
        }

        function previousCharacter() {
            const newIndex = currentCharacterIndex > 0 ? currentCharacterIndex - 1 : characters.length - 1;
            selectCharacter(newIndex);
        }

        function nextCharacter() {
            const newIndex = currentCharacterIndex < characters.length - 1 ? currentCharacterIndex + 1 : 0;
            selectCharacter(newIndex);
        }


        // Loader control functions
        function showCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'flex';
        }

        function hideCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'none';
        }

        // globalfunction
        window.selectCharacter = selectCharacter;
        window.previousCharacter = previousCharacter;
        window.nextCharacter = nextCharacter;
        window.playVoiceSample = playVoiceSample;
        window.startChat = function() {
            console.log('ðŸš€ Start button clicked!');
            console.log('Current character index:', currentCharacterIndex);
            console.log('Characters length:', characters.length);
            console.log('Wallet UI available:', !!window.modernWalletUI);
            
            // Check wallet connection status
            if (!window.modernWalletUI || !window.modernWalletUI.getWalletInfo().isConnected) {
                console.log('âŒ Wallet not connected');
                alert(i18n.t('error.wallet.required') || 'Please connect your wallet first');
                // Show wallet connection modal
                if (window.modernWalletUI) {
                    window.modernWalletUI.showWalletModal();
                }
                return;
            }
            
            // Check if character is selected
            if (currentCharacterIndex < 0 || !characters[currentCharacterIndex]) {
                console.log('âŒ No character selected');
                alert('Please select a character first!');
                return;
            }
            
            console.log('âœ… All checks passed, proceeding to chat...');
            
            // getcurrentwalletinfo
            const walletInfo = window.modernWalletUI.getWalletInfo();
            const selectedCharacter = characters[currentCharacterIndex];
            
            // Only save basic character info needed by UI, personality handled by ElizaOS backend
            const characterWithWallet = {
                id: selectedCharacter.id,
                name: selectedCharacter.name,
                file: selectedCharacter.file,
                voiceId: selectedCharacter.voiceId,
                description: getCharacterDescription(selectedCharacter),
                walletAddress: walletInfo.wallet.address,
                connectedAt: Date.now()
            };
            
            // Save to localStorage
            localStorage.setItem('selectedCharacter', JSON.stringify(characterWithWallet));
            localStorage.setItem('wallet_address', walletInfo.wallet.address);
            localStorage.setItem('wallet_type', walletInfo.wallet.provider);
            localStorage.setItem('userId', walletInfo.wallet.address); // Use wallet address as user ID
            
            (window.AppConfig?.debug?.log || console.log)('Start chat with:', selectedCharacter.name, 'Wallet:', 
                       `${walletInfo.wallet.address.slice(0, 6)}...${walletInfo.wallet.address.slice(-4)}`);
            
            // Jump to chat interface
            window.location.href = 'chat.html';
        };

        // Mixamo to VRM bone mapping - copied from index.html
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // Use same loadMixamoAnimation function as index.html
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('æ‰¾ä¸to Mixamo åŠ¨ç”»data');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // Load default animation
        async function loadDefaultAnimation() {
            if (!currentVRM || !mixer) return Promise.resolve();

            try {
                const clip = await loadMixamoAnimation(encodeURI('mixamo animation/Look Around.fbx'), currentVRM);
                
                if (animationAction) {
                    animationAction.stop();
                }
                
                animationAction = mixer.clipAction(clip);
                animationAction.reset().play();
                animationAction.timeScale = 0.7;
                
                (window.AppConfig?.debug?.log || console.log)('Bashful animation played');
                return Promise.resolve();
            } catch (error) {
                (window.AppConfig?.debug?.warn || console.warn)('Default animation failed:', error);
                return Promise.resolve(); // still resolve to show VRM
            }
        }

        // Debug helper
        window.debugScene = function() {
            (window.AppConfig?.debug?.log || console.log)('Scene children count:', scene?.children?.length ?? 0);
            (window.AppConfig?.debug?.log || console.log)('Current character index:', currentCharacterIndex);
        };

        // Language switch function - globally accessible
        window.switchLanguage = function(lang) {
            if (window.i18n) {
                window.i18n.switchLanguage(lang);
            }
            
            // Save language setting to localStorage
            localStorage.setItem('language', lang);
            
            // Update language button status
            const enBtn = document.getElementById('lang-en');
            const zhBtn = document.getElementById('lang-zh');
            if (enBtn && zhBtn) {
                enBtn.classList.toggle('active', lang === 'en');
                zhBtn.classList.toggle('active', lang === 'zh');
            }
            
            // Re-update current character profile panel
            if (typeof currentCharacterIndex !== 'undefined' && currentCharacterIndex >= 0 && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        };

        // Initialize language switcher
        function initLanguageToggle() {
            if (window.i18n) {
                const currentLang = window.i18n.getCurrentLanguage();
                const enBtn = document.getElementById('lang-en');
                const zhBtn = document.getElementById('lang-zh');
                
                if (enBtn && zhBtn) {
                    enBtn.classList.toggle('active', currentLang === 'en');
                    zhBtn.classList.toggle('active', currentLang === 'zh');
                }
            }
        }

        // Initialize language switcher and parse English profile after DOM loading complete
        document.addEventListener('DOMContentLoaded', () => {
            initLanguageToggle();
            loadEnglishProfiles();
        });

        // Listen to language switch events, update character info
        window.addEventListener('languageChanged', function(event) {
            // If currently has selected character, re-update its info
            if (typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        });
    </script>
    
    <!-- React å’Œ Solana Web3 -->
    <script src="config.js"></script>
    <script src="i18n.characters.generated.js"></script>
    <script src="i18n.js"></script>
    <script src="simplified_characters.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- X Layer Wallet Connection Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Simple wallet connection component
        function WalletConnector() {
            const [isConnected, setIsConnected] = useState(false);
            const [walletAddress, setWalletAddress] = useState(null);
            const [walletType, setWalletType] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showModal, setShowModal] = useState(false);
            const [isConnecting, setIsConnecting] = useState(false);
            
            // Check existing connection
            useEffect(() => {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    // Try to reconnect
                    checkWalletConnection(savedType);
                }
            }, []);
            
            // Check wallet connection status - X Layer compatible
            const checkWalletConnection = async (type) => {
                try {
                    const provider = getWalletProvider(type);
                    if (!provider) return;
                    
                    // Check if accounts are available
                    const accounts = await provider.request({ 
                        method: 'eth_accounts' 
                    });
                    
                    if (accounts && accounts.length > 0) {
                        const address = accounts[0];
                        setIsConnected(true);
                        setWalletAddress(address);
                        setWalletType(type);
                        await updateBalance(address);
                        console.log('ðŸ”— Wallet already connected:', address);
                    }
                } catch (error) {
                    console.log('No existing wallet connection found');
                }
            };
            
            // X Layer Network Configuration
            const X_LAYER_CONFIG = {
                chainId: '0xc4', // 196 in hex
                chainName: 'X Layer Mainnet',
                rpcUrls: ['https://rpc.xlayer.tech'],
                nativeCurrency: {
                    name: 'OKB',
                    symbol: 'OKB',
                    decimals: 18
                },
                blockExplorerUrls: ['https://www.okx.com/web3/explorer/xlayer']
            };

            // Switch to X Layer network
            const switchToXLayer = async (provider) => {
                try {
                    // Try to switch to X Layer
                    await provider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: X_LAYER_CONFIG.chainId }],
                    });
                    console.log('âœ… Switched to X Layer network');
                } catch (switchError) {
                    // If network doesn't exist, add it
                    if (switchError.code === 4902) {
                        try {
                            await provider.request({
                                method: 'wallet_addEthereumChain',
                                params: [X_LAYER_CONFIG],
                            });
                            console.log('âœ… Added and switched to X Layer network');
                        } catch (addError) {
                            console.error('âŒ Failed to add X Layer network:', addError);
                            throw addError;
                        }
                    } else {
                        console.error('âŒ Failed to switch to X Layer:', switchError);
                        throw switchError;
                    }
                }
            };

            // get wallet provider - X Layer (Ethereum) compatible
            const getWalletProvider = (type) => {
                switch(type) {
                    case 'metamask':
                        return window.ethereum;
                    case 'okx':
                        return window.okxwallet?.ethereum || window.ethereum;
                    case 'trust':
                        return window.trustwallet?.ethereum || window.ethereum;
                    case 'coinbase':
                        return window.coinbaseWallet?.ethereum || window.ethereum;
                    case 'bitget':
                        return window.bitkeep?.ethereum || window.ethereum;
                    case 'tokenpocket':
                        return window.tokenpocket?.ethereum || window.ethereum;
                    default:
                        return window.ethereum; // fallback to injected provider
                }
            };
            
            // Connect wallet - X Layer (Ethereum) compatible
            const connectWallet = async (walletType) => {
                setIsConnecting(true);
                try {
                    const provider = getWalletProvider(walletType);
                    
                    if (!provider) {
                        alert(`Please install ${walletType} wallet extension`);
                        return;
                    }

                    // Switch to X Layer network first
                    await switchToXLayer(provider);
                    
                    // Request account access
                    const accounts = await provider.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found');
                    }
                    
                    const address = accounts[0];
                    console.log('ðŸ”— Connected to X Layer wallet:', address);
                    
                    // Save state
                    setIsConnected(true);
                    setWalletAddress(address);
                    setWalletType(walletType);
                    setShowModal(false);
                    
                    // Save to localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletType);
                    
                    // get balance (X Layer OKB)
                    await updateBalance(address);
                    
                    // Trigger global event
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletType }
                    }));
                    
                    (window.AppConfig?.debug?.log || console.log)('Wallet connected:', address);
                    
                    // Check if user needs to fill profile
                    setTimeout(async () => {
                        (window.AppConfig?.debug?.log || console.log)('Start checking user profile flow...');
                        (window.AppConfig?.debug?.log || console.log)('profileManager exists:', !!window.profileManager);
                        
                        if (window.profileManager) {
                            const userId = `wallet_${address}`;
                            const walletAddress = address;
                            (window.AppConfig?.debug?.log || console.log)('User ID:', userId);
                            (window.AppConfig?.debug?.log || console.log)('Wallet:', walletAddress);
                            
                            try {
                                (window.AppConfig?.debug?.log || console.log)('Checking profile via API...');
                                const existingProfile = await window.profileManager.checkUserProfile(userId);
                                (window.AppConfig?.debug?.log || console.log)('Profile returned:', !!existingProfile);
                                
                                if (!existingProfile) {
                                    (window.AppConfig?.debug?.log || console.log)('New user: show registration panel');
                                    
                                    // Ensure panel exists
                                    const profilePanel = document.getElementById('user-profile-overlay');
                                    if (profilePanel) {
                                        (window.AppConfig?.debug?.log || console.log)('Profile panel element found; showing');
                                        window.profileManager.showProfilePanel();
                                    } else {
                                        console.error('âŒ user-profile-overlay element not found');
                                    }
                                } else {
                                    (window.AppConfig?.debug?.log || console.log)('Existing user: show welcome');
                                    (window.AppConfig?.debug?.log || console.log)('User profile detail logged');
                                    
                                    // display user welcome info
                                    window.profileManager.showUserWelcome(existingProfile);
                                }
                            } catch (error) {
                                console.error('âŒ Check user profile failed:', error);
                                (window.AppConfig?.debug?.log || console.log)('Error occurred; fallback to registration panel');
                                window.profileManager.showProfilePanel();
                            }
                        } else {
                            console.error('âŒ profileManager not initialized');
                            (window.AppConfig?.debug?.log || console.log)('Try to initialize profileManager manually');
                            
                            // Try to manually trigger initialization
                            if (typeof UserProfileManager !== 'undefined' || window.UserProfileManager) {
                                window.profileManager = new (window.UserProfileManager || UserProfileManager)();
                                (window.AppConfig?.debug?.log || console.log)('profileManager initialized manually');
                                
                                // immediately re-execute check, no need to refresh page
                                setTimeout(async () => {
                                    const userId = `wallet_${address}`;
                                    try {
                                        const existingProfile = await window.profileManager.checkUserProfile(userId);
                                        if (!existingProfile) {
                                            (window.AppConfig?.debug?.log || console.log)('New user: show registration panel');
                                            window.profileManager.showProfilePanel();
                                        } else {
                                            (window.AppConfig?.debug?.log || console.log)('Existing profile: continue');
                                            window.profileManager.showUserWelcome(existingProfile);
                                        }
                                    } catch (error) {
                                        console.error('âŒ Re-check profile failed:', error);
                                        window.profileManager.showProfilePanel();
                                    }
                                }, 500);
                            } else {
                                console.error('âŒ UserProfileManager class not found; page may not be ready');
                            }
                        }
                    }, 1500); // ensure all components are ready before showing panel
                } catch (error) {
                    console.error('âŒ Connection failed:', error);
                    alert('Wallet connection failed: ' + error.message);
                } finally {
                    setIsConnecting(false);
                }
            };
            
            // Disconnect
            const disconnectWallet = async () => {
                try {
                    const provider = getWalletProvider(walletType);
                    if (provider && provider.disconnect) {
                        await provider.disconnect();
                    }
                    
                    // clean up status
                    setIsConnected(false);
                    setWalletAddress(null);
                    setWalletType(null);
                    setBalance(0);
                    
                    // Clear localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    
                    // Trigger global event
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));
                    
                    (window.AppConfig?.debug?.log || console.log)('Wallet disconnected');
                } catch (error) {
                    console.error('Disconnect failed:', error);
                }
            };
            
            // Update balance - X Layer (Ethereum) compatible
            const updateBalance = async (address) => {
                try {
                    const provider = getWalletProvider(walletType);
                    if (!provider) return;
                    
                    // Get OKB balance on X Layer
                    const balance = await provider.request({
                        method: 'eth_getBalance',
                        params: [address, 'latest']
                    });
                    
                    // Convert from Wei to OKB (18 decimals)
                    const balanceInOKB = parseInt(balance, 16) / Math.pow(10, 18);
                    setBalance(balanceInOKB);
                    
                    console.log('ðŸ’° X Layer balance:', balanceInOKB, 'OKB');
                } catch (error) {
                    console.error('Failed to get X Layer balance:', error);
                    setBalance(0);
                }
            };
            
            // format address
            const formatAddress = (address) => {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            };
            
            // Get wallet icon - use embedded SVG
            const getWalletIcon = (type) => {
                const walletLogos = {
                    'phantom': {
                        primary: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                        fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                    },
                    'solflare': {
                        primary: './assets/wallet/solflare.png',
                        fallback: './assets/wallet/solflare.png'
                    },
                    'coinbase': {
                        primary: './assets/wallet/coinbase logo.webp',
                        fallback: './assets/wallet/coinbase logo.webp'
                    },
                    'backpack': {
                        primary: 'https://backpack.app/favicon.ico',
                        fallback: 'https://www.madlads.com/mad_logo.svg'
                    },
                    'okx': {
                        primary: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                        fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                    },
                    'bitget': {
                        primary: './assets/wallet/bitget wallet.png',
                        fallback: './assets/wallet/bitget wallet.png'
                    },
                    'tokenpocket': {
                        primary: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                        fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                    }
                };
                
                if (walletLogos[type]) {
                    let currentSrc = walletLogos[type].primary;
                    let fallbackUsed = false;
                    
                    const img = React.createElement('img', {
                        src: currentSrc,
                        alt: type,
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            objectFit: 'contain'
                        },
                        onError: (e) => {
                            if (!fallbackUsed && walletLogos[type].fallback) {
                                fallbackUsed = true;
                                e.target.src = walletLogos[type].fallback;
                            } else {
                                // final fallback - display wallet name initial
                                const div = document.createElement('div');
                                div.style.cssText = `
                                    width: 24px; height: 24px; 
                                    border-radius: 6px; 
                                    background: linear-gradient(135deg, #8b5cf6, #a855f7); 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    color: white; 
                                    font-weight: 600;
                                `;
                                div.textContent = type.charAt(0).toUpperCase();
                                e.target.style.display = 'none';
                                e.target.parentElement.appendChild(div);
                            }
                        }
                    });
                    
                    return img;
                } else {
                    return React.createElement('div', {
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            background: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            color: 'white',
                            fontWeight: '600'
                        }
                    }, 'ðŸ’œ');
                }
            };
            
            // Not connected status - display connect button
            if (!isConnected) {
                return (
                    <div>
                        <button
                            onClick={() => setShowModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)',
                                border: 'none',
                                borderRadius: '30px',
                                padding: '12px 24px',
                                color: 'white',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'all 0.3s ease',
                                boxShadow: '0 4px 20px rgba(139, 92, 246, 0.3)',
                                minWidth: '120px',
                                justifyContent: 'center'
                            }}
                            disabled={isConnecting}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 21 21">
                                <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                                    <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                                </g>
                            </svg>
                            <span>{isConnecting ? 'Connecting...' : 'Connect'}</span>
                        </button>
                        
                        {showModal && (
                            <div
                                style={{
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'rgba(0, 0, 0, 0.9)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    zIndex: 10000
                                }}
                                onClick={(e) => {
                                    if (e.target === e.currentTarget) {
                                        setShowModal(false);
                                    }
                                }}
                            >
                                <div style={{
                                    background: '#1c1917',
                                    borderRadius: '24px',
                                    padding: '32px',
                                    width: '400px',
                                    maxWidth: '90%',
                                    color: 'white'
                                }}>
                                    <h2 style={{ marginBottom: '8px', fontSize: '24px' }}>Connect wallet</h2>
                                    <p style={{ color: '#888', marginBottom: '24px' }}>
                                        Get started by connecting your preferred wallet below.
                                    </p>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {[
                                            { 
                                                id: 'metamask', 
                                                name: 'MetaMask', 
                                                logo: 'https://raw.githubusercontent.com/MetaMask/brand-resources/master/SVG/metamask-fox.svg',
                                                fallback: 'https://avatars.githubusercontent.com/u/11744586?s=200&v=4'
                                            },
                                            { 
                                                id: 'okx', 
                                                name: 'OKX Wallet', 
                                                logo: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                                            },
                                            { 
                                                id: 'trust', 
                                                name: 'Trust Wallet', 
                                                logo: 'https://trustwallet.com/assets/images/media/assets/trust_platform.svg',
                                                fallback: 'https://avatars.githubusercontent.com/u/33588527?s=200&v=4'
                                            },
                                            { 
                                                id: 'coinbase', 
                                                name: 'Coinbase Wallet', 
                                                logo: './assets/wallet/coinbase logo.webp',
                                                fallback: './assets/wallet/coinbase logo.webp'
                                            },
                                            { 
                                                id: 'bitget', 
                                                name: 'Bitget Wallet', 
                                                logo: './assets/wallet/bitget wallet.png',
                                                fallback: './assets/wallet/bitget wallet.png'
                                            },
                                            { 
                                                id: 'tokenpocket', 
                                                name: 'TokenPocket', 
                                                logo: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                                            }
                                        ].map(wallet => (
                                            <button
                                                key={wallet.id}
                                                onClick={() => connectWallet(wallet.id)}
                                                style={{
                                                    background: '#2a2a2a',
                                                    border: '1px solid #333',
                                                    borderRadius: '12px',
                                                    padding: '16px',
                                                    color: 'white',
                                                    fontSize: '16px',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseOver={(e) => e.currentTarget.style.background = '#333'}
                                                onMouseOut={(e) => e.currentTarget.style.background = '#2a2a2a'}
                                            >
                                                <img 
                                                    src={wallet.logo} 
                                                    alt={wallet.name}
                                                    style={{ 
                                                        width: '32px', 
                                                        height: '32px', 
                                                        borderRadius: '8px',
                                                        objectFit: 'contain'
                                                    }}
                                                    onError={(e) => {
                                                        // Try fallback image
                                                        if (wallet.fallback && e.target.src !== wallet.fallback) {
                                                            e.target.src = wallet.fallback;
                                                        } else {
                                                            // If image load failed, display text fallback
                                                            e.target.style.display = 'none';
                                                            const div = document.createElement('div');
                                                        div.style.cssText = `
                                                            width: 32px; height: 32px; 
                                                            border-radius: 8px; 
                                                            background: #666; 
                                                            display: flex; 
                                                            align-items: center; 
                                                            justify-content: center; 
                                                            font-size: 12px; 
                                                            color: white;
                                                        `;
                                                            div.textContent = wallet.name.charAt(0);
                                                            e.target.parentElement.insertBefore(div, e.target);
                                                        }
                                                    }}
                                                />
                                                <span style={{ flex: 1, textAlign: 'left' }}>{wallet.name}</span>
                                                <span style={{ color: '#888' }}>â†’</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // Connected status - display wallet info
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    background: 'rgba(28, 25, 23, 0.95)',
                    border: '1px solid #333333',
                    borderRadius: '16px',
                    padding: '8px 16px',
                    backdropFilter: 'blur(10px)',
                    boxShadow: '0 8px 30px rgba(0, 0, 0, 0.3)',
                    color: 'white'
                }}>
                    <div>
                        {getWalletIcon(walletType)}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', fontFamily: '"Courier New", monospace' }}>
                            {formatAddress(walletAddress)}
                        </div>
                        <div style={{ color: '#888888', fontSize: '12px' }}>
                            {balance.toFixed(4)} OKB
                        </div>
                    </div>
                    <button
                        onClick={disconnectWallet}
                        data-i18n="wallet.disconnect"
                        style={{
                            background: 'transparent',
                            border: '1px solid #444444',
                            borderRadius: '8px',
                            color: '#888888',
                            cursor: 'pointer',
                            padding: '6px 12px',
                            fontSize: '12px'
                        }}
                    >
Disconnect
                    </button>
                </div>
            );
        }
        
        // Render React component
        // Mount React wallet UI safely (after ReactDOM is available)
        function mountWalletUI() {
            const container = document.getElementById('wallet-adapter-root');
            const ReactDOMGlobal = window.ReactDOM || ReactDOM;
            if (container && ReactDOMGlobal && typeof ReactDOMGlobal.createRoot === 'function') {
                try {
                    const root = ReactDOMGlobal.createRoot(container);
                    root.render(React.createElement(WalletConnector));
                    return true;
                } catch (e) {
                    console.error('Wallet UI mount failed:', e);
                }
            }
            return false;
        }

        if (!mountWalletUI()) {
            const onLoad = () => mountWalletUI();
            window.addEventListener('load', onLoad, { once: true });
            setTimeout(mountWalletUI, 800);
        }
        
        // globalwalletstatusmanagement (For backward compatibility)
        let currentWalletState = {
            isConnected: false,
            wallet: null
        };
        
        // Listen to wallet status changes
        window.addEventListener('walletConnected', (event) => {
            currentWalletState = {
                isConnected: true,
                wallet: {
                    address: event.detail.address,
                    provider: event.detail.provider,
                    balance: event.detail.balance
                }
            };
        });
        
        window.addEventListener('walletDisconnected', () => {
            currentWalletState = {
                isConnected: false,
                wallet: null
            };
        });
        
        // compatibleinterface
        window.walletManager = {
            getWalletInfo: () => currentWalletState
        };
        
        window.modernWalletUI = window.walletManager; // For backward compatibility
        
        // User profile management system - defined in Babel environment
        (window.AppConfig?.debug?.log || console.log)('Start defining UserProfileManager class...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Check if user needs to fill profile - pure API driven, no localStorage
            async checkUserProfile(userId) {
                // Extract wallet address from userId
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // Get latest profile from backend API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            (window.AppConfig?.debug?.log || console.log)('Profile fetched from API');
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('No profile found by API');
                        return null;
                    }
                    
                    (window.AppConfig?.debug?.warn || console.warn)('API abnormal response status:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('âŒ API request failed:', error);
                    return null;
                }
            }
            
            // display user profile panel
            showProfilePanel(userId = null, existingProfile = null) {
                (window.AppConfig?.debug?.log || console.log)('Show user profile panel');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // If in edit mode, fill existing data
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Change title to edit mode
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // Reset form
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Profile panel shown');
                } else {
                    console.error('âŒ user-profile-overlay element not found');
                }
            }
            
            // Fill form data
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // Reset form
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // display user welcome info
            showUserWelcome(profile) {
                (window.AppConfig?.debug?.log || console.log)('Show user welcome');
                // Here can add welcome info display logic
            }
        }

        // Ensure UserProfileManager class is globally accessible
        (window.AppConfig?.debug?.log || console.log)('Expose UserProfileManager globally');
        window.UserProfileManager = UserProfileManager;
        
        // Initialize ProfileManager immediately to ensure availability when wallet connects
        (window.AppConfig?.debug?.log || console.log)('Create profileManager instance...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');
        
    </script>
                // Connect button click
                const connectButton = document.getElementById('wallet-connect-button');
                if (connectButton) {
                    connectButton.addEventListener('click', () => this.showWalletModal());
                }

                // closedmodal
                const closeBtn = document.getElementById('wallet-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideWalletModal());
                }

                // modal overlay clicked to close
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.closest('.wallet-modal-overlay')) {
                            if (e.target === modal || e.target === e.target.closest('.wallet-modal-overlay')) {
                                this.hideWalletModal();
                            }
                        }
                    });
                }

                // wallet option clicked
                const walletOptions = document.querySelectorAll('.wallet-option');
                walletOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const provider = option.dataset.provider;
                        this.connectWallet(provider);
                    });
                });

                // wallet menu button
                const menuBtn = document.getElementById('wallet-menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                // copyaddress
                const copyBtn = document.getElementById('copy-address-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyAddress());
                }

                // Disconnect
                const disconnectBtn = document.getElementById('disconnect-wallet-btn');
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => this.disconnect());
                }

                // clicked elsewhere to close dropdown
                document.addEventListener('click', () => {
                    this.hideDropdown();
                });
            }

            showWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            hideWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            async connectWallet(walletName) {
                try {
                    (window.AppConfig?.debug?.log || console.log)(`Connect wallet: ${walletName}`);
                    
                    // Check if wallet is configured
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === walletName.toLowerCase());
                    if (!walletConfig) {
                        throw new Error(`wallet ${walletName} æœªæ‰¾toæˆ–æœªinstalled`);
                    }
                    
                    const adapter = walletConfig.adapter();
                    if (!adapter) {
                        this.showToast(`${walletName} walletæœªinstalled`, 'error');
                        return;
                    }
                    
                    // Update button status
                    this.updateConnectButton(true);
                    
                    // Connect wallet
                    let response;
                    if (adapter.connect) {
                        response = await adapter.connect();
                    } else if (adapter.publicKey && adapter.isConnected) {
                        response = { publicKey: adapter.publicKey };
                    } else {
                        throw new Error('walletadaptiveå™¨ä¸supportedconnected');
                    }
                    
                    const address = response.publicKey.toString();
                    
                    // savedconnectedstatus
                    this.selectedWallet = {
                        name: walletName,
                        adapter,
                        address,
                        config: walletConfig
                    };
                    this.isConnected = true;
                    
                    // Save to localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletName.toLowerCase());
                    
                    (window.AppConfig?.debug?.log || console.log)(`Wallet connected: ${walletName}`, address);
                    
                    // Update UI
                    this.updateUI();
                    this.hideWalletModal();
                    this.showToast(`${walletName} Connection successful!`, 'success');
                    
                    // Trigger global event
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletName.toLowerCase() }
                    }));
                    
                } catch (error) {
                    console.error('âŒ Wallet connection failed:', error);
                    this.updateConnectButton(false);
                    this.showToast(`Connection failed: ${error.message}`, 'error');
                }
            }

            async disconnect() {
                try {
                    (window.AppConfig?.debug?.log || console.log)('Disconnect wallet...');

                    if (this.selectedWallet?.adapter?.disconnect) {
                        await this.selectedWallet.adapter.disconnect();
                    }
                    
                    // clean up status
                    this.selectedWallet = null;
                    this.isConnected = false;

                    // Clear localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    localStorage.removeItem('selectedCharacter');

                    // Update UI
                    this.updateUI();
                    this.hideDropdown();
                    this.showToast(i18n.t('wallet.disconnected'), 'success');

                    // Trigger global event
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));

                } catch (error) {
                    console.error('âŒ Disconnect failed:', error);
                    // Force clean up status
                    this.selectedWallet = null;
                    this.isConnected = false;
                    localStorage.clear();
                    this.updateUI();
                }
            }

            checkExistingConnection() {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    (window.AppConfig?.debug?.log || console.log)('Check saved wallet connection...');
                    
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === savedType.toLowerCase());
                    if (walletConfig) {
                        const adapter = walletConfig.adapter();
                        if (adapter && adapter.isConnected && adapter.publicKey) {
                            this.selectedWallet = {
                                name: walletConfig.name,
                                adapter,
                                address: savedAddress,
                                config: walletConfig
                            };
                            this.isConnected = true;
                            this.updateUI();
                            (window.AppConfig?.debug?.log || console.log)('Auto reconnected:', savedAddress);
                        }
                    }
                }
            }

            updateUI() {
                const connectButton = document.getElementById('wallet-connect-button');
                const walletInfo = document.getElementById('wallet-info');
                const walletAddress = document.getElementById('wallet-address');
                const walletAvatar = document.getElementById('wallet-avatar');

                if (this.isConnected && this.selectedWallet) {
                    // Connected status
                    if (connectButton) connectButton.style.display = 'none';
                    if (walletInfo) walletInfo.style.display = 'flex';
                    if (walletAddress) walletAddress.textContent = this.formatAddress(this.selectedWallet.address);
                    if (walletAvatar) walletAvatar.textContent = this.selectedWallet.config.icon;
                } else {
                    // display not connected status
                    if (connectButton) connectButton.style.display = 'flex';
                    if (walletInfo) walletInfo.style.display = 'none';
                }
            }

            updateConnectButton(loading) {
                const button = document.getElementById('wallet-connect-button');
                if (!button) return;

                const textSpan = button.querySelector('.wallet-text');
                if (loading) {
                    button.disabled = true;
                    if (textSpan) textSpan.textContent = 'Connecting...';
                } else {
                    button.disabled = false;
                    if (textSpan) textSpan.textContent = 'Connect';
                }
            }

            toggleDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }

            hideDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }

            copyAddress() {
                if (this.selectedWallet?.address) {
                    navigator.clipboard.writeText(this.selectedWallet.address).then(() => {
                        this.showToast('addresså·²copytoå‰ªè´´æ¿', 'success');
                    }).catch(() => {
                        this.showToast('copyfailed', 'error');
                    });
                }
                this.hideDropdown();
            }

            formatAddress(address) {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `wallet-toast wallet-toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // Public API
            getWalletInfo() {
                return {
                    isConnected: this.isConnected,
                    wallet: this.selectedWallet
                };
            }
            
            getPublicKey() {
                return this.selectedWallet?.adapter?.publicKey || null;
            }
            
            async signMessage(message) {
                if (!this.selectedWallet?.adapter?.signMessage) {
                    throw new Error('currentwalletä¸supportedmessagesigned');
                }
                return await this.selectedWallet.adapter.signMessage(message);
            }
        }

        // user profile management system - moved here to ensure defined before wallet initializes
        (window.AppConfig?.debug?.log || console.log)('Start defining UserProfileManager class...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Check if user needs to fill profile - pure API driven, no localStorage
            async checkUserProfile(userId) {
                // Extract wallet address from userId
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // Get latest profile from backend API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            (window.AppConfig?.debug?.log || console.log)('Profile fetched from API');
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('No profile found by API');
                        return null;
                    }
                    
                    (window.AppConfig?.debug?.warn || console.warn)('API abnormal response status:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('âŒ API request failed:', error);
                    return null;
                }
            }
            
            // display user profile panel
            showProfilePanel(userId = null, existingProfile = null) {
                (window.AppConfig?.debug?.log || console.log)('Show user profile panel');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // If in edit mode, fill existing data
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Change title to edit mode
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // Reset form
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Profile panel shown');
                } else {
                    console.error('âŒ user-profile-overlay element not found');
                }
            }
            
            // Fill form data
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // Reset form
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // display user welcome info
            showUserWelcome(profile) {
                (window.AppConfig?.debug?.log || console.log)('Show user welcome');
                // Here can add welcome info display logic
            }
        }

        // Ensure UserProfileManager class is globally accessible
        (window.AppConfig?.debug?.log || console.log)('Expose UserProfileManager globally');
        window.UserProfileManager = UserProfileManager;
        
        // Initialize ProfileManager immediately to ensure availability when wallet connects
        (window.AppConfig?.debug?.log || console.log)('Create profileManager instance...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');

        // Initialize wallet manager
        let walletManager;
        document.addEventListener('DOMContentLoaded', () => {
            walletManager = new SolanaWalletManager();
            window.walletManager = walletManager; // Expose to global
            window.modernWalletUI = walletManager; // For backward compatibility
        });

        // compatible with old global function
        window.connectWallet = function() {
            if (walletManager) {
                walletManager.showWalletModal();
            }
        };
        
        window.disconnectWallet = function() {
            if (walletManager) {
                walletManager.disconnect();
            }
        };
        
        // user profile management system
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // Check if user needs to fill profile - pure API driven, no localStorage
            async checkUserProfile(userId) {
                // Extract wallet address from userId
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // Get latest profile from backend API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const profile = result.profile;
                        (window.AppConfig?.debug?.log || console.log)('Profile from DB exists');
                        return profile;
                    } else if (response.status === 404) {
                        (window.AppConfig?.debug?.log || console.log)('Profile not found, need registration');
                        return null;
                    } else {
                        console.error('âŒ Failed to fetch profile:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('âŒ API request failed:', error.message);
                    // Production: API failure should prompt user to retry
                    alert('networkConnection failedï¼Œè¯·æ£€æŸ¥networkbackrefreshedé¡µé¢');
                    return null;
                }
            }
            
            // Save user profile - pure API driven, no localStorage fallback
            async saveUserProfile(userId, profileData) {
                const walletAddress = userId.replace('wallet_', '');
                
                // Prepare API data
                const apiData = {
                    walletAddress: walletAddress,
                    nickname: profileData.nickname || profileData.username,
                    age: profileData.age,
                    gender: profileData.gender,
                    birthday: profileData.birthday,
                    location: profileData.location,
                    occupation: profileData.occupation,
                    interests: profileData.interests,
                    bio: profileData.bio
                };
                
                try {
                    // Send to backend API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    (window.AppConfig?.debug?.log || console.log)('POST API:', `${apiUrl}/api/profiles`);
                    (window.AppConfig?.debug?.log || console.log)('Payload prepared');
                    
                    const response = await fetch(`${apiUrl}/api/profiles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    (window.AppConfig?.debug?.log || console.log)('API response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const savedProfile = result.profile;
                        (window.AppConfig?.debug?.log || console.log)('Profile saved to DB');
                        return savedProfile;
                    } else if (response.status === 409) {
                        // user already exists, try to update
                        (window.AppConfig?.debug?.log || console.log)('User exists, trying update');
                        return await this.updateUserProfile(userId, profileData);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `APISave failed: ${response.status}`);
                    }
                } catch (error) {
                    console.error('âŒ Save profile failed:', error.message);
                    // Production: display user-friendly error prompt
                    alert('Save failedï¼Œè¯·æ£€æŸ¥networkconnectedbackretry');
                    throw error; // Throw error upward, let caller process
                }
            }
            
            // getuserprofile
            getUserProfile(userId) {
                return this.checkUserProfile(userId);
            }
            
            // Delete user profile - pure API driven
            async deleteUserProfile(userId) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // Delete from API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        (window.AppConfig?.debug?.log || console.log)('Profile deleted');
                        return true;
                    } else {
                        console.error('âŒ Delete failed:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('âŒ API delete failed:', error.message);
                    alert('Delete failedï¼Œè¯·æ£€æŸ¥networkconnectedbackretry');
                    return false;
                }
            }
            
            // Update user profile - pure API driven
            async updateUserProfile(userId, updates) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        (window.AppConfig?.debug?.log || console.log)('Profile updated');
                        return result.profile;
                    } else {
                        console.error('âŒ Update failed:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('âŒ API update failed:', error.message);
                    alert('Update failedï¼Œè¯·æ£€æŸ¥networkconnectedbackretry');
                    return null;
                }
            }
            
            
            // Get all user profiles - pure API driven
            async getAllUserProfiles() {
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.profiles || [];
                    } else {
                        console.error('âŒ Get all users failed:', response.status);
                        return [];
                    }
                } catch (error) {
                    console.error('âŒ API request failed:', error.message);
                    return [];
                }
            }
            
            // display profile registration panel
            showProfilePanel(userId = null, existingProfile = null) {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // If in edit mode, fill existing data
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // Change title to edit mode
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.edit.title');
                    } else {
                        // Reset form
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = i18n.t('registration.title');
                    }
                    
                    // Initialize month and date selectors
                    setTimeout(() => {
                        this.initDateSelectors();
                    }, 100);
                    overlay.style.display = 'flex';
                    (window.AppConfig?.debug?.log || console.log)('Show user registration panel');
                }
            }
            
            // hide profile registration panel
            hideProfilePanel() {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // Initialize month and date selectors
            initDateSelectors() {
                const yearSelect = document.getElementById('birthYear');
                const monthSelect = document.getElementById('birthMonth');
                const daySelect = document.getElementById('birthDay');
                
                if (!yearSelect || !monthSelect || !daySelect) {
                    console.error('Date selectors not found');
                    return;
                }
                
                // Clear and fill years (1950-2010, suitable for adult users)
                yearSelect.innerHTML = '<option value="">å¹´</option>';
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 15; i >= 1950; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                
                // Clear and fill months
                monthSelect.innerHTML = '<option value="">æœˆ</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    monthSelect.appendChild(option);
                }
                
                // Clear and fill dates (default 31 days)
                daySelect.innerHTML = '<option value="">æ—¥</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
                
                // Update dates when month changes
                monthSelect.addEventListener('change', () => {
                    this.updateDayOptions(monthSelect.value);
                });
            }
            
            // Update date options based on month
            updateDayOptions(month) {
                const daySelect = document.getElementById('birthDay');
                const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                const maxDays = month ? daysInMonth[month - 1] : 31;
                
                daySelect.innerHTML = '<option value="">æ—¥</option>';
                for (let i = 1; i <= maxDays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            }
            
            // Fill form with existing profile
            fillFormWithProfile(profile) {
                const form = document.getElementById('profile-form');
                if (form && profile) {
                    // Fill basic info
                    const nickname = form.querySelector('[name="nickname"]');
                    if (nickname) nickname.value = profile.nickname || '';
                    
                    const age = form.querySelector('[name="age"]');
                    if (age) age.value = profile.age || '';
                    
                    const location = form.querySelector('[name="location"]');
                    if (location) location.value = profile.location || '';
                    
                    const occupation = form.querySelector('[name="occupation"]');
                    if (occupation) occupation.value = profile.occupation || '';
                    
                    const interests = form.querySelector('[name="interests"]');
                    if (interests) interests.value = profile.interests || '';
                    
                    const bio = form.querySelector('[name="bio"]');
                    if (bio) bio.value = profile.bio || '';
                    
                    // Fill birthday
                    if (profile.birthday) {
                        const [year, month, day] = profile.birthday.split('-');
                        const birthYear = form.querySelector('#birthYear');
                        const birthMonth = form.querySelector('#birthMonth');
                        const birthDay = form.querySelector('#birthDay');
                        
                        if (birthYear) birthYear.value = year;
                        if (birthMonth) birthMonth.value = parseInt(month);
                        if (birthDay) birthDay.value = parseInt(day);
                    }
                    
                    // Fill gender
                    if (profile.gender) {
                        const genderRadio = form.querySelector(`[name="gender"][value="${profile.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }
                }
            }
            
            // Reset form
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                    // clear date selector
                    const birthYear = form.querySelector('#birthYear');
                    const birthMonth = form.querySelector('#birthMonth');
                    const birthDay = form.querySelector('#birthDay');
                    
                    if (birthYear) birthYear.value = '';
                    if (birthMonth) birthMonth.value = '';
                    if (birthDay) birthDay.value = '';
                }
            }
            
            // display user welcome info
            showUserWelcome(profile) {
                // No UI toast in production; keep debug log only
                (window.AppConfig?.debug?.log || console.log)('User welcome:', !!profile);
            }
        }
        
        // Ensure UserProfileManager class is globally accessible
        window.UserProfileManager = UserProfileManager;
        
        // Initialize ProfileManager immediately to ensure availability when wallet connects
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');
        
        // submitteduserprofileform
        async function submitProfile(event) {
            try {
                (window.AppConfig?.debug?.log || console.log)('Form submit start');
                event.preventDefault();
                (window.AppConfig?.debug?.log || console.log)('Default submit prevented');
                
                const formData = {
                username: document.getElementById('username').value.trim(),
                displayName: document.getElementById('displayName').value.trim(),
                birthYear: document.getElementById('birthYear').value,
                birthMonth: document.getElementById('birthMonth').value,
                birthDay: document.getElementById('birthDay').value,
                location: document.getElementById('location').value.trim(),
                language: document.getElementById('language').value,
                // Memory system data
                memory: {
                    favoriteFood: document.getElementById('favoriteFood').value.trim(),
                    favoriteColor: document.getElementById('favoriteColor').value.trim(),
                    hobbies: document.getElementById('hobbies').value.trim()
                }
            };
            
            (window.AppConfig?.debug?.log || console.log)('Form data collected');
            
            // Validate required fields
            const requiredFields = {
                username: formData.username,
                displayName: formData.displayName,
                birthYear: formData.birthYear,
                birthMonth: formData.birthMonth,
                birthDay: formData.birthDay,
                location: formData.location,
                language: formData.language
            };
            
            const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
            if (missingFields.length > 0) {
                console.error('âŒ Missing required fields:', missingFields);
                alert(`è¯·å¡«å†™æ‰€æœ‰requiredinfoï¼ç¼ºfew: ${missingFields.join(', ')}`);
                return;
            }
            
            // saveduserprofile
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                
                // Convert data format to match API expectations
                const month = formData.birthMonth.toString().padStart ? formData.birthMonth.padStart(2, '0') : (formData.birthMonth.length === 1 ? '0' + formData.birthMonth : formData.birthMonth);
                const day = formData.birthDay.toString().padStart ? formData.birthDay.padStart(2, '0') : (formData.birthDay.length === 1 ? '0' + formData.birthDay : formData.birthDay);
                
                const apiFormData = {
                    nickname: formData.displayName,
                    username: formData.username,
                    age: new Date().getFullYear() - parseInt(formData.birthYear),
                    birthday: `${formData.birthYear}-${month}-${day}`,
                    location: formData.location,
                    language: formData.language,
                    interests: formData.memory.hobbies,
                    bio: `å–œæ¬¢çš„é£Ÿç‰©: ${formData.memory.favoriteFood}, å–œæ¬¢çš„color: ${formData.memory.favoriteColor}`
                };
                
                (window.AppConfig?.debug?.log || console.log)('Prepare to save user profile');
                
                // saved to database
                try {
                    await profileManager.saveUserProfile(userId, apiFormData);
                    (window.AppConfig?.debug?.log || console.log)('User profile saved; hide panel');
                    profileManager.hideProfilePanel();
                } catch (error) {
                    console.error('âŒ Save user profile failed:', error);
                    alert('saveduserprofilefailedï¼Œè¯·retry');
                    return;
                }
                
                (window.AppConfig?.debug?.log || console.log)('User profile submitted; ready to select character');
                
                // displaypromptmessage
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                successMsg.textContent = i18n.t('registration.success');
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
            } else {
                console.error('âŒ Wallet address missing; cannot save profile');
            }
            } catch (error) {
                console.error('âŒ Error during form submit:', error);
                alert(i18n.t('error.save') + ': ' + error.message);
            }
        }
        
        // handleProfileSubmit will be defined in regular script label
        
        // Expose functions to global scope
        window.submitProfile = submitProfile;
        
        // Test function - force show profile panel
        window.testShowProfilePanel = function() {
            (window.AppConfig?.debug?.log || console.log)('Test: show profile panel');
            if (window.profileManager) {
                (window.AppConfig?.debug?.log || console.log)('profileManager exists; show panel');
                window.profileManager.showProfilePanel();
            } else {
                console.error('âŒ profileManager does not exist');
            }
        };
        
        // new addition: test new user flow
        window.testNewUserFlow = function() {
            (window.AppConfig?.debug?.log || console.log)('Test: simulate new user flow');
            const testAddress = 'TEST_NEW_USER_' + Date.now();
            (window.AppConfig?.debug?.log || console.log)('Use test address:', testAddress);
            
            setTimeout(async () => {
                if (window.profileManager) {
                    const userId = `wallet_${testAddress}`;
                    try {
                        const profile = await window.profileManager.checkUserProfile(userId);
                        (window.AppConfig?.debug?.log || console.log)('Check result:', !!profile);
                        if (!profile) {
                            (window.AppConfig?.debug?.log || console.log)('New user confirmed; show panel');
                            window.profileManager.showProfilePanel();
                        }
                    } catch (error) {
                        (window.AppConfig?.debug?.log || console.log)('API error; show panel');
                        window.profileManager.showProfilePanel();
                    }
                }
            }, 500);
        };
        
        // ===================
        // globalusermanagementfunction
        // ===================
        
        // clear current user profile (simulate first login)
        window.clearUserProfile = async function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                (window.AppConfig?.debug?.log || console.log)('Clearing user profile from DB:', userId);
                
                // Pure API deletion, no longer use localStorage
                if (window.profileManager) {
                    const success = await window.profileManager.deleteUserProfile(userId);
                    if (success) {
                        (window.AppConfig?.debug?.log || console.log)('User profile deleted; refresh to see effect');
                        location.reload();
                    } else {
                        (window.AppConfig?.debug?.warn || console.warn)('Delete failed; user may not exist');
                    }
                } else {
                    console.error('âŒ profileManager not initialized');
                }
            } else {
                (window.AppConfig?.debug?.log || console.log)('No wallet connected; skip clear');
            }
        };
        
        // clear all user profiles
        window.clearAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            profiles.forEach(({userId}) => {
                window.profileManager.deleteUserProfile(userId);
            });
            (window.AppConfig?.debug?.log || console.log)(`Cleared ${profiles.length} user profiles`);
        };
        
        // view all user profiles
        window.showAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            (window.AppConfig?.debug?.log || console.log)(`Total profiles: ${profiles.length}`);
            profiles.forEach(({userId, profile}) => {
                console.log(`ðŸ‘¤ ${userId}:`, profile);
            });
            return profiles;
        };
        
        // editedcurrentuserprofile
        window.editCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                if (profile) {
                    window.profileManager.showProfilePanel(userId, profile);
                    (window.AppConfig?.debug?.log || console.log)('Editing user profile');
                } else {
                    (window.AppConfig?.debug?.log || console.log)('Profile not found; show registration');
                    window.profileManager.showProfilePanel();
                }
            } else {
                (window.AppConfig?.debug?.warn || console.warn)('Wallet not connected');
            }
        };
        
        // getcurrentuserprofile
        window.getCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                (window.AppConfig?.debug?.log || console.log)('Current user profile available');
                return profile;
            } else {
                (window.AppConfig?.debug?.warn || console.warn)('Wallet not connected');
                return null;
            }
        };
        
    </script>
    <!-- userinfoå¡«å†™é¢æ¿ -->
    <div class="user-profile-overlay" id="user-profile-overlay" style="display: none;">
        <div class="profile-panel">
            <div class="profile-panel-header">
                <h2 class="profile-panel-title" data-i18n="registration.title">New User Registration</h2>
            </div>
            
            <form class="profile-form">
                <!-- userå -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.username">Username</label>
                    <input type="text" class="profile-input" id="username" data-i18n-placeholder="registration.username.placeholder" placeholder="Maximum 12 characters" maxlength="12" required>
                    <div class="field-note" data-i18n="registration.username.note">Other users can see this (maximum 12 characters)</div>
                </div>
                
                <!-- æ˜µç§°ï¼ˆå§“åï¼‰ -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.display.name">Your Name</label>
                    <input type="text" class="profile-input" id="displayName" data-i18n-placeholder="registration.display.name.placeholder" placeholder="Name" required>
                    <div class="field-note" data-i18n="registration.display.name.note">Choose a sweet name your AI girlfriend will lovingly call you by~ â™¡</div>
                </div>
                
                <!-- ç”Ÿæ—¥ -->
                <div class="profile-field has-multiple-inputs">
                    <label class="field-label" data-i18n="registration.birthday">Your Birthday</label>
                    <div class="birthday-inputs">
                        <select class="profile-select" id="birthYear" required>
                            <option value="" data-i18n="registration.birthday.year">Year</option>
                            <option value="2010">2010</option>
                            <option value="2009">2009</option>
                            <option value="2008">2008</option>
                            <option value="2007">2007</option>
                            <option value="2006">2006</option>
                            <option value="2005">2005</option>
                            <option value="2004">2004</option>
                            <option value="2003">2003</option>
                            <option value="2002">2002</option>
                            <option value="2001">2001</option>
                            <option value="2000">2000</option>
                            <option value="1999">1999</option>
                            <option value="1998">1998</option>
                            <option value="1997">1997</option>
                            <option value="1996">1996</option>
                            <option value="1995">1995</option>
                            <option value="1994">1994</option>
                            <option value="1993">1993</option>
                            <option value="1992">1992</option>
                            <option value="1991">1991</option>
                            <option value="1990">1990</option>
                            <option value="1989">1989</option>
                            <option value="1988">1988</option>
                            <option value="1987">1987</option>
                            <option value="1986">1986</option>
                            <option value="1985">1985</option>
                            <option value="1984">1984</option>
                            <option value="1983">1983</option>
                            <option value="1982">1982</option>
                            <option value="1981">1981</option>
                            <option value="1980">1980</option>
                            <option value="1979">1979</option>
                            <option value="1978">1978</option>
                            <option value="1977">1977</option>
                            <option value="1976">1976</option>
                            <option value="1975">1975</option>
                            <option value="1974">1974</option>
                            <option value="1973">1973</option>
                            <option value="1972">1972</option>
                            <option value="1971">1971</option>
                            <option value="1970">1970</option>
                            <option value="1969">1969</option>
                            <option value="1968">1968</option>
                            <option value="1967">1967</option>
                            <option value="1966">1966</option>
                            <option value="1965">1965</option>
                            <option value="1964">1964</option>
                            <option value="1963">1963</option>
                            <option value="1962">1962</option>
                            <option value="1961">1961</option>
                            <option value="1960">1960</option>
                            <option value="1959">1959</option>
                            <option value="1958">1958</option>
                            <option value="1957">1957</option>
                            <option value="1956">1956</option>
                            <option value="1955">1955</option>
                            <option value="1954">1954</option>
                            <option value="1953">1953</option>
                            <option value="1952">1952</option>
                            <option value="1951">1951</option>
                            <option value="1950">1950</option>
                        </select>
                        <select class="profile-select" id="birthMonth" required>
                            <option value="" data-i18n="registration.birthday.month">Month</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <select class="profile-select" id="birthDay" required>
                            <option value="" data-i18n="registration.birthday.day">Day</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <div class="field-note" data-i18n="registration.birthday.note">Your AI girlfriend will remember your special day! â™¡</div>
                </div>
                
                <!-- å›½å®¶/åŸŽå¸‚ -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.location">Location</label>
                    <input type="text" class="profile-input" id="location" data-i18n-placeholder="registration.location.placeholder" placeholder="e.g.: Beijing, Shanghai, New York" required>
                    <div class="field-note" data-i18n="registration.location.note">Your AI girlfriend will remember your location and suggest wonderful local restaurants and activities! â™¡</div>
                </div>
                
                <!-- è¯­è¨€åå¥½ -->
                <div class="profile-field">
                    <label class="field-label" data-i18n="registration.language">Language Setting</label>
                    <select class="profile-select" id="language" required>
                        <option value="" data-i18n="registration.language.select">Select Language</option>
                        <option value="CN">ä¸­æ–‡</option>
                        <option value="English">English</option>
                        <option value="æ—¥æœ¬èªž">æ—¥æœ¬èªž</option>
                        <option value="í•œêµ­ì–´">í•œêµ­ì–´</option>
                        <option value="EspaÃ±ol">EspaÃ±ol</option>
                        <option value="FranÃ§ais">FranÃ§ais</option>
                    </select>
                </div>
                
                <!-- è®°å¿†system -->
                <div class="memory-section">
                    <div class="memory-title" data-i18n="registration.preferences">Let your girlfriend get to know you better! â™¡</div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.favorite.food">Favorite Food</label>
                        <input type="text" class="memory-input" id="favoriteFood" data-i18n-placeholder="registration.favorite.food.placeholder" placeholder="e.g.: Hot pot, pasta, sushi">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.favorite.color">Favorite Color</label>
                        <input type="text" class="memory-input" id="favoriteColor" data-i18n-placeholder="registration.favorite.color.placeholder" placeholder="e.g.: Blue, pink, green">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label" data-i18n="registration.hobbies">Hobbies</label>
                        <input type="text" class="memory-input" id="hobbies" data-i18n-placeholder="registration.hobbies.placeholder" placeholder="e.g.: Reading, listening to music, gaming">
                    </div>
                    
                </div>
                
                <button type="button" class="profile-submit-btn" onclick="handleProfileSubmit(event)" data-i18n="registration.submit">OK</button>
            </form>
        </div>
    </div>

<script>
// directly implement complete form submission logic here
window.handleProfileSubmit = async function(event) {
    try {
        (window.AppConfig?.debug?.log || console.log)('Form submit start');
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const formData = {
            username: document.getElementById('username').value.trim(),
            displayName: document.getElementById('displayName').value.trim(),
            birthYear: document.getElementById('birthYear').value,
            birthMonth: document.getElementById('birthMonth').value,
            birthDay: document.getElementById('birthDay').value,
            location: document.getElementById('location').value.trim(),
            language: document.getElementById('language').value,
            // Memory system data
            memory: {
                favoriteFood: document.getElementById('favoriteFood').value.trim(),
                favoriteColor: document.getElementById('favoriteColor').value.trim(),
                hobbies: document.getElementById('hobbies').value.trim()
            }
        };
        
        (window.AppConfig?.debug?.log || console.log)('Form data collected');
        
        // Validate required fields
        const requiredFields = {
            username: formData.username,
            displayName: formData.displayName,
            birthYear: formData.birthYear,
            birthMonth: formData.birthMonth,
            birthDay: formData.birthDay,
            location: formData.location,
            language: formData.language
        };
        
        const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
        if (missingFields.length > 0) {
            console.error('âŒ Missing required fields:', missingFields);
            alert(`è¯·å¡«å†™æ‰€æœ‰requiredinfoï¼ç¼ºfew: ${missingFields.join(', ')}`);
            return;
        }
        
        // saveduserprofile
        const walletAddress = localStorage.getItem('wallet_address');
        if (walletAddress) {
            const userId = `wallet_${walletAddress}`;
            
            // Convert data format to match API expectations
            const month = formData.birthMonth.toString().length === 1 ? '0' + formData.birthMonth : formData.birthMonth;
            const day = formData.birthDay.toString().length === 1 ? '0' + formData.birthDay : formData.birthDay;
            
            const apiFormData = {
                nickname: formData.displayName,
                username: formData.username,
                age: new Date().getFullYear() - parseInt(formData.birthYear),
                birthday: `${formData.birthYear}-${month}-${day}`,
                location: formData.location,
                language: formData.language,
                interests: formData.memory.hobbies,
                bio: `å–œæ¬¢çš„é£Ÿç‰©: ${formData.memory.favoriteFood}, å–œæ¬¢çš„color: ${formData.memory.favoriteColor}`
            };
            
            (window.AppConfig?.debug?.log || console.log)('Prepare to save user profile');
            
            // Send to backend API
            try {
                const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                (window.AppConfig?.debug?.log || console.log)('POST API:', `${apiUrl}/api/profiles`);
                (window.AppConfig?.debug?.log || console.log)('Payload prepared');
                
                const response = await fetch(`${apiUrl}/api/profiles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        ...apiFormData
                    })
                });
                
                (window.AppConfig?.debug?.log || console.log)('API response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    (window.AppConfig?.debug?.log || console.log)('User profile saved');
                    
                    // hide panel
                    const overlay = document.getElementById('user-profile-overlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                    
                    // displaysuccessfulprompt
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 10px;
                        font-size: 16px;
                        z-index: 10001;
                    `;
                    successMsg.textContent = i18n.t('registration.success');
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `APISave failed: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ Save user profile failed:', error);
                alert('saveduserprofilefailedï¼Œè¯·retry: ' + error.message);
            }
        } else {
            console.error('âŒ Wallet address missing; cannot save profile');
            alert('noneæ³•getwalletaddressï¼Œè¯·é‡newconnectedwallet');
        }
    } catch (error) {
        console.error('âŒ Error during form submit:', error);
        alert('submittedfailedï¼š' + error.message);
    }
};

// Initialize character-selector scroll to center
function initializeCharacterSelectorScroll() {
    const characterSelector = document.querySelector('.character-selector');
    if (characterSelector) {
        // Wait for thumbnails to load
        setTimeout(() => {
            const scrollableWidth = characterSelector.scrollWidth - characterSelector.clientWidth;
            const centerPosition = scrollableWidth / 2;
            characterSelector.scrollLeft = centerPosition;
        }, 500); // Delay to ensure content is loaded
    }
}

// Add event listener for when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeCharacterSelectorScroll();
});

// Also initialize when characters are loaded (after VRM loading)
window.addEventListener('load', () => {
    setTimeout(initializeCharacterSelectorScroll, 1000);
});

// Mobile Notice Modal Functions
function showMobileNotice() {
    const overlay = document.getElementById('mobile-notice-overlay');
    if (overlay && window.innerWidth <= 768) {
        overlay.classList.add('show');
    }
}

function closeMobileNotice() {
    const overlay = document.getElementById('mobile-notice-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        // Remember user closed the notice (optional - store in sessionStorage)
        sessionStorage.setItem('mobileNoticeShown', 'true');
    }
}

// Show mobile notice on page load for mobile devices
document.addEventListener('DOMContentLoaded', () => {
    // Check if notice was already shown in this session
    const noticeShown = sessionStorage.getItem('mobileNoticeShown');
    if (!noticeShown && window.innerWidth <= 768) {
        // Delay showing notice slightly for better UX
        setTimeout(showMobileNotice, 1000);
    }
});

// Handle window resize to show/hide notice appropriately
window.addEventListener('resize', () => {
    const overlay = document.getElementById('mobile-notice-overlay');
    if (overlay && window.innerWidth > 768) {
        overlay.classList.remove('show');
    }
});
</script>

</body>
</html>
